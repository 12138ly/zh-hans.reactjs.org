{"componentChunkName":"component---src-templates-blog-js","path":"/blog/2020/08/22/react-hooks-state-granularity.html","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>本文由百度资深研发工程师兼百度 ECOMFE FE-CMC 现任主席 — 张立理大佬授权转载。本系列文章对 Hook 进行了深度剖析。</p>\n</blockquote>\n<p>继续读基于 hook 的状态管理，毕竟状态无论什么时候都是 react 的重中之重。</p>\n<p>在有了 <code class=\"gatsby-code-text\">useState</code> 这东西之后，我们会发现状态被天生地“拆散”了，比如曾经有一个类组件：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TodoList</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n    state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        dataSource<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        isLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        filterText<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n        filterType<span class=\"token operator\">:</span> <span class=\"token string\">'all'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>放到 hook 上，大概率就是这样子的了：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">TodoList</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>dataSource<span class=\"token punctuation\">,</span> setDataSource<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isLoading<span class=\"token punctuation\">,</span> setLoading<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>filterText<span class=\"token punctuation\">,</span> filterByText<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>filterType<span class=\"token punctuation\">,</span> filterByType<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'all'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>老实说这算好的了，至少还搞了发起名的艺术，没有啥都叫 <code class=\"gatsby-code-text\">setFooBar</code>。</p>\n<p>上面的这个转换方式无疑是正确的，不过现实并不总这么友好，状态拆分的时候，容易出现粒度控制不好的情况。</p>\n<h2 id=\"粒度过细\"><a href=\"#%E7%B2%92%E5%BA%A6%E8%BF%87%E7%BB%86\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>粒度过细</h2>\n<p>如果按照标准的每一个状态对应一个 <code class=\"gatsby-code-text\">useState</code> 的做法，自然是逻辑上正确的，但它容易造成状态粒度过细的问题。</p>\n<p>讲一个故事：</p>\n<blockquote>\n<p>做一个表格，带一个选中功能，其中一个点是“按住 SHIFT 的同时点击一行可以选中一个区域”。</p>\n</blockquote>\n<p>为了实现这个功能，我们需要 2 套逻辑：</p>\n<ul>\n<li>当点击一行时，选中这一行。</li>\n<li>按 SHIFT 点击时，把上一次选中行 (或第一行) 到当前行都选中。</li>\n</ul>\n<p>从这个场景我们能分析出一个结论：点击一行的时候，除了选中它，还需要记录最后一次选中的行。为了简化这个模型，代码中我先不管“取消选择”的效果：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">SelectableList</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>selection<span class=\"token punctuation\">,</span> setSelection<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>lastSelected<span class=\"token punctuation\">,</span> setLastSelected<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> selectLine <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n        <span class=\"token parameter\">index</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setSelection</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">lines</span> <span class=\"token operator\">=></span> lines<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">setLastSelected</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>仔细看 <code class=\"gatsby-code-text\">useCallback</code> 中的部分，我们能看到它会连续调用 2 个状态的更新，这会造成什么情况呢？每一次状态更新都触发一次渲染，会导致多次渲染的浪费吗？</p>\n<p>答案是<strong>不好说</strong>，如果这件事发生在 React 管理的事件中，则更新会被合并起来，如果发生在其它场合 (比如异步结束时)，则会使得 React 触发多次渲染。为此我创建了一个 <a href=\"https://codesandbox.io/s/set-multiple-state-in-callback-6m6vd\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CodeSandbox 示例</a>来说明。</p>\n<p>所以我们今天要谈的不是一个性能问题，而是一个代码的组织和可读性问题。</p>\n<p>在 class 时代，我们会看到这样的代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SelectableList</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">selectLine</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">index</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            selection<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>selection<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            lastSelected<span class=\"token operator\">:</span> index\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们并不会把这代码写成：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SelectableList</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">selectLine</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">index</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>selection<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>selection<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>lastSelected<span class=\"token operator\">:</span> index<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>不否认 <strong>class 时代状态的集中管理是过于粗放的</strong>，但那个时代的状态更新粒度基本是没有问题的，所以在使用 hook 的时候千万不要太过暴力的拆分状态。<strong>过于细粒度的拆分状态会导致代码阅读者难以理解状态间的关系，无形提升代码维护的难度</strong>。</p>\n<h2 id=\"使用-reducer-管理状态更新\"><a href=\"#%E4%BD%BF%E7%94%A8-reducer-%E7%AE%A1%E7%90%86%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用 reducer 管理状态更新</h2>\n<p>现在搞清楚了状态粒度太细是不好的，所以不妨将上面示例的状态重新再合并回来：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">DEFAULT_SELECTION_STATE</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    selection<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    lastSelected<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">SelectableList</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>selectionState<span class=\"token punctuation\">,</span> setSelectionState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DEFAULT_SELECTION_STATE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> selectLine <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n        <span class=\"token parameter\">index</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">updater</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span>selection<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n                    selection<span class=\"token operator\">:</span> selection<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    lastSelected<span class=\"token operator\">:</span> index<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">setSelectionState</span><span class=\"token punctuation\">(</span>updater<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>没什么难度，确实没什么难度。</p>\n<p>但这种做法，依然会有一个问题：<strong>状态的更新与状态的声明距离过远</strong>。在这个示例中很难看出问题，因为总共也就 20 行，状态声明后立刻有 <code class=\"gatsby-code-text\">useCallback</code> 的调用说明怎么更新它。但在现实中，我们很容易面对 300 + 行的组件，面对状态的声明在第 1 行，状态的更新在第 40 行，甚至在最终 JSX 中的某个 <code class=\"gatsby-code-text\">onClick</code> 里的一个箭头函数中。</p>\n<p>在这样的代码里，阅读者想搞清楚一个状态被如何使用、如何更新是非常困难的，这不仅降低代码的可维护性，还给代码的学习者很大的挫败感，久而久之的影响就是<strong>谁也不愿意接手这代码</strong>。</p>\n<p>解决这个问题通常有 2 种方法：</p>\n<ol>\n<li>把状态和更新封装到自定义的 hook 中，比如就叫 <code class=\"gatsby-code-text\">useSelection</code>。</li>\n<li>使用 <code class=\"gatsby-code-text\">useReducer</code> 来实现。</li>\n</ol>\n<p>第一种方法自不必说，能不能找到合适的粒度来实现自定义 hook 就是对 react 开发者的素质的考验。但不少时候自定义 hook 作为一种解决方案还是过于重量级，虽然它仅仅是一个函数，但依然会需要阅读者去理解输入输出，使用 TypeScript 还可能造成类型定义上的额外工作。</p>\n<p>使用 <code class=\"gatsby-code-text\">useReducer</code> 可以在不少轻量级的场景里快速地将状态声明和状态更新放在一起，比如上面的例子：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">SelectableList</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>selectionState<span class=\"token punctuation\">,</span> dispatchSelectionState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">case</span> <span class=\"token string\">'select'</span><span class=\"token operator\">:</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n                        selection<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>selection<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        lastSelected<span class=\"token operator\">:</span> action<span class=\"token punctuation\">.</span>payload<span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n                    <span class=\"token keyword\">return</span> state<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>selection<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> lastSelected<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>可以看到的是，通过 <code class=\"gatsby-code-text\">useReducer</code> 我们传递一个函数，这个函数清晰地表达了 <code class=\"gatsby-code-text\">&#39;select&#39;</code> 这个类型的操作，以及对应的状态更新。<code class=\"gatsby-code-text\">useReducer</code> 的第二个参数也很好地说明了状态的结构。</p>\n<p>当然如果使用本系列前一篇中讲述的 <code class=\"gatsby-code-text\">useImmer</code> 或 <code class=\"gatsby-code-text\">useMethods</code> 会更容易实现：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">SelectableList</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>selectionState<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>select<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMethods</span><span class=\"token punctuation\">(</span>\n        methods<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>selection<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> lastSelected<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"状态过粗\"><a href=\"#%E7%8A%B6%E6%80%81%E8%BF%87%E7%B2%97\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>状态过粗</h2>\n<p>反过来说，状态也可能太粗，比如我们硬是将整个 class 的状态移到一个 <code class=\"gatsby-code-text\">useState</code> 里：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">DEFAULT_STATE</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    dataSource<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    isLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    filterText<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    filterType<span class=\"token operator\">:</span> <span class=\"token string\">'all'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">TodoList</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DEFAULT_STATE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>我个人是不太能想象谁会去写这样的代码的，也许背了一个“把 class 全部变成 hook”的 KPI 的可怜孩子会玩这一套……</p>\n<p>不过在此依然需要提一下状态过粗的代价，试想这样的组件：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n    state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        isBaseLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        isDetailLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        baseInfo<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n        detailInfo<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n        isDetailVisible<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">async</span> <span class=\"token function-variable function\">showDetail</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>detailInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>isDetailVisible<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>isDetailLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> detail <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchDetail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                isDetailLoading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                detailInfo<span class=\"token operator\">:</span> detail<span class=\"token punctuation\">,</span>\n                isDetailVisible<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后我们还有一个这样的组件：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"gatsby-code-jsx\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TodoList</span> <span class=\"token punctuation\">{</span>\n    state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        filterText<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n        filterType<span class=\"token operator\">:</span> <span class=\"token string\">'all'</span><span class=\"token punctuation\">,</span>\n        showFilterPanel<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function-variable function\">toggleFilterPanel</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setStae</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>showFilterPanel<span class=\"token operator\">:</span> <span class=\"token operator\">!</span>s<span class=\"token punctuation\">.</span>showFilterPanel<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这有什么问题呢？仔细去看 2 个组件，我们会发现它们其实是有共同的部分的：</p>\n<ol>\n<li>有一个能展开/收起的状态，一个叫 <code class=\"gatsby-code-text\">isDetailVisible</code> 一个叫 <code class=\"gatsby-code-text\">showFilterPanel</code>。</li>\n<li>有多个和异步过程有关的状态，比如 <code class=\"gatsby-code-text\">isBaseLoading</code> 和 <code class=\"gatsby-code-text\">isDetailLoading</code>。</li>\n<li>有异步状态与结果的成对出现，比如 <code class=\"gatsby-code-text\">isBaseLoading</code> 配对 <code class=\"gatsby-code-text\">baseInfo</code>，<code class=\"gatsby-code-text\">isDetailLoading</code> 配对 <code class=\"gatsby-code-text\">detailInfo</code>。</li>\n</ol>\n<p>但能得到这些结论，很大程度上归功于我给的代码过于精简，以及给了阅读者明确的“去发现”的目的。</p>\n<p>试想你有一个超过 10 万行代码的项目，里面有 800 多个组件，有些组件有 1200 多行，你作为一个技术负责人空降到项目中，有信心去发现这些东西吗？反正我作为一个所谓的高 T，很实诚地说我做不到。</p>\n<p>所以状态粒度过粗的问题就在于，它会隐藏掉可以复用的状态，让人不知不觉通过“行云流水地重复编码”来实现功能，离复用和精简越来越远。</p>\n<p>当然，有时候保持一定程度上的重复是有意义的，比如使代码更具语义化，让人更看得懂代码在干啥，这在 class 时代特别明显。在 class 明代能解决这一问题的办法就是 HOC，比如我们做 <code class=\"gatsby-code-text\">withLoading</code>、<code class=\"gatsby-code-text\">withToggle</code>、<code class=\"gatsby-code-text\">withRemoteData</code> 等等……</p>\n<p>然后就会变成这样：</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/24e3764b9fb11a47e18be65f8426db93/394f7/1_yJyHd9CKkqgToX7DtI6fcg.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 707px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 36.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABFUlEQVQY02WOy07DMBBF8///wEOsqKCCHQilgIT4BbZAS+vEzmM89jh24gcOSBWlV2cxizl3pnh9w8sVuy7Z8qm6ysOqytw814uyWj6y25fdYvV5cfd+er89eRBnJT8vxZ4ipeSdJS5pB8RAVz2xljiYmilRK1EpvkVRE3QD4jhO6U8KH2KMyVkHQpI0jsggDGYYSA/YaRqNJq3ITSGGkJdDTHuKMMsx11hnFTTAWc2NFLwVUgGiqNpOS6mcHUII6TC/8lzTdMjrpuHZJtFAJVC0AD2idqitcd6O4R+znDtIGf7RNJteCq0hv+zc6Ecfpph8TFNIo4/HzLIG3a872PSw6fLQr1v46pBJarXFwbsp/hw4zjeiDIisW3PYQAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"1 yJyHd9CKkqgToX7DtI6fcg\"\n        title=\"\"\n        src=\"/static/24e3764b9fb11a47e18be65f8426db93/394f7/1_yJyHd9CKkqgToX7DtI6fcg.png\"\n        srcset=\"/static/24e3764b9fb11a47e18be65f8426db93/65ed1/1_yJyHd9CKkqgToX7DtI6fcg.png 210w,\n/static/24e3764b9fb11a47e18be65f8426db93/d10fb/1_yJyHd9CKkqgToX7DtI6fcg.png 420w,\n/static/24e3764b9fb11a47e18be65f8426db93/394f7/1_yJyHd9CKkqgToX7DtI6fcg.png 707w\"\n        sizes=\"(max-width: 707px) 100vw, 707px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>好在 hook 能比较合理地去解决这种嵌套问题。</p>\n<h2 id=\"合理设计粒度\"><a href=\"#%E5%90%88%E7%90%86%E8%AE%BE%E8%AE%A1%E7%B2%92%E5%BA%A6\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>合理设计粒度</h2>\n<p>本章讲了 2 个主要的论述：状态粒度太细不好，粒度太粗也不好。</p>\n<p>在实际的业务里，比这复杂的多的事情天天在发生，远不是太细了合一合、太粗了分一分这么简单，大部分时候我们面对的是这样的情况：</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a2a4a2c5d0d50a193a6c70afa4878f7f/daed9/Jietu20200222-133557%402x.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 80.47619047619048%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACpElEQVQ4y22US3LTQBCGfQEW3IADcAWKLbsUJ8mKKm7BgmJHsQGyhAVFsmABpFgEXCEhwY6thxXLtuyxZMl6v2b005IsE8XpKs9Yqp6v++/uUacoCpTW7KlIMQ2vMfJlaIGMcaAizIONj7jxK3D7bGmdmy/MhGHg/oWdrhDxEBGBvMyF7PUxjSb1Yfy3u6Cd5s8qMeng1daZC7RMt8+xWH4DomuIYIgiWbTAzV5lyAsOyettIpZvxCaXolpFMqPVwggknwKDyiKiMYTfb8G2QDdzqFajJje8lgrs/xQkmR5zGzmVIXv5AvqL5zCEtZVepBZlO2hLLpdZpGOd2tv67JGyzlvA4WWXJIJGiB49hPH4ARawNwBeQ0MVRbZuS2aRASunyDlJNXXMhgqG5xJyhaKz39C9FIOzIbqnXRxPRjB9vikLrfGM6snawEBEGJl/gIs+wo+/AGlRSedRiN73Q0wpQGmTlGES6JiuM1wxr4Ykt4B1DwqMLj4jMOZw997BfXNSOQyWCZYOdf66D6wD/HC+YF9+gq/uASziaQRGMoKgHrSBloXY0NCn4jvdUmaMmFRpVtkVHwk7IeYxlETBM/UpDlcHFeByQp0OpN2m5JpMkVJkyCHnCqa5BsU2cMFmYNyFtO7CP/9ADXI2gxCR/xjj2SWcKNsdG65rFKmuSVnrhPvor3R0DQn+5BWEeYRC6ZGPChEq4CGNWMagrmIEKd8FFp4LrtWFLzhHM2jSjObs+B7iT/eRG/VYCVFL47T1Fv7uXW4euCpBWGaTZGXTMIM0OAJO35ek1lW8Yj5WYbZzp7fA8s5xdVjLNxn4kkaHGZieyRhOQsyDHHM3huEmVWZzL9m5xztfmyo7x4ZgcwgCcpNV8xjkHMY6riAlMM7FnbDS/gFmSsPuOExcQQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Jietu20200222 133557 2x\"\n        title=\"\"\n        src=\"/static/a2a4a2c5d0d50a193a6c70afa4878f7f/1e088/Jietu20200222-133557%402x.png\"\n        srcset=\"/static/a2a4a2c5d0d50a193a6c70afa4878f7f/65ed1/Jietu20200222-133557%402x.png 210w,\n/static/a2a4a2c5d0d50a193a6c70afa4878f7f/d10fb/Jietu20200222-133557%402x.png 420w,\n/static/a2a4a2c5d0d50a193a6c70afa4878f7f/1e088/Jietu20200222-133557%402x.png 840w,\n/static/a2a4a2c5d0d50a193a6c70afa4878f7f/78612/Jietu20200222-133557%402x.png 1260w,\n/static/a2a4a2c5d0d50a193a6c70afa4878f7f/daed9/Jietu20200222-133557%402x.png 1426w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>5 个状态 4 个组合操作，怎么设计粒度更合理，就慢慢折腾去吧。</p>","excerpt":"本文由百度资深研发工程师兼百度 ECOMFE FE-CMC 现任主席 — 张立理大佬授权转载。本系列文章对 Hook 进行了深度剖析。 继续读基于 hook 的状态管理，毕竟状态无论什么时候都是 react 的重中之重。 在有了  这东西之后，我们会发现状态被天生地“拆散”了，比如曾经有一个类组件： 放到 hook 上，大概率就是这样子的了： 老实说这算好的了，至少还搞了发起名的艺术，没有啥都叫 。 上面的这个转换方式无疑是正确的，不过现实并不总这么友好，状态拆分的时候，容易出现粒度控制不好的情况。 粒度过细 如果按照标准的每一个状态对应一个  的做法，自然是逻辑上正确的，但它容易造成状态粒度过细的问题。 讲一个故事： 做一个表格，带一个选中功能，其中一个点是“按住 SHIFT 的同时点击一行可以选中一个区域”。 为了实现这个功能，我们需要 2 套逻辑： 当点击一行时，选中这一行。 按 SHIFT…","frontmatter":{"title":"React Hooks 的体系设计之二 - 状态粒度","next":null,"prev":null,"author":[]},"fields":{"date":"August 22, 2020","path":"content/blog/2020-08-22-react-hooks-state-granularity.md","slug":"/blog/2020/08/22/react-hooks-state-granularity.html"}},"allMarkdownRemark":{"edges":[{"node":{"frontmatter":{"title":"React Hooks 的体系设计之二 - 状态粒度"},"fields":{"slug":"/blog/2020/08/22/react-hooks-state-granularity.html"}}},{"node":{"frontmatter":{"title":"React Hooks 的体系设计之一 - 分层"},"fields":{"slug":"/blog/2020/08/21/react-hooks-extra-level-of-indirection.html"}}},{"node":{"frontmatter":{"title":"React v17.0 RC 版本发布：没有新特性"},"fields":{"slug":"/blog/2020/08/10/react-v17-rc.html"}}},{"node":{"frontmatter":{"title":"React Hook 最佳实践"},"fields":{"slug":"/blog/2020/05/22/react-hooks.html"}}},{"node":{"frontmatter":{"title":"React v16.13.0"},"fields":{"slug":"/blog/2020/02/26/react-v16.13.0.html"}}},{"node":{"frontmatter":{"title":"Building Great User Experiences with Concurrent Mode and Suspense"},"fields":{"slug":"/blog/2019/11/06/building-great-user-experiences-with-concurrent-mode-and-suspense.html"}}},{"node":{"frontmatter":{"title":"使用 React 预发布版为新功能打基础"},"fields":{"slug":"/blog/2019/10/22/react-release-channels.html"}}},{"node":{"frontmatter":{"title":"全新的 React DevTools 简介"},"fields":{"slug":"/blog/2019/08/15/new-react-devtools.html"}}},{"node":{"frontmatter":{"title":"React v16.9.0 发布及 Roadmap 最新进展"},"fields":{"slug":"/blog/2019/08/08/react-v16.9.0.html"}}},{"node":{"frontmatter":{"title":"Is React Translated Yet? ¡Sí! Sim! はい！"},"fields":{"slug":"/blog/2019/02/23/is-react-translated-yet.html"}}}]}},"pageContext":{"slug":"/blog/2020/08/22/react-hooks-state-granularity.html"}},"staticQueryHashes":[]}
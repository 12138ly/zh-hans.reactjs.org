<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[React]]></title><description><![CDATA[用于构建用户界面的 JavaScript 库]]></description><link>https://zh-hans.reactjs.org</link><generator>GatsbyJS</generator><lastBuildDate>Mon, 07 Sep 2020 17:01:24 GMT</lastBuildDate><item><title><![CDATA[React Hooks 的体系设计之二 - 状态粒度]]></title><description><![CDATA[<blockquote>
<p>本文由百度资深研发工程师兼百度 ECOMFE FE-CMC 现任主席 — 张立理大佬授权转载。本系列文章对 Hook 进行了深度剖析。</p>
</blockquote>
<p>继续读基于 hook 的状态管理，毕竟状态无论什么时候都是 react 的重中之重。</p>
<p>在有了 <code class="gatsby-code-text">useState</code> 这东西之后，我们会发现状态被天生地“拆散”了，比如曾经有一个类组件：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">TodoList</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span>
        dataSource<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        isLoading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        filterText<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        filterType<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>放到 hook 上，大概率就是这样子的了：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">TodoList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>dataSource<span class="token punctuation">,</span> setDataSource<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoading<span class="token punctuation">,</span> setLoading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>filterText<span class="token punctuation">,</span> filterByText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>filterType<span class="token punctuation">,</span> filterByType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'all'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>老实说这算好的了，至少还搞了发起名的艺术，没有啥都叫 <code class="gatsby-code-text">setFooBar</code>。</p>
<p>上面的这个转换方式无疑是正确的，不过现实并不总这么友好，状态拆分的时候，容易出现粒度控制不好的情况。</p>
<h2 id="粒度过细"><a href="#%E7%B2%92%E5%BA%A6%E8%BF%87%E7%BB%86" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>粒度过细</h2>
<p>如果按照标准的每一个状态对应一个 <code class="gatsby-code-text">useState</code> 的做法，自然是逻辑上正确的，但它容易造成状态粒度过细的问题。</p>
<p>讲一个故事：</p>
<blockquote>
<p>做一个表格，带一个选中功能，其中一个点是“按住 SHIFT 的同时点击一行可以选中一个区域”。</p>
</blockquote>
<p>为了实现这个功能，我们需要 2 套逻辑：</p>
<ul>
<li>当点击一行时，选中这一行。</li>
<li>按 SHIFT 点击时，把上一次选中行 (或第一行) 到当前行都选中。</li>
</ul>
<p>从这个场景我们能分析出一个结论：点击一行的时候，除了选中它，还需要记录最后一次选中的行。为了简化这个模型，代码中我先不管“取消选择”的效果：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">SelectableList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>selection<span class="token punctuation">,</span> setSelection<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>lastSelected<span class="token punctuation">,</span> setLastSelected<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> selectLine <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
        <span class="token parameter">index</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">setSelection</span><span class="token punctuation">(</span><span class="token parameter">lines</span> <span class="token operator">=></span> lines<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setLastSelected</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>仔细看 <code class="gatsby-code-text">useCallback</code> 中的部分，我们能看到它会连续调用 2 个状态的更新，这会造成什么情况呢？每一次状态更新都触发一次渲染，会导致多次渲染的浪费吗？</p>
<p>答案是<strong>不好说</strong>，如果这件事发生在 React 管理的事件中，则更新会被合并起来，如果发生在其它场合 (比如异步结束时)，则会使得 React 触发多次渲染。为此我创建了一个 <a href="https://codesandbox.io/s/set-multiple-state-in-callback-6m6vd" target="_blank" rel="nofollow noopener noreferrer">CodeSandbox 示例</a>来说明。</p>
<p>所以我们今天要谈的不是一个性能问题，而是一个代码的组织和可读性问题。</p>
<p>在 class 时代，我们会看到这样的代码：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">SelectableList</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">selectLine</span> <span class="token operator">=</span> <span class="token parameter">index</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
            selection<span class="token operator">:</span> state<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
            lastSelected<span class="token operator">:</span> index
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>我们并不会把这代码写成：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">SelectableList</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">selectLine</span> <span class="token operator">=</span> <span class="token parameter">index</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>selection<span class="token operator">:</span> state<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>lastSelected<span class="token operator">:</span> index<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>不否认 <strong>class 时代状态的集中管理是过于粗放的</strong>，但那个时代的状态更新粒度基本是没有问题的，所以在使用 hook 的时候千万不要太过暴力的拆分状态。<strong>过于细粒度的拆分状态会导致代码阅读者难以理解状态间的关系，无形提升代码维护的难度</strong>。</p>
<h2 id="使用-reducer-管理状态更新"><a href="#%E4%BD%BF%E7%94%A8-reducer-%E7%AE%A1%E7%90%86%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 reducer 管理状态更新</h2>
<p>现在搞清楚了状态粒度太细是不好的，所以不妨将上面示例的状态重新再合并回来：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token constant">DEFAULT_SELECTION_STATE</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    selection<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    lastSelected<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">SelectableList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>selectionState<span class="token punctuation">,</span> setSelectionState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_SELECTION_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> selectLine <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
        <span class="token parameter">index</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token function-variable function">updater</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>selection<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    selection<span class="token operator">:</span> selection<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    lastSelected<span class="token operator">:</span> index<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">setSelectionState</span><span class="token punctuation">(</span>updater<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>没什么难度，确实没什么难度。</p>
<p>但这种做法，依然会有一个问题：<strong>状态的更新与状态的声明距离过远</strong>。在这个示例中很难看出问题，因为总共也就 20 行，状态声明后立刻有 <code class="gatsby-code-text">useCallback</code> 的调用说明怎么更新它。但在现实中，我们很容易面对 300 + 行的组件，面对状态的声明在第 1 行，状态的更新在第 40 行，甚至在最终 JSX 中的某个 <code class="gatsby-code-text">onClick</code> 里的一个箭头函数中。</p>
<p>在这样的代码里，阅读者想搞清楚一个状态被如何使用、如何更新是非常困难的，这不仅降低代码的可维护性，还给代码的学习者很大的挫败感，久而久之的影响就是<strong>谁也不愿意接手这代码</strong>。</p>
<p>解决这个问题通常有 2 种方法：</p>
<ol>
<li>把状态和更新封装到自定义的 hook 中，比如就叫 <code class="gatsby-code-text">useSelection</code>。</li>
<li>使用 <code class="gatsby-code-text">useReducer</code> 来实现。</li>
</ol>
<p>第一种方法自不必说，能不能找到合适的粒度来实现自定义 hook 就是对 react 开发者的素质的考验。但不少时候自定义 hook 作为一种解决方案还是过于重量级，虽然它仅仅是一个函数，但依然会需要阅读者去理解输入输出，使用 TypeScript 还可能造成类型定义上的额外工作。</p>
<p>使用 <code class="gatsby-code-text">useReducer</code> 可以在不少轻量级的场景里快速地将状态声明和状态更新放在一起，比如上面的例子：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">SelectableList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>selectionState<span class="token punctuation">,</span> dispatchSelectionState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token string">'select'</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token punctuation">{</span>
                        selection<span class="token operator">:</span> state<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        lastSelected<span class="token operator">:</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>selection<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lastSelected<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>可以看到的是，通过 <code class="gatsby-code-text">useReducer</code> 我们传递一个函数，这个函数清晰地表达了 <code class="gatsby-code-text">&#39;select&#39;</code> 这个类型的操作，以及对应的状态更新。<code class="gatsby-code-text">useReducer</code> 的第二个参数也很好地说明了状态的结构。</p>
<p>当然如果使用本系列前一篇中讲述的 <code class="gatsby-code-text">useImmer</code> 或 <code class="gatsby-code-text">useMethods</code> 会更容易实现：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">SelectableList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>selectionState<span class="token punctuation">,</span> <span class="token punctuation">{</span>select<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useMethods</span><span class="token punctuation">(</span>
        methods<span class="token punctuation">,</span>
        <span class="token punctuation">{</span>selection<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lastSelected<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h2 id="状态过粗"><a href="#%E7%8A%B6%E6%80%81%E8%BF%87%E7%B2%97" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态过粗</h2>
<p>反过来说，状态也可能太粗，比如我们硬是将整个 class 的状态移到一个 <code class="gatsby-code-text">useState</code> 里：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token constant">DEFAULT_STATE</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    dataSource<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    isLoading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    filterText<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    filterType<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">TodoList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>我个人是不太能想象谁会去写这样的代码的，也许背了一个“把 class 全部变成 hook”的 KPI 的可怜孩子会玩这一套……</p>
<p>不过在此依然需要提一下状态过粗的代价，试想这样的组件：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span>
        isBaseLoading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        isDetailLoading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        baseInfo<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        detailInfo<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        isDetailVisible<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">async</span> <span class="token function-variable function">showDetail</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>detailInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>isDetailVisible<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>isDetailLoading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> detail <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                isDetailLoading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                detailInfo<span class="token operator">:</span> detail<span class="token punctuation">,</span>
                isDetailVisible<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后我们还有一个这样的组件：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">TodoList</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span>
        filterText<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        filterType<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span>
        showFilterPanel<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function-variable function">toggleFilterPanel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setStae</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>showFilterPanel<span class="token operator">:</span> <span class="token operator">!</span>s<span class="token punctuation">.</span>showFilterPanel<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这有什么问题呢？仔细去看 2 个组件，我们会发现它们其实是有共同的部分的：</p>
<ol>
<li>有一个能展开/收起的状态，一个叫 <code class="gatsby-code-text">isDetailVisible</code> 一个叫 <code class="gatsby-code-text">showFilterPanel</code>。</li>
<li>有多个和异步过程有关的状态，比如 <code class="gatsby-code-text">isBaseLoading</code> 和 <code class="gatsby-code-text">isDetailLoading</code>。</li>
<li>有异步状态与结果的成对出现，比如 <code class="gatsby-code-text">isBaseLoading</code> 配对 <code class="gatsby-code-text">baseInfo</code>，<code class="gatsby-code-text">isDetailLoading</code> 配对 <code class="gatsby-code-text">detailInfo</code>。</li>
</ol>
<p>但能得到这些结论，很大程度上归功于我给的代码过于精简，以及给了阅读者明确的“去发现”的目的。</p>
<p>试想你有一个超过 10 万行代码的项目，里面有 800 多个组件，有些组件有 1200 多行，你作为一个技术负责人空降到项目中，有信心去发现这些东西吗？反正我作为一个所谓的高 T，很实诚地说我做不到。</p>
<p>所以状态粒度过粗的问题就在于，它会隐藏掉可以复用的状态，让人不知不觉通过“行云流水地重复编码”来实现功能，离复用和精简越来越远。</p>
<p>当然，有时候保持一定程度上的重复是有意义的，比如使代码更具语义化，让人更看得懂代码在干啥，这在 class 时代特别明显。在 class 明代能解决这一问题的办法就是 HOC，比如我们做 <code class="gatsby-code-text">withLoading</code>、<code class="gatsby-code-text">withToggle</code>、<code class="gatsby-code-text">withRemoteData</code> 等等……</p>
<p>然后就会变成这样：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/24e3764b9fb11a47e18be65f8426db93/394f7/1_yJyHd9CKkqgToX7DtI6fcg.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 707px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 36.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABFUlEQVQY02WOy07DMBBF8///wEOsqKCCHQilgIT4BbZAS+vEzmM89jh24gcOSBWlV2cxizl3pnh9w8sVuy7Z8qm6ysOqytw814uyWj6y25fdYvV5cfd+er89eRBnJT8vxZ4ipeSdJS5pB8RAVz2xljiYmilRK1EpvkVRE3QD4jhO6U8KH2KMyVkHQpI0jsggDGYYSA/YaRqNJq3ITSGGkJdDTHuKMMsx11hnFTTAWc2NFLwVUgGiqNpOS6mcHUII6TC/8lzTdMjrpuHZJtFAJVC0AD2idqitcd6O4R+znDtIGf7RNJteCq0hv+zc6Ecfpph8TFNIo4/HzLIG3a872PSw6fLQr1v46pBJarXFwbsp/hw4zjeiDIisW3PYQAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="1 yJyHd9CKkqgToX7DtI6fcg"
        title=""
        src="/static/24e3764b9fb11a47e18be65f8426db93/394f7/1_yJyHd9CKkqgToX7DtI6fcg.png"
        srcset="/static/24e3764b9fb11a47e18be65f8426db93/65ed1/1_yJyHd9CKkqgToX7DtI6fcg.png 210w,
/static/24e3764b9fb11a47e18be65f8426db93/d10fb/1_yJyHd9CKkqgToX7DtI6fcg.png 420w,
/static/24e3764b9fb11a47e18be65f8426db93/394f7/1_yJyHd9CKkqgToX7DtI6fcg.png 707w"
        sizes="(max-width: 707px) 100vw, 707px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>好在 hook 能比较合理地去解决这种嵌套问题。</p>
<h2 id="合理设计粒度"><a href="#%E5%90%88%E7%90%86%E8%AE%BE%E8%AE%A1%E7%B2%92%E5%BA%A6" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>合理设计粒度</h2>
<p>本章讲了 2 个主要的论述：状态粒度太细不好，粒度太粗也不好。</p>
<p>在实际的业务里，比这复杂的多的事情天天在发生，远不是太细了合一合、太粗了分一分这么简单，大部分时候我们面对的是这样的情况：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/a2a4a2c5d0d50a193a6c70afa4878f7f/daed9/Jietu20200222-133557%402x.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 80.47619047619048%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACpElEQVQ4y22US3LTQBCGfQEW3IADcAWKLbsUJ8mKKm7BgmJHsQGyhAVFsmABpFgEXCEhwY6thxXLtuyxZMl6v2b005IsE8XpKs9Yqp6v++/uUacoCpTW7KlIMQ2vMfJlaIGMcaAizIONj7jxK3D7bGmdmy/MhGHg/oWdrhDxEBGBvMyF7PUxjSb1Yfy3u6Cd5s8qMeng1daZC7RMt8+xWH4DomuIYIgiWbTAzV5lyAsOyettIpZvxCaXolpFMqPVwggknwKDyiKiMYTfb8G2QDdzqFajJje8lgrs/xQkmR5zGzmVIXv5AvqL5zCEtZVepBZlO2hLLpdZpGOd2tv67JGyzlvA4WWXJIJGiB49hPH4ARawNwBeQ0MVRbZuS2aRASunyDlJNXXMhgqG5xJyhaKz39C9FIOzIbqnXRxPRjB9vikLrfGM6snawEBEGJl/gIs+wo+/AGlRSedRiN73Q0wpQGmTlGES6JiuM1wxr4Ykt4B1DwqMLj4jMOZw997BfXNSOQyWCZYOdf66D6wD/HC+YF9+gq/uASziaQRGMoKgHrSBloXY0NCn4jvdUmaMmFRpVtkVHwk7IeYxlETBM/UpDlcHFeByQp0OpN2m5JpMkVJkyCHnCqa5BsU2cMFmYNyFtO7CP/9ADXI2gxCR/xjj2SWcKNsdG65rFKmuSVnrhPvor3R0DQn+5BWEeYRC6ZGPChEq4CGNWMagrmIEKd8FFp4LrtWFLzhHM2jSjObs+B7iT/eRG/VYCVFL47T1Fv7uXW4euCpBWGaTZGXTMIM0OAJO35ek1lW8Yj5WYbZzp7fA8s5xdVjLNxn4kkaHGZieyRhOQsyDHHM3huEmVWZzL9m5xztfmyo7x4ZgcwgCcpNV8xjkHMY6riAlMM7FnbDS/gFmSsPuOExcQQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Jietu20200222 133557 2x"
        title=""
        src="/static/a2a4a2c5d0d50a193a6c70afa4878f7f/1e088/Jietu20200222-133557%402x.png"
        srcset="/static/a2a4a2c5d0d50a193a6c70afa4878f7f/65ed1/Jietu20200222-133557%402x.png 210w,
/static/a2a4a2c5d0d50a193a6c70afa4878f7f/d10fb/Jietu20200222-133557%402x.png 420w,
/static/a2a4a2c5d0d50a193a6c70afa4878f7f/1e088/Jietu20200222-133557%402x.png 840w,
/static/a2a4a2c5d0d50a193a6c70afa4878f7f/78612/Jietu20200222-133557%402x.png 1260w,
/static/a2a4a2c5d0d50a193a6c70afa4878f7f/daed9/Jietu20200222-133557%402x.png 1426w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>5 个状态 4 个组合操作，怎么设计粒度更合理，就慢慢折腾去吧。</p>]]></description><link>https://zh-hans.reactjs.org/blog/2020/08/22/react-hooks-state-granularity.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2020/08/22/react-hooks-state-granularity.html</guid><pubDate>Sat, 22 Aug 2020 00:00:00 GMT</pubDate></item><item><title><![CDATA[React Hooks 的体系设计之一 - 分层]]></title><description><![CDATA[<blockquote>
<p>本文由百度资深研发工程师兼百度 ECOMFE FE-CMC 现任主席 — 张立理大佬授权转载。本系列文章对 Hook 进行了深度剖析。</p>
</blockquote>
<p>React Hooks 是 React 框架内的逻辑复用形式，因其轻量、易编写的形态，必然会逐渐成为一种主流。但在实际的开发中，我依然觉得大部分的开发者对 hook 的使用过于粗暴，缺乏设计感和复用性。</p>
<p>我在<a href="https://www.zhihu.com/question/357020049/answer/909484669" target="_blank" rel="nofollow noopener noreferrer">《如何去合理使用 React hook》的回答</a>中有简单地提到一些思路，之后我会发布一个小系列来展开地讲述 hook 的设计和实现细节问题。</p>
<h2 id="万物始于分层"><a href="#%E4%B8%87%E7%89%A9%E5%A7%8B%E4%BA%8E%E5%88%86%E5%B1%82" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>万物始于分层</h2>
<p>软件工程中的经典论述：</p>
<blockquote>
<p>We can solve any problem by introducing an extra level of indirection.</p>
<p>没有什么问题是加一个层解决不了的。</p>
</blockquote>
<p>这个论述自软件工程诞生起，时至今日依然是成立的。但要使之成立就必须有一个大前提：我们有分层。</p>
<p>React 内置的 hook 提供了基础的能力，虽然本质上它也有一些分层，比如：</p>
<ul>
<li><code class="gatsby-code-text">useState</code> 是基于 <code class="gatsby-code-text">useReducer</code> 的简化版。</li>
<li><code class="gatsby-code-text">useMemo</code> 和 <code class="gatsby-code-text">useCallback</code> 事实上可以基于 <code class="gatsby-code-text">useRef</code> 实现。</li>
</ul>
<p>但在实际应用时，我们可以将这些统一视为一层，即最基础的底层。</p>
<p>因此，如果我们在实际的应用开发中，单纯地在组件里组合使用内置的 hook，无疑是一种不分层的粗暴使用形式，这仅仅在表象上使用了 hook，而无法基于 hook 达到逻辑复用的目标。</p>
<h2 id="状态的分层设计"><a href="#%E7%8A%B6%E6%80%81%E7%9A%84%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态的分层设计</h2>
<p>分层的形式固然千千万万五花八门，我选择了一种更为贴近传统、更能表达程序的本质的方法，以此将 hook 在纵向分为了 6 个层，自底向上依次是：</p>
<ol>
<li>最底层的内置 hook，不需要自己实现，官方直接提供。</li>
<li>简化状态更新方式的 hook，比较经典的是引入 <a href="https://github.com/immerjs/immer" target="_blank" rel="nofollow noopener noreferrer">immer</a> 来达到更方便地进行不可变更新的目的。</li>
<li>引入“状态 + 行为”的概念，通过声明状态结构与相应行为快速创建一个完整上下文。</li>
<li>对常见数据结构的操作进行封装，如数组的操作。</li>
<li>针对通用业务场景进行封装，如分页的列表、滚动加载的列表、多选等。</li>
<li>实际面向业务的实现。</li>
</ol>
<p>需要注意的是，这边仅提到了对状态的分层设计。事实上有大量的 hook 是游离于状态之外的，如基于 <code class="gatsby-code-text">useEffect</code> 的 <code class="gatsby-code-text">useDocumentTitle</code>、<code class="gatsby-code-text">useElementSize</code>，或基于 <code class="gatsby-code-text">useRef</code> 的 <code class="gatsby-code-text">usePreviousValue</code>、<code class="gatsby-code-text">useStableMemo</code> 等，这些 hook 是更加零散、独立的形态。</p>
<h3 id="使用-immer-更新状态"><a href="#%E4%BD%BF%E7%94%A8-immer-%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 immer 更新状态</h3>
<p>在第二层中，我们需要解决的问题是 React 要求的不可变数据更新有一定的操作复杂性，比如当我们需要更新对象的一个属性时，就需要：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>oldValue<span class="token punctuation">,</span>
    foo<span class="token operator">:</span> newFoo<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>这仅限于一个属性的更新，如果属性的层级较深时，代码就不得不变成这样子：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>oldValue<span class="token punctuation">,</span>
    foo<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>oldValue<span class="token operator">?.</span>foo<span class="token punctuation">,</span>
        bar<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>oldValue<span class="token operator">?.</span>foo<span class="token operator">?.</span>bar<span class="token punctuation">,</span>
            alice<span class="token operator">:</span> newAlice
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>数组同样也不怎么容易，比如想删除一个元素，你就得这么来：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> newArray <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span>oldArray<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>oldArray<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre></div>
<p>要解决这一系列的问题，我们可以使用 immer 进行更新，利用 <code class="gatsby-code-text">Proxy</code> 的特性将可变的数据更新映射为不可变的操作。</p>
<p>状态管理的基础 hook 是 <code class="gatsby-code-text">useState</code> 和 <code class="gatsby-code-text">useReducer</code>，因此我们能封装成：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useImmerState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>foo<span class="token operator">:</span> <span class="token punctuation">{</span>bar<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=></span> s<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接进行可变更新</span>
<span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>foo<span class="token operator">:</span> <span class="token punctuation">{</span>bar<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保留直接更新值的功能</span></code></pre></div>
<p>以及：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useImmerReducer</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'ADD'</span><span class="token operator">:</span>
            state<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">+=</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'SUBTRACT'</span><span class="token operator">:</span>
            state<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">-=</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>foo<span class="token operator">:</span> <span class="token punctuation">{</span>bar<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'ADD'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>payload<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>这一部分并没有太多的工作 (immer 的 TS 类型是真的难写)，但提供了非常方便的状态更新能力，也便于在它之上的所有层的实现。</p>
<h3 id="状态与行为的封装"><a href="#%E7%8A%B6%E6%80%81%E4%B8%8E%E8%A1%8C%E4%B8%BA%E7%9A%84%E5%B0%81%E8%A3%85" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态与行为的封装</h3>
<p>组件的开发，或者说绝大部分的业务的开发，逃不出“一个状态加一系列行为”这个模式，且行为与状态的结构是强相关的。这个模式在面向对象里我们称之为类：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    age <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">birthday</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>而在 hook 中，我们会这么来：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> SetAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> birthday <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token parameter">age</span> <span class="token operator">=></span> age <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>age<span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>会出现一些问题：</p>
<ol>
<li>太多的 <code class="gatsby-code-text">useState</code> 和 <code class="gatsby-code-text">useCallback</code> 调用，重复的编码工作。</li>
<li>如果不仔细阅读代码，很难找到状态与行为的对应关系。</li>
</ol>
<p>因此，我们需要一个 hook 能帮我们把“一个状态”和“针对这个状态的行为”合并在一起：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> userMethods <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">birthday</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        user<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 利用了immer的能力</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> setUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useMethods</span><span class="token punctuation">(</span>
    userMethods<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

methods<span class="token punctuation">.</span><span class="token function">birthday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>可以看到，这样的声明非常接近面向对象的形态。有部分 React 的开发者在粗浅地了解函数式编程后，成了激进的“反面向对象党”，这显然是不可取的，面向对象依然是一种很好的封装和职责边界划分的形态，不一定要以其表面形态去实现，却也万万不可丢弃了其内在理念。</p>
<h3 id="数据结构的抽象"><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E6%8A%BD%E8%B1%A1" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据结构的抽象</h3>
<p>有了 <code class="gatsby-code-text">useMethods</code> 之后，我们已经可以快速地使任何类型和结构的状态与 hook 整合。我们一定会意识到，有一部分状态类型是业务无关的，是全天下开发者公用的，比如最基础的数据类型 <code class="gatsby-code-text">number</code>、<code class="gatsby-code-text">string</code>、<code class="gatsby-code-text">Array</code> 等。</p>
<p>在数据类型的封装上，我们依然会面对几个核心问题：</p>
<ol>
<li>部分数据类型的不可变操作相当复杂，比如不可变地实现 <code class="gatsby-code-text">Array#splice</code>，好在有 immer 合理地解决了问题。</li>
<li>部分操作的语义会发生变化，<code class="gatsby-code-text">setState</code> 最典型的是没有返回值，因此 <code class="gatsby-code-text">Array#pop</code> 只能产生“移除最后一个元素”的行为，而无法将移除的元素返回。</li>
<li>部分类型是天生可变的，如 <code class="gatsby-code-text">Set</code> 和 <code class="gatsby-code-text">Map</code>，将之映射到不可变需要额外的工作。</li>
</ol>
<p>针对常用数据结构的抽象，在试图解决这些问题 (第 2 个问题还真解决不了) 的同时，也能扩展一些行为，比如：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="gatsby-code-ts"><code class="gatsby-code-ts"><span class="token keyword">const</span> <span class="token punctuation">[</span>list<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> setList<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useArray</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ArrayMethods<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
    <span class="token function">push</span><span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">unshift</span><span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> end<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token operator">...</span>items<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">removeAt</span><span class="token punctuation">(</span>index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">insertAt</span><span class="token punctuation">(</span>index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> item<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">concat</span><span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">replaceAt</span><span class="token punctuation">(</span>index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> item<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">filter</span><span class="token punctuation">(</span><span class="token function-variable function">predicate</span><span class="token operator">:</span> <span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">union</span><span class="token punctuation">(</span>array<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">intersect</span><span class="token punctuation">(</span>array<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">difference</span><span class="token punctuation">(</span>array<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">sort</span><span class="token punctuation">(</span>compare<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>而诸如 <code class="gatsby-code-text">useSet</code> 和 <code class="gatsby-code-text">useMap</code> 则会在每次更新时做一次对象复制的操作，强制实现状态的不可变。</p>
<p>我在社区的 hook 库中，很少看到有单独一个层实现数据结构的封装，实为一种遗憾。截止到今日，大致 <code class="gatsby-code-text">useNumber</code>、<code class="gatsby-code-text">useArray</code>、<code class="gatsby-code-text">useSet</code>、<code class="gatsby-code-text">useMap</code>、<code class="gatsby-code-text">useBoolean</code> 是已然实现的，其中还衍生出 <code class="gatsby-code-text">useToggle</code> 这样场景更狭窄的实现。而 <code class="gatsby-code-text">useString</code>、<code class="gatsby-code-text">useFunction</code> 和 <code class="gatsby-code-text">useObject</code> 能够提供什么能力还有待观察。</p>
<h3 id="通用场景封装"><a href="#%E9%80%9A%E7%94%A8%E5%9C%BA%E6%99%AF%E5%B0%81%E8%A3%85" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通用场景封装</h3>
<p>在有了基本的数据结构后，可以对场景进行封装，这一点在阿里的 <a href="https://github.com/umijs/hooks" target="_blank" rel="nofollow noopener noreferrer">@umijs/hooks</a> 体现的比较多，如 <code class="gatsby-code-text">useVirtualList</code> 就是一个价值非常大的场景的封装。</p>
<p>需要注意的是，场景的封装不应与组件库耦合，它应当是业务与组件之间的桥梁，不同的组件库使用相同的 hook 实现不同的界面，这才是一个理想的模式：</p>
<ul>
<li><code class="gatsby-code-text">useTransfer</code> 实现左右双列表选择的能力。</li>
<li><code class="gatsby-code-text">useSelection</code> 实现列表上单选、多选、范围选择的能力</li>
<li><code class="gatsby-code-text">useScrollToLoad</code> 实现滚动加载的能力。</li>
</ul>
<p>通用场景的封装非常的多，它的灵感可以来源于某一个组件库，也可以由团队的业务沉淀。一个充分的场景封装 hook 集合会是未来 React 业务开发的效率的关键之一。</p>
<h2 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h2>
<p>总而言之，在业务中暴力地直接使用 <code class="gatsby-code-text">useState</code> 等 hook 并不是一个值得提倡的方式，而针对状态这一块，精细地做一下分层，并在每个层提供相应的能力，是有助于组织 hook 库并赋能于业务研发效率的。</p>
<p>我们正在研发一个命名为 <a href="https://github.com/ecomfe/react-hooks" target="_blank" rel="nofollow noopener noreferrer">@huse</a> 的 hook 集合，同样应用了分层的理念，也欢迎提出相应的需求，将于近期发布一个版本。</p>]]></description><link>https://zh-hans.reactjs.org/blog/2020/08/21/react-hooks-extra-level-of-indirection.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2020/08/21/react-hooks-extra-level-of-indirection.html</guid><pubDate>Fri, 21 Aug 2020 00:00:00 GMT</pubDate></item><item><title><![CDATA[React v17.0 RC 版本发布：没有新特性]]></title><description><![CDATA[<p>今天，我们发布了 React 17 的第一个 RC 版本。自 <a href="/blog/2017/09/26/react-v16.0.html">React 上一个主要版本</a>至今已经两年半了，按照我们的标准，时间跨度有些长了！在此篇博客中，我们将讲解此次主要版本的职责，对你的影响以及如何试用此版本。</p>
<h2 id="no-new-features"><a href="#no-new-features" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>无新特性 </h2>
<p>React 17 的版本是非比寻常的，因为它没有添加任何面向开发人员的新功能。而主要侧重于<strong>升级简化 React 本身</strong>。</p>
<p>我们正在积极开发 React 的新功能，但它们并不属于此版本。React 17 是我们进行深度推广战略的关键所在。</p>
<p>此版本之所以特殊，你可以认为<strong>React 17 是 “垫脚石” 版本</strong>，它会使得由一个 React 版本管理的 tree 嵌入到另一个 React 版本管理的 tree 中时会更加安全。</p>
<h2 id="gradual-upgrades"><a href="#gradual-upgrades" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>逐步升级 </h2>
<p>在过去 7 年里，React 一直遵循 “all-or-nothing” 的升级策略。你可以继续使用旧版本，也可以将整个应用程序升级至新版本。但没有介于两者之间的情况。</p>
<p>此方式持续至今，但是我们遇到了 “all-or-nothing” 升级策略的局限性。许多 API 的变更，例如，弃用<a href="/docs/legacy-context.html">旧版 context API</a> 时，并不能以自动化的方式来完成。至今可能大多数应用程序从未使用过它们，但我们仍然选择在 React 中支持它们。我们必须在无限期支持过时的 API 或针对某些应用仍使用旧版本 React 间进行选择。但这两个方案都不合适。</p>
<p>因此，我们想提供另一种方案。</p>
<p><strong>React 17 开始支持逐步升级 React 版本</strong>。当从 React 15 升级至 16 时（或者从 React 16 升级至 17时），通常会一次升级整个应用程序。这适用于大部分应用程序。但是，如果代码库是在几年前编写的，并且并没有得到很好的维护，那么升级它会变得越来越有挑战性。尽管可以在页面上使用两个版本的 React，但是直到 React 17 依旧有事件问题出现。</p>
<p>我们使用 React 17 解决了许多诸如此类的问题。这将意味着<strong>当 React 18 或未来版本问世时，你将有更多选择</strong>。首选还是像以前一样，一次升级整个应用程序。但你也可以选择逐步升级你的应用程序。例如，你可能会将大部分应用程序迁移至 React 18，但在 React 17 上保留一些延迟加载的对话框或子路由。</p>
<p>但这不意味着你<em>必须</em>逐步升级。对于大部分应用程序来说，一次全量升级仍是最好的解决方案。加载两个 React 版本，即使其中一个是按需延迟加载的，仍然不太理想。但是，对于没有积极维护的大型应用来说，可以考虑此种方案，并且 React 17 开始可以保证这些应用程序不落伍。</p>
<p>为了实现逐步升级，我们需要对 React 事件系统进行一些更改。而这些更改可能会对代码产生影响，这也是 React 17 成为主要版本的原因。实际上，10 万个以上的组件中受影响的组件不超过 20 个，因此，<strong>我们希望大多数应用程序都可以升级到 React 17，而不会产生太多影响</strong>。如果你遇到问题，请<a href="https://github.com/facebook/react/issues" target="_blank" rel="nofollow noopener noreferrer">联系我们</a>。</p>
<h3 id="demo-of-gradual-upgrades"><a href="#demo-of-gradual-upgrades" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>逐步升级 Demo </h3>
<p>我们准备了一个<a href="https://github.com/reactjs/react-gradual-upgrade-demo/" target="_blank" rel="nofollow noopener noreferrer">示例 repo</a>，展示了如何在必要时延迟加载旧版本的 React。此 demo 使用了 Create React App 进行构建，但对其他工具采用类似的方法应该也适用。我们欢迎使用其他工具的开发者编写 demo 并提交 PR。</p>
<blockquote>
<p>注意</p>
<p>我们已将<strong>其他更改推迟</strong>到 React 17 之后。此版本的目标是实现逐步升级。如果升级 React 17 太困难，则此目标会无法实现。</p>
</blockquote>
<h2 id="changes-to-event-delegation"><a href="#changes-to-event-delegation" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更改事件委托 </h2>
<p>从技术上讲，始终可以在应用程序中嵌套不同版本的 React。但是，由于 React 事件系统的工作原理，这很难实现。</p>
<p>在 React 组件中，通常会内联编写事件处理：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span></code></pre></div>
<p>与此代码等效的原生 DOM 操作如下：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">myButton<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> handleClick<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>但是，对大多数事件来说，React 实际上并不会将它们附加到 DOM 节点上。相反，React 会直接在 <code class="gatsby-code-text">document</code> 节点上为每种事件类型附加一个处理器。这被称为<a href="https://davidwalsh.name/event-delegate" target="_blank" rel="nofollow noopener noreferrer">事件委托</a>。除了在大型应用程序上具有性能优势外，它还使添加类似于 <a href="https://twitter.com/dan_abramov/status/1200118229697486849" target="_blank" rel="nofollow noopener noreferrer">replaying events</a> 这样的新特性变得更加容易。</p>
<p>自从其发布以来，React 一直自动进行事件委托。当 document 上触发 DOM 事件时，React 会找出调用的组件，然后 React 事件会在组件中向上 “冒泡”。但实际上，原生事件已经冒泡出了 <code class="gatsby-code-text">document</code> 级别，React 在其中安装了事件处理器。</p>
<p>但是，这就是逐步升级的困难所在。</p>
<p>如果页面上有多个 React 版本，他们都将在顶层注册事件处理器。这会破坏 <code class="gatsby-code-text">e.stopPropagation()</code>：如果嵌套树结构中阻止了事件冒泡，但外部树依然能接收到它。这会使不同版本 React 嵌套变得困难重重。这种担忧并不是没有根据的 —— 例如，四年前 Atom 编辑器就遇到了<a href="https://github.com/facebook/react/pull/8117" target="_blank" rel="nofollow noopener noreferrer">相同的问题</a>。</p>
<p>这也是我们为什么要改变 React 底层附加事件方式的原因。</p>
<p><strong>在 React 17 中，React 将不再向 <code class="gatsby-code-text">document</code> 附加事件处理器。而会将事件处理器附加到渲染 React 树的根 DOM 容器中：</strong></p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> rootNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> rootNode<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>在 React 16 或更早版本中，React 会对大多数事件执行 <code class="gatsby-code-text">document.addEventListener()</code>。React 17 将会在底层调用 <code class="gatsby-code-text">rootNode.addEventListener()</code>。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/bb4b10114882a50090b8ff61b3c4d0fd/31868/react_17_delegation.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 77.14285714285715%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACcUlEQVQ4y21T2W4TMRTNr0MfgDeEkPgSJF55JarUJSVpm07WaZLZV+/24XomE9LFypEd3zPnrh59nHFcED5MGT7fc/wIBL7OOT7ds+7O21/D878/CXwjfHnov7042kYhs/DYEnbcIpYOB+HwLIGQO7IZDJyBFxIvEh6u+2Z7Zh/htBz9bL8bAbO7AjTDu8u5427fmEaWjN7MtUHBOPKiRB7O0Nz/gkjm0G3a2TseHbS1KIVCUTfI8vxkGzByHbFHXdfYRwni9RSu3MAqBpWvYXhxDKyPjHOO/X7fwS9LTgbbaDhYY8AYQ11VOGQVZJPAippQwTQxZWdOaXnBgjJJkhjyRSVcX0NDHhqpwLQFbxtsSobn7ABIEpQNDMvgjOzSY1KjVQYNE1jscgTMYRm14Kp3OBqUGV0cuMFkFeJxl6AsI5iWhLSkPe0E/VLGIhUGQVrh5zjA9abCrpBYxexlynErcbmOMNnnmEQ15k8TsOrQRdWlfOT56O52KS43CcaLGL9nzyi4QFQqKO3Hhog+2CCr8TcXeGgtVlWLeTBBRBFLxSnl/FSniCncxRVuMoPHFvgTNphFJaLWQJvjHHLjcHsoMU1KzNISD0mKx3CLec5oPAoYrfrGERYFw+W+wXUqcVsajMO6E1xXCi3Vt4vQ0683ByypGUsq8oK6F9QK61ZDklcMo0W8ZdHiZht3L+kqFpjlCstGo1Q971TDgkss8wZPWYGAhNf07ErtXowEjg8gLGpMM4G7RGDF+mdoXs+hV2dEjqiDibRoTT/5/im6swj9f9/pRPRCFTk98/t/bM7uSAhvInuP589aU1mk7ODP/wCR7n8+8QwuZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="A diagram showing how React 17 attaches events to the roots rather than to the document"
        title=""
        src="/static/bb4b10114882a50090b8ff61b3c4d0fd/1e088/react_17_delegation.png"
        srcset="/static/bb4b10114882a50090b8ff61b3c4d0fd/65ed1/react_17_delegation.png 210w,
/static/bb4b10114882a50090b8ff61b3c4d0fd/d10fb/react_17_delegation.png 420w,
/static/bb4b10114882a50090b8ff61b3c4d0fd/1e088/react_17_delegation.png 840w,
/static/bb4b10114882a50090b8ff61b3c4d0fd/78612/react_17_delegation.png 1260w,
/static/bb4b10114882a50090b8ff61b3c4d0fd/21cdd/react_17_delegation.png 1680w,
/static/bb4b10114882a50090b8ff61b3c4d0fd/31868/react_17_delegation.png 3496w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>由于此更改，<strong>现在可以更加安全地进行新旧版本 React 树的嵌套</strong>。请注意，要使其正常工作，两个版本都必须为 17 或更高版本，这就是为什么强烈建议升级到 React 17 的根本原因。从某种意义上讲，React 17 是一个 “垫脚石” 版本，使逐步升级成为可能。</p>
<p>此更改还使得<strong>将 React 嵌入使用其他技术构建的应用程序变得更加容易</strong>。例如，如果应用程序的“外壳”是用 jQuery 编写的，但其中较新的代码是用 React 编写的，则 React 代码中的 <code class="gatsby-code-text">e.stopPropagation()</code> 会阻止它影响 jQuery 的代码 —— 这符合预期。换个角度来说，如果你不再喜欢 React 并想重写应用程序（比如，用 jQuery），则可以从外壳开始将 React 转换为 jQuery，而不会破坏事件冒泡。</p>
<p>经核实，多年来在 <a href="https://github.com/facebook/react/issues/7094" target="_blank" rel="nofollow noopener noreferrer">issue</a> <a href="https://github.com/facebook/react/issues/8693" target="_blank" rel="nofollow noopener noreferrer">追踪器</a> 上<a href="https://github.com/facebook/react/issues/12518" target="_blank" rel="nofollow noopener noreferrer">报告</a>的<a href="https://github.com/facebook/react/issues/13451" target="_blank" rel="nofollow noopener noreferrer">许多</a><a href="https://github.com/facebook/react/issues/4335" target="_blank" rel="nofollow noopener noreferrer">问题</a><a href="https://github.com/facebook/react/issues/1691" target="_blank" rel="nofollow noopener noreferrer">都</a><a href="https://github.com/facebook/react/issues/285#issuecomment-253502585" target="_blank" rel="nofollow noopener noreferrer">已</a><a href="https://github.com/facebook/react/pull/8117" target="_blank" rel="nofollow noopener noreferrer">被</a><a href="https://github.com/facebook/react/issues/11530" target="_blank" rel="nofollow noopener noreferrer">新特性</a><a href="https://github.com/facebook/react/issues/7128" target="_blank" rel="nofollow noopener noreferrer">解决</a>，这些问题大多都与将 React 与非 React 代码集成有关。</p>
<blockquote>
<p>注意</p>
<p>你可能想知道这是否会破坏根 DOM 容器之外的 <a href="/docs/portals.html">Portals</a>。答案是 React 还会监听 portals 容器上的事件，所以这不是问题。</p>
</blockquote>
<h4 id="fixing-potential-issues"><a href="#fixing-potential-issues" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决隐患 </h4>
<p>与其他重大更改一样，可能需要对代码进行调整。在 Facebook，我们在成千上万个模块中，大约调整了 10 个模块以适应此更改。</p>
<p>例如，如果模块中使用 <code class="gatsby-code-text">document.addEventListener(...)</code> 手动添加了 DOM 监听，你可能希望能捕获到所有 React 事件。在 React 16 或更早版本中，即使你在 React 事件处理器中调用 <code class="gatsby-code-text">e.stopPropagation()</code>，你创建的 DOM 监听仍会触发，这是因为原生事件已经处于 document 级别。使用 React 17 冒泡将被阻止（按需），因此你的 <code class="gatsby-code-text">document</code> 级别的事件监听不会触发：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// This custom handler will no longer receive clicks</span>
  <span class="token comment">// from React components that called e.stopPropagation()</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>你可以将监听转换为使用<a href="https://javascript.info/bubbling-and-capturing#capturing" target="_blank" rel="nofollow noopener noreferrer">捕获</a>来修复此类代码。为此，你可以将 <code class="gatsby-code-text">{ capture: true }</code> 作为 <code class="gatsby-code-text">document.addEventListener</code> 的第三个参数传递：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Now this event handler uses the capture phase,</span>
  <span class="token comment">// so it receives *all* click events below!</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> capture<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>请注意，此策略在全局上具有更好的适应性。例如，它可能会修复代码中现有的错误，这些错误在 React 事件处理器外部调用 <code class="gatsby-code-text">e.stopPropagation()</code> 发生。换句话说，<strong>React 17 的事件冒泡更接近常规 DOM</strong>。</p>
<h2 id="other-breaking-changes"><a href="#other-breaking-changes" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他重大更改 </h2>
<p>我们将 React 17 中的重大更改保持在最低水平。例如，它不会删除以前版本中弃用的任务方法。但是，它的确包含一些其他重大更改，根据经验，这些更改会相对安全。总体而言，由于这些因素的存在，在 10 万个以上的组件中受影响的组件不超过 20 个。</p>
<h3 id="aligning-with-browsers"><a href="#aligning-with-browsers" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对标浏览器 </h3>
<p>我们对事件系统进行了一些较小的更改：</p>
<ul>
<li><code class="gatsby-code-text">onScroll</code> 事件<strong>不再冒泡</strong>，以防止<a href="https://github.com/facebook/react/issues/15723" target="_blank" rel="nofollow noopener noreferrer">出现常见的混淆</a>。</li>
<li>React 的 <code class="gatsby-code-text">onFocus</code> 和 <code class="gatsby-code-text">onBlur</code> 事件已在底层切换为原生的 <code class="gatsby-code-text">focusin</code> 和 <code class="gatsby-code-text">focusout</code> 事件。它们更接近 React 现有行为，有时还会提供额外的信息。</li>
<li>捕获事件（例如，<code class="gatsby-code-text">onClickCapture</code>）现在使用的是实际浏览器中的捕获监听器。</li>
</ul>
<p>这些更改会使 React 与浏览器行为更接近，并提高了互操作性。</p>
<blockquote>
<p>注意：</p>
<p>尽管 React 17 <strong>底层</strong>已将 <code class="gatsby-code-text">onFocus</code> 事件从 <code class="gatsby-code-text">focus</code> 切换为 <code class="gatsby-code-text">focusin</code>，但请注意，这并未影响冒泡行为。在 React 中，<code class="gatsby-code-text">onFocus</code> 事件总是冒泡的，在 React 17 中会继续保持，因为通常它是一个更有用的默认值。请参阅 <a href="https://codesandbox.io/s/strange-albattani-7tqr7?file=/src/App.js" target="_blank" rel="nofollow noopener noreferrer">sandbox</a>，以了解为不同特定用例添加不同检查。</p>
</blockquote>
<h3 id="no-event-pooling"><a href="#no-event-pooling" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>去除事件池 </h3>
<p>React 17 中移除了 “event pooling（事件池）“。它并不会提高现代浏览器的性能，甚至还会使经验丰富的开发者一头雾水：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setData</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>data<span class="token punctuation">,</span>
    <span class="token comment">// This crashes in React 16 and earlier:</span>
    text<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这是因为 React 在旧浏览器中重用了不同事件的事件对象，以提高性能，并将所有事件字段在它们之前设置为 <code class="gatsby-code-text">null</code>。在 React 16 及更早版本中，使用者必须调用 <code class="gatsby-code-text">e.persist()</code> 才能正确的使用该事件，或者正确读取需要的属性。</p>
<p><strong>在 React 17 中，此代码可以按照预期效果执行。旧的事件池优化操作已被完成删除，因此，使用者可以在需要时读取事件字段。</strong></p>
<p>这改变了行为，因此我们将其标记为重大更改，但在实践中我们没有看到它在 Facebook 上造成影响。（甚至还修复了一些错误！）请注意，<code class="gatsby-code-text">e.persist()</code> 在 React 事件对象中仍然可用，只是无效果罢了。</p>
<h3 id="effect-cleanup-timing"><a href="#effect-cleanup-timing" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>副作用清理时间 </h3>
<p>我们将使 <code class="gatsby-code-text">useEffect</code> 和清理函数的时间保持一致。</p>
<div class="gatsby-highlight has-highlighted-lines" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// This is the effect itself.</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// This is its cleanup.</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>大多数副作用（effect）不需要延迟屏幕更新，因此 React 在屏幕上反映出更新后立即异步执行它们。（在极少数情况下，你需要一种副作用来阻止绘制，例如，如果需要获取尺寸和位置，请使用 <code class="gatsby-code-text">useLayoutEffect</code>。）</p>
<p>然而，副作用<em>清理</em>函数（如果存在）在 React 16 中同步运行。我们发现，对于大型应用程序来说，这不是理想选择，因为同步会减缓屏幕的过渡（例如，切换标签）。</p>
<p><strong>在 React 17 中，副作用清理函数会异步执行 —— 如果要卸载组件，则清理会在屏幕更新<em>后</em>运行。</strong></p>
<p>这反映了副作用本身如何更紧密地运行。在极少数情况下，你可能希望依靠同步执行，可以改用 <code class="gatsby-code-text">useLayoutEffect</code>。</p>
<blockquote>
<p>注意</p>
<p>你可能想知道这是否意味着你现在将无法修复有关未挂载组件上的 <code class="gatsby-code-text">setState</code> 的警告。不必担心，React 专门处理了这种情况，并且不会在卸载和清理之间短暂间隔内发出 <code class="gatsby-code-text">setState</code> 的警告。<strong>因此，取消代码的请求或间隔几乎总是可以保存不变的。</strong></p>
</blockquote>
<p>此外，React 17 会根据它们在树中的位置，以与效果相同的顺序执行清除功能。以前，顺序有时会不同。</p>
<h4 id="potential-issues"><a href="#potential-issues" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>隐患 </h4>
<p>可复用的库可能需要对此情况进行深度测试，但我们只遇到了几个组件会因为这次改变出现问题。有问题的代码的其中一个示例如下所示：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  someRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">someSetupMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    someRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">someCleanupMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>问题在于 <code class="gatsby-code-text">someRef.current</code> 是可变的，因此在运行清除函数时，它可能已经设置为 <code class="gatsby-code-text">null</code>。解决方案是在副作用<strong>内部</strong>存储会发生变化的值：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> someRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span><span class="token function">someSetupMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span><span class="token function">someCleanupMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>我们不希望此问题对大家造成影响，我们提供了 <a href="https://github.com/facebook/react/tree/master/packages/eslint-plugin-react-hooks" target="_blank" rel="nofollow noopener noreferrer"><code class="gatsby-code-text">eslint-plugin-react-hooks/exhaustive-deps</code> 的 lint 规则</a>（请确保在项目中使用它）会对此情况发出警告。</p>
<h3 id="consistent-errors-for-returning-undefined"><a href="#consistent-errors-for-returning-undefined" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>返回一致的 undefined 错误 </h3>
<p>在 React 16 及更早版本中，返回 <code class="gatsby-code-text">undefined</code> 始终是一个错误：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Button</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Error: Nothing was returned from render</span>
<span class="token punctuation">}</span></code></pre></div>
<p>部分原因是这很容易无意间返回 <code class="gatsby-code-text">undefined</code>：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Button</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// We forgot to write return, so this component returns undefined.</span>
  <span class="token comment">// React surfaces this as an error instead of ignoring it.</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>以前，React 只对 class 和函数组件执行此操作，但并不会检查 <code class="gatsby-code-text">forwardRef</code> 和 <code class="gatsby-code-text">memo</code> 组件的返回值。这是由于编码错误导致。</p>
<p><strong>在 React 17 中，<code class="gatsby-code-text">forwardRef</code> 和 <code class="gatsby-code-text">memo</code> 组件的行为会与常规函数组件和 class 组件保持一致。在返回 <code class="gatsby-code-text">undefined</code> 时会报错</strong></p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">let</span> Button <span class="token operator">=</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// We forgot to write return, so this component returns undefined.</span>
  <span class="token comment">// React 17 surfaces this as an error instead of ignoring it.</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> Button <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// We forgot to write return, so this component returns undefined.</span>
  <span class="token comment">// React 17 surfaces this as an error instead of ignoring it.</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>对于不想进行任何渲染的情况，请返回 <code class="gatsby-code-text">null</code>。</p>
<h3 id="native-component-stacks"><a href="#native-component-stacks" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原生组件栈 </h3>
<p>当你在浏览器中遇到错误时，浏览器会为你提供带有 JavaScript 函数的名称及位置的调用栈信息。然而，JavaScript 调用栈通常不足以诊断问题，因为 React 树的层次结构可能同样重要。你不仅要知道哪个 <code class="gatsby-code-text">Buttom</code> 抛出了错误，而且还想知道 <code class="gatsby-code-text">Button</code> 在 React 树中的哪个位置。</p>
<p>为了解决这个问题，当你遇到错误时，从 React 16 开始会打印 “组件栈” 信息。尽管如此，它们仍然不如原生的 JavaScript 调用栈。特别是，它们在控制台中不可点击，因为 React 不知道函数在源代码中的声明位置。此外，它们在生产中<a href="https://github.com/facebook/react/issues/12757" target="_blank" rel="nofollow noopener noreferrer">几乎无用</a>。不同于常规压缩后的 JavaScript 调用栈，它们可以通过 sourcemap 的形式自动恢复到原始函数的位置，而使用  React 组件栈，在生产环境下必须在调用栈信息和 bundle 大小间进行选择。</p>
<p><strong>在 React 17 中，使用了不同的机制生成组件调用栈，该机制会将它们与常规的原生 JavaScript 调用栈缝合在一起。这使得你可以在生产环境中获得完全符号化的 React 组件调用栈信息。</strong></p>
<p>React 实现这一点的方式有点非常规。目前，浏览器无法提供获取函数调用栈框架（源文件和位置）的方法。因此，当 React 捕获到错误时，将通过组件上述组件内部抛出的临时错误（并捕获）来重建其组件调用栈信息。这会增加崩溃时的性能损失，但每个组件类型只会发生一次。</p>
<p>如果你对此感兴趣，可以在<a href="https://github.com/facebook/react/pull/18561" target="_blank" rel="nofollow noopener noreferrer">这个 PR</a> 中阅读更多详细信息，但是在大多数情况下，这种机制不会影响你的代码。从使用者的角度来看，新功能就是可以单击组件调用栈（因为它们依赖于本机浏览器调用栈框架），并且可以像常规 JavaScript 错误那样在生产中进行解码。</p>
<p>构成重大变化的部分是，要使此功能正常工作，React 将在捕获错误后在调用栈中重新执行上面某些函数和某些 class 构造函数的部分。由于渲染函数和 class 构造函数不应具有副作用（这对于 SSR 也很重要），因此这不会造成任何实际问题。</p>
<h3 id="removing-private-exports"><a href="#removing-private-exports" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移除私有导出 </h3>
<p>最后，值得注意的重大变化时我们删除了一些以前暴露给其他项目的 React 内部组件。特别是，<a href="https://github.com/necolas/react-native-web" target="_blank" rel="nofollow noopener noreferrer">React Native for Web</a> 过去常常依赖于事件系统的某些内部组件，但这种依赖关系很脆弱且经常被破坏。</p>
<p><strong>在 React 17 中，这些私有导出已被移除。据我们所知，React Native for Web 是唯一使用它们的项目，它们已经完成了向不依赖那些私有导出函数的其他方法迁移。</strong></p>
<p>这意味着旧版本的 React Native for Web 不会与 React 17 兼容，但是新版本可以使用它。实际上，并没有太大的变化，因为 React Native for Web 必须发布新版本以适应其内部 React 的变化。</p>
<p>另外，我们删除了 <code class="gatsby-code-text">ReactTestUtils.SimulateNative</code> 的 helper 方法。他们从未被记录，没有按照他们名字所暗示的那样去做，也没有处理我们对事件系统所做的更改。如果你想要一种简便的方式来触发测试中原生浏览器的事件，请改用 <a href="https://testing-library.com/docs/dom-testing-library/api-events" target="_blank" rel="nofollow noopener noreferrer">React Testing Library</a>。</p>
<h2 id="installation"><a href="#installation" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 </h2>
<p>我们鼓励你尽快尝试 React 17.0 RC 版本，在迁移过程中遇到任何问题都可以向我们<a href="https://github.com/facebook/react/issues" target="_blank" rel="nofollow noopener noreferrer">提出</a>。<strong>请注意，候选版本没有稳定版本稳定，因此请不要将其部署到生产环境。</strong></p>
<p>通过 npm 安装 React 17 RC 版，请执行：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token function">npm</span> <span class="token function">install</span> react@17.0.0-rc.1 react-dom@17.0.0-rc.1</code></pre></div>
<p>通过 yarn 安装 React 17 RC 版，请执行：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token function">yarn</span> <span class="token function">add</span> react@17.0.0-rc.1 react-dom@17.0.0-rc.1</code></pre></div>
<p>我们还通过 CDN 提供了 React RC 的 UMD 构建版本：</p>
<div class="gatsby-highlight" data-language="html"><pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react@17.0.0-rc.1/umd/react.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@17.0.0-rc.1/umd/react-dom.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>有关<a href="/docs/installation.html">详细安装说明</a>，请参阅文档。</p>
<h2 id="changelog"><a href="#changelog" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Changelog </h2>
<h3 id="react"><a href="#react" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React </h3>
<ul>
<li>为全新的 <a href="https://babeljs.io/blog/2020/03/16/7.9.0#a-new-jsx-transform-11154-https-githubcom-babel-babel-pull-11154" target="_blank" rel="nofollow noopener noreferrer">JSX 转换器</a>添加 <code class="gatsby-code-text">react/jsx-runtime</code> 和 <code class="gatsby-code-text">react/jsx-dev-runtime</code>。（<a href="https://github.com/lunaruan" target="_blank" rel="nofollow noopener noreferrer">@lunaruan</a> 提交于 <a href="https://github.com/facebook/react/pull/18299" target="_blank" rel="nofollow noopener noreferrer">#18299</a>）</li>
<li>根据原生框架构建组件调用栈。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18561" target="_blank" rel="nofollow noopener noreferrer">#18561</a>）</li>
<li>可以在 context 中设置 <code class="gatsby-code-text">displayName</code> 以改善调用栈信息。（<a href="https://github.com/eps1lon" target="_blank" rel="nofollow noopener noreferrer">@eps1lon</a> 提交于 <a href="https://github.com/facebook/react/pull/18224" target="_blank" rel="nofollow noopener noreferrer">#18224</a>）</li>
<li>防止 <code class="gatsby-code-text">&#39;use strict&#39;</code> 从 UMD 的 bundles 中泄露。（<a href="https://github.com/koba04" target="_blank" rel="nofollow noopener noreferrer">@koba04</a> 提交于 <a href="https://github.com/facebook/react/pull/19614" target="_blank" rel="nofollow noopener noreferrer">#19614</a>）</li>
<li>停止使用 <code class="gatsby-code-text">fb.me</code> 进行重定向。（<a href="https://github.com/cylim" target="_blank" rel="nofollow noopener noreferrer">@cylim</a> 提交于 <a href="https://github.com/facebook/react/pull/19598" target="_blank" rel="nofollow noopener noreferrer">#19598</a>）</li>
</ul>
<h3 id="react-dom"><a href="#react-dom" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React DOM </h3>
<ul>
<li>将事件委托从 <code class="gatsby-code-text">document</code> 切换为 root。（<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> 提交于 <a href="https://github.com/facebook/react/pull/18195" target="_blank" rel="nofollow noopener noreferrer">#18195</a> 及<a href="https://github.com/facebook/react/pulls?q=is%3Apr+author%3Atrueadm+modern+event+is%3Amerged" target="_blank" rel="nofollow noopener noreferrer">其他</a>）</li>
<li>在运行下一个副作用前，请清理所有副作用。（<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> 提交于 <a href="https://github.com/facebook/react/pull/17947" target="_blank" rel="nofollow noopener noreferrer">#17947</a>）</li>
<li>异步运行 <code class="gatsby-code-text">useEffect</code> 清理函数。（<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> 提交于 <a href="https://github.com/facebook/react/pull/17925" target="_blank" rel="nofollow noopener noreferrer">#17925</a>）</li>
<li>使用浏览器的 <code class="gatsby-code-text">focusin</code> 和 <code class="gatsby-code-text">focusout</code> 替换 <code class="gatsby-code-text">onFocus</code> 和 <code class="gatsby-code-text">onBlur</code> 的底层实现。（<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> 提交于 <a href="https://github.com/facebook/react/pull/19186" target="_blank" rel="nofollow noopener noreferrer">#19186</a>）</li>
<li>将所有 <code class="gatsby-code-text">Capture</code> 事件都使用浏览器的捕获阶段实现。（<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> 提交于 <a href="https://github.com/facebook/react/pull/19221" target="_blank" rel="nofollow noopener noreferrer">#19221</a>）</li>
<li>禁止在 <code class="gatsby-code-text">onScroll</code> 事件时冒泡。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/19464" target="_blank" rel="nofollow noopener noreferrer">#19464</a>)</li>
<li>如果 <code class="gatsby-code-text">forwardRef</code> 或 <code class="gatsby-code-text">memo</code> 组件的返回值为 <code class="gatsby-code-text">undefined</code>，则抛出异常。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/19550" target="_blank" rel="nofollow noopener noreferrer">#19550</a>）</li>
<li>移除事件池。（<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> 提交于 <a href="https://github.com/facebook/react/pull/18969" target="_blank" rel="nofollow noopener noreferrer">#18969</a>）</li>
<li>移除 React Native Web 不需要的内部组件。（<a href="https://github.com/necolas" target="_blank" rel="nofollow noopener noreferrer">@necolas</a> 提交于 <a href="https://github.com/facebook/react/pull/18483" target="_blank" rel="nofollow noopener noreferrer">#18483</a>)</li>
<li>当挂载 root 时，附加所有已知的事件监听器。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/19659" target="_blank" rel="nofollow noopener noreferrer">#19659</a>）</li>
<li>在 Dev 模式下，禁用第二次渲染过程中的 <code class="gatsby-code-text">console</code>。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18547" target="_blank" rel="nofollow noopener noreferrer">#18547</a>）</li>
<li>弃用为记录且具有误导性的 <code class="gatsby-code-text">ReactTestUtils.SimulateNative</code> API。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/13407" target="_blank" rel="nofollow noopener noreferrer">#13407</a>)</li>
<li>重命名内部使用的私有字段（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/18377" target="_blank" rel="nofollow noopener noreferrer">#18377</a>）</li>
<li>不在开发环境调用 User Timing API。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/18417" target="_blank" rel="nofollow noopener noreferrer">#18417</a>）</li>
<li>在严格模式下重复渲染期间禁用 console。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18547" target="_blank" rel="nofollow noopener noreferrer">#18547</a>）</li>
<li>在严格模式下，二次渲染组件也不使用 Hook。（<a href="https://github.com/eps1lon" target="_blank" rel="nofollow noopener noreferrer">@eps1lon</a> 提交于 <a href="https://github.com/facebook/react/pull/18430" target="_blank" rel="nofollow noopener noreferrer">#18430</a>）</li>
<li>允许在生命周期函数中调用 <code class="gatsby-code-text">ReactDOM.flushSync</code>（但会发出警告）。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18759" target="_blank" rel="nofollow noopener noreferrer">#18759</a>）</li>
<li>将 <code class="gatsby-code-text">code</code> 属性添加到键盘事件对象中。（<a href="https://github.com/bl00mber" target="_blank" rel="nofollow noopener noreferrer">@bl00mber</a> 提交于 <a href="https://github.com/facebook/react/pull/18287" target="_blank" rel="nofollow noopener noreferrer">#18287</a>）</li>
<li>为 <code class="gatsby-code-text">video</code> 元素添加 <code class="gatsby-code-text">disableRemotePlayback</code> 属性。（<a href="https://github.com/tombrowndev" target="_blank" rel="nofollow noopener noreferrer">@tombrowndev</a> 提交于 <a href="https://github.com/facebook/react/pull/18619" target="_blank" rel="nofollow noopener noreferrer">#18619</a>）</li>
<li>为 <code class="gatsby-code-text">input</code> 元素添加 <code class="gatsby-code-text">enterKeyHint</code> 属性。（<a href="https://github.com/eps1lon" target="_blank" rel="nofollow noopener noreferrer">@eps1lon</a> 提交于 <a href="https://github.com/facebook/react/pull/18634" target="_blank" rel="nofollow noopener noreferrer">#18634</a>）</li>
<li>当没有给 <code class="gatsby-code-text">&lt;Context.Provider&gt;</code> 提供任何值时，会发出警告。（<a href="https://github.com/charlie1404" target="_blank" rel="nofollow noopener noreferrer">@charlie1404</a> 提交于 <a href="https://github.com/facebook/react/pull/19054" target="_blank" rel="nofollow noopener noreferrer">#19054</a>）</li>
<li>如果 <code class="gatsby-code-text">forwardRef</code> 或 <code class="gatsby-code-text">memo</code> 组件的返回值为 <code class="gatsby-code-text">undefined</code>，则抛出警告。（<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> 提交于 <a href="https://github.com/facebook/react/pull/19550" target="_blank" rel="nofollow noopener noreferrer">#19550</a>）</li>
<li>为无效更新改进错误信息。（<a href="https://github.com/JoviDeCroock" target="_blank" rel="nofollow noopener noreferrer">@JoviDeCroock</a> 提交于 <a href="https://github.com/facebook/react/pull/18316" target="_blank" rel="nofollow noopener noreferrer">#18316</a>）</li>
<li>从调用栈信息中忽略 forwardRef 和 memo。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18559" target="_blank" rel="nofollow noopener noreferrer">#18559</a>）</li>
<li>在受控输入与非受控输入间切换时，改善错误消息。（<a href="https://github.com/vcarl" target="_blank" rel="nofollow noopener noreferrer">@vcarl</a> 提交于 <a href="https://github.com/facebook/react/pull/17070" target="_blank" rel="nofollow noopener noreferrer">#17070</a>）</li>
<li>保持 <code class="gatsby-code-text">onTouchStart</code>、<code class="gatsby-code-text">onTouchMove</code> 和 <code class="gatsby-code-text">onWheel</code> 默认为 passive。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/19654" target="_blank" rel="nofollow noopener noreferrer">#19654</a>）</li>
<li>修复在 development 模式下 iframe 关闭时，<code class="gatsby-code-text">setState</code> 挂起的问题。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/19220" target="_blank" rel="nofollow noopener noreferrer">#19220</a>）</li>
<li>使用 <code class="gatsby-code-text">defaultProps</code> 修复拉架子组件在渲染时的问题。（<a href="https://github.com/jddxf" target="_blank" rel="nofollow noopener noreferrer">@jddxf</a> 提交于 <a href="https://github.com/facebook/react/pull/18539" target="_blank" rel="nofollow noopener noreferrer">#18539</a>）</li>
<li>修复当 <code class="gatsby-code-text">dangerouslySetInnerHTML</code> 为 <code class="gatsby-code-text">undefined</code> 时，误报警告的问题。（<a href="https://github.com/eps1lon" target="_blank" rel="nofollow noopener noreferrer">@eps1lon</a> 提交于 <a href="https://github.com/facebook/react/pull/18676" target="_blank" rel="nofollow noopener noreferrer">#18676</a>）</li>
<li>使用费标准的 <code class="gatsby-code-text">require</code> 实现来修复 Test Utils。（<a href="https://github.com/just-boris" target="_blank" rel="nofollow noopener noreferrer">@just-boris</a> 提交于 <a href="https://github.com/facebook/react/pull/18632" target="_blank" rel="nofollow noopener noreferrer">#18632</a>）</li>
<li>修复 <code class="gatsby-code-text">onBeforeInput</code> 报告错误的 <code class="gatsby-code-text">event.type</code>。（<a href="https://github.com/eps1lon" target="_blank" rel="nofollow noopener noreferrer">@eps1lon</a> 提交于 <a href="https://github.com/facebook/react/pull/19561" target="_blank" rel="nofollow noopener noreferrer">#19561</a>）</li>
<li>修复 Firefox 中 <code class="gatsby-code-text">event.relatedTarget</code> 输出为 <code class="gatsby-code-text">undefined</code> 的问题。（<a href="https://github.com/claytercek" target="_blank" rel="nofollow noopener noreferrer">@claytercek</a> 提交于 <a href="https://github.com/facebook/react/pull/19607" target="_blank" rel="nofollow noopener noreferrer">#19607</a>）</li>
<li>修复 IE11 中 “unspecified error” 的问题。（<a href="https://github.com/hemakshis" target="_blank" rel="nofollow noopener noreferrer">@hemakshis</a> 提交于 <a href="https://github.com/facebook/react/pull/19664" target="_blank" rel="nofollow noopener noreferrer">#19664</a>）</li>
<li>修复 shadow root 中的渲染问题。（<a href="https://github.com/Jack-Works" target="_blank" rel="nofollow noopener noreferrer">@Jack-Works</a> 提交于 <a href="https://github.com/facebook/react/pull/15894" target="_blank" rel="nofollow noopener noreferrer">#15894</a>）</li>
<li>使用事件捕获修复 <code class="gatsby-code-text">movementX/Y</code> polyfill 的问题。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/19672" target="_blank" rel="nofollow noopener noreferrer">#19672</a>）</li>
<li>使用委托处理 <code class="gatsby-code-text">onSubmit</code> 和 <code class="gatsby-code-text">onReset</code> 事件。（<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> 提交于 <a href="https://github.com/facebook/react/pull/19333" target="_blank" rel="nofollow noopener noreferrer">#19333</a>）</li>
<li>提高内存使用率。（<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> 提交于 <a href="https://github.com/facebook/react/pull/18970" target="_blank" rel="nofollow noopener noreferrer">#18970</a>）</li>
</ul>
<h3 id="react-dom-server"><a href="#react-dom-server" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React DOM Server </h3>
<ul>
<li>使用服务端渲染的 <code class="gatsby-code-text">useCallback</code> 与 <code class="gatsby-code-text">useMemo</code> 一致。（<a href="https://github.com/alexmckenley" target="_blank" rel="nofollow noopener noreferrer">@alexmckenley</a>提交于 <a href="https://github.com/facebook/react/pull/18783" target="_blank" rel="nofollow noopener noreferrer">#18783</a>）</li>
<li>修复函数组件抛出异常时状态泄露的问题。（<a href="https://github.com/pmaccart" target="_blank" rel="nofollow noopener noreferrer">@pmaccart</a> 提交于 <a href="https://github.com/facebook/react/pull/19212" target="_blank" rel="nofollow noopener noreferrer">#19212</a>）</li>
</ul>
<h3 id="react-test-renderer"><a href="#react-test-renderer" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React Test Renderer </h3>
<ul>
<li>改善 <code class="gatsby-code-text">findByType</code> 错误信息。（<a href="https://github.com/henryqdineen" target="_blank" rel="nofollow noopener noreferrer">@henryqdineen</a> 提交于 <a href="https://github.com/facebook/react/pull/17439" target="_blank" rel="nofollow noopener noreferrer">#17439</a>）</li>
</ul>
<h3 id="concurrent-mode-experimental"><a href="#concurrent-mode-experimental" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Concurrent Mode（实验阶段） </h3>
<ul>
<li>改进启发式更新算法。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18796" target="_blank" rel="nofollow noopener noreferrer">#18796</a>）</li>
<li>在实现性 API 前添加 <code class="gatsby-code-text">unstable_</code> 前缀。 (<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18825" target="_blank" rel="nofollow noopener noreferrer">#18825</a>)</li>
<li>移除 <code class="gatsby-code-text">unstable_discreteUpdates</code> 和 <code class="gatsby-code-text">unstable_flushDiscreteUpdates</code>。（<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> 提交于 <a href="https://github.com/facebook/react/pull/18825" target="_blank" rel="nofollow noopener noreferrer">#18825</a>）</li>
<li>移除了 <code class="gatsby-code-text">timeoutMs</code> 参数。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/19703" target="_blank" rel="nofollow noopener noreferrer">#19703</a>）</li>
<li>禁用 <code class="gatsby-code-text">&lt;div hidden /&gt;</code> 预渲染，以支持未来的 API。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18917" target="_blank" rel="nofollow noopener noreferrer">#18917</a>）</li>
<li>添加了一个实现性的 <code class="gatsby-code-text">unstable_useOpaqueIdentifier</code> Hook。（<a href="https://github.com/lunaruan" target="_blank" rel="nofollow noopener noreferrer">@lunaruan</a> 提交于 <a href="https://github.com/facebook/react/pull/17322" target="_blank" rel="nofollow noopener noreferrer">#17322</a>）</li>
<li>添加了一个实验性的 <code class="gatsby-code-text">unstable_startTransition</code> API. (<a href="https://github.com/rickhanlonii" target="_blank" rel="nofollow noopener noreferrer">@rickhanlonii</a> 提交于 <a href="https://github.com/facebook/react/pull/19696" target="_blank" rel="nofollow noopener noreferrer">#19696</a>)</li>
<li>在测试渲染器中使用 <code class="gatsby-code-text">act</code> 后，不在刷新 Suspense 的 fallback。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18596" target="_blank" rel="nofollow noopener noreferrer">#18596</a>）</li>
<li>将全局渲染的 timeout 用于 CPU Suspense。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/19643" target="_blank" rel="nofollow noopener noreferrer">#19643</a>）</li>
<li>挂载前，清除现有根目录的内容。（<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> 提交于 <a href="https://github.com/facebook/react/pull/18730" target="_blank" rel="nofollow noopener noreferrer">#18730</a>）</li>
<li>修复带有错误边界的 bug。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18265" target="_blank" rel="nofollow noopener noreferrer">#18265</a>）</li>
<li>修复了导致挂起树更新丢失的 bug。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18384" target="_blank" rel="nofollow noopener noreferrer">#18384</a> 以及 <a href="https://github.com/facebook/react/pull/18457" target="_blank" rel="nofollow noopener noreferrer">#18457</a>）</li>
<li>修复导致渲染阶段更新丢失的 bug。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18537" target="_blank" rel="nofollow noopener noreferrer">#18537</a>）</li>
<li>修复 SuspenseList 的 bug。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18412" target="_blank" rel="nofollow noopener noreferrer">#18412</a>）</li>
<li>修复导致 Suspense fallback 过早显示的 bug。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18411" target="_blank" rel="nofollow noopener noreferrer">#18411</a>）</li>
<li>修复 SuspenseList 中使用 class 组件异常的 bug。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18448" target="_blank" rel="nofollow noopener noreferrer">#18448</a>）</li>
<li>修复输入内容可能被更新被丢弃的 bug。（<a href="https://github.com/jddxf" target="_blank" rel="nofollow noopener noreferrer">@jddxf</a> 提交于 <a href="https://github.com/facebook/react/pull/18515" target="_blank" rel="nofollow noopener noreferrer">#18515</a> 以及 <a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18535" target="_blank" rel="nofollow noopener noreferrer">#18535</a>）</li>
<li>修复暂挂 Suspense fallback 后卡住的错误。（<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> 提交于 <a href="https://github.com/facebook/react/pull/18663" target="_blank" rel="nofollow noopener noreferrer">#18663</a>）</li>
<li>如果 hydrate 中，不要切断 SuspenseList 的尾部。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18854" target="_blank" rel="nofollow noopener noreferrer">#18854</a>）</li>
<li>修复 <code class="gatsby-code-text">useMutableSource</code> 中的 bug，此 bug 可能在 <code class="gatsby-code-text">getSnapshot</code> 更改时出现。（<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> 提交于 <a href="https://github.com/facebook/react/pull/18297" target="_blank" rel="nofollow noopener noreferrer">#18297</a>）</li>
<li>修复 <code class="gatsby-code-text">useMutableSource</code> 令人恶心的 bug。（<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> 提交于 <a href="https://github.com/facebook/react/pull/18912" target="_blank" rel="nofollow noopener noreferrer">#18912</a>）</li>
<li>如果外部渲染且提交之前调用 <code class="gatsby-code-text">setState</code>，会发出警告。（<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> 提交于 <a href="https://github.com/facebook/react/pull/18838" target="_blank" rel="nofollow noopener noreferrer">#18838</a>）</li>
</ul>]]></description><link>https://zh-hans.reactjs.org/blog/2020/08/10/react-v17-rc.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2020/08/10/react-v17-rc.html</guid><pubDate>Mon, 10 Aug 2020 00:00:00 GMT</pubDate></item><item><title><![CDATA[React Hook 最佳实践]]></title><description><![CDATA[<p><img src="https://p1.music.126.net/ONBvYa_yYg6QWEEn9KmWoQ==/109951164867829503.jpg"></p>
<blockquote>
<p>本文发布自 <a href="https://github.com/x-orpheus" target="_blank" rel="nofollow noopener noreferrer">网易云音乐前端团队</a>，文章未经授权禁止任何形式的转载。团队持续招人中，如果你恰好准备换工作，又恰好喜欢云音乐，那就 <a href="mailto:grp.music-fe@corp.netease.com" target="_blank" rel="nofollow noopener noreferrer">加入我们</a>！</p>
</blockquote>
<h2 id="写在前面"><a href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>写在前面</h2>
<p>在过去的几个月里，React Hooks 在我们的项目中得到了充分利用。在实际使用过程中，我发现 React Hooks 除了带来简洁的代码外，也存在对其使用不当的情况。</p>
<p>在这篇文章中，我想总结我过去几个月来对 React Hooks 使用，分享我对它的看法以及我认为的最佳实践，供大家参考。</p>
<p>本文假定读者已经对 React-Hooks 及其使用方式有了初步的了解。您可以通过 <a href="/docs/hooks-intro.html">官方文档</a> 进行学习。</p>
<h2 id="函数式组件"><a href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数式组件</h2>
<p>简而言之，就是在一个函数中返回 React Element。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> title <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>一般的，该函数接收唯一的参数：props 对象。从该对象中，我们可以读取到数据，并通过计算产生新的数据，最后返回 React Elements 以交给 React 进行渲染。此外也可以选择在函数中执行副作用。</p>
<p>在本文中，我们给函数式组件的函数起个简单一点的名字：render 函数。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> appElement <span class="token operator">=</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"XXX"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
    appElement<span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>在上方的代码中，我们自行调用了 render 函数以期执行渲染。然而这在 React 中不是正常的操作。</p>
<p>正常操作是像下方这样的代码：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// React.createElement(App, {</span>
<span class="token comment">//     title: "XXX"</span>
<span class="token comment">// });</span>
<span class="token keyword">const</span> appElement <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>XXX<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
    appElement<span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>在 React 内部，它会决定在何时调用 render 函数，并对返回的 React Elements 进行遍历，如果遇到函数组件，React 便会继续调用这个函数组件。在这个过程中，可以由父组件通过 props 将数据传递到该子组件中。最终 React 会调用完所有的组件，从而知晓如何进行渲染。</p>
<p>这种把 render 函数交给 React 内部处理的机制，为引入状态带来了可能。</p>
<p>在本文中，为了方便描述，对于 render 函数的每次调用，我想称它为一帧。</p>
<h2 id="每一帧拥有独立的变量"><a href="#%E6%AF%8F%E4%B8%80%E5%B8%A7%E6%8B%A5%E6%9C%89%E7%8B%AC%E7%AB%8B%E7%9A%84%E5%8F%98%E9%87%8F" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>每一帧拥有独立的变量</h2>
<p>在引入状态之前，我们需要明白这一点。</p>
<p>我们通过 <em>例一</em> 进行观察：</p>
<p><a href="https://codesandbox.io/s/serverless-microservice-35z1y?fontsize=14&#x26;hidenavigation=1&#x26;module=%2Fsrc%2FExample.js&#x26;theme=dark" target="_blank" rel="nofollow noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit 1. 每一帧拥有独立的变量"></a></p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Alert Count</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>重点关注 <code class="gatsby-code-text">&lt;Example&gt;</code> 函数组件的代码，其中的 <code class="gatsby-code-text">count</code> 属性由父组件传入，初始值为 0，每隔一秒增加 1。点击 “Alert Count” 按钮，将延迟 3 秒钟弹出 <code class="gatsby-code-text">count</code> 的值。操作后发现，弹窗中出现的值，与页面中文本展示的值不同，而是等于点击 “alert Count” 按钮时 <code class="gatsby-code-text">count</code> 的值。</p>
<p>如果更换为 class 组件，它的实现是 <code class="gatsby-code-text">&lt;Example2&gt;</code> 这样的：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">Example2</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">Example2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Alert Count</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>此时，点击 “Alert Count” 按钮，延迟 3 秒钟弹出 <code class="gatsby-code-text">count</code> 的值，与页面中文本展示的值是一样的。</p>
<p>在某些情况下，<code class="gatsby-code-text">&lt;Example&gt;</code> 函数组件中的行为才符合预期。如果将 <code class="gatsby-code-text">setTimeout</code> 类比到一次 Fetch 请求，在请求成功时，我要获取的是发起 Fetch 请求前相关的数据，并对其进行修改。</p>
<p>如何理解其中的差异呢？</p>
<p>在 <code class="gatsby-code-text">&lt;Example2&gt;</code> class 组件中，我们是从 <code class="gatsby-code-text">this</code> 中获取到的 <code class="gatsby-code-text">props.count</code>。<code class="gatsby-code-text">this</code> 是固定指向同一个组件实例的。在 3 秒的延时器生效后，组件重新进行了渲染，<code class="gatsby-code-text">this.props</code> 也发生了改变。当延时的回调函数执行时，读取到的 <code class="gatsby-code-text">this.props</code> 是当前组件最新的属性值。</p>
<p>而在 <code class="gatsby-code-text">&lt;Example&gt;</code> 函数组件中，每一次执行 render 函数时，<code class="gatsby-code-text">props</code> 作为该函数的参数传入，它是函数作用域下的变量。</p>
<p>当 <code class="gatsby-code-text">&lt;Example&gt;</code> 组件被创建，将运行类似这样的代码来完成第一帧：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> props_0 <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">handleClick_0</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>props_0<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">Example</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props_0<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick_0<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">alert Count</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>当父组件传入的 count 变为 1，React 会再次调用 <code class="gatsby-code-text">Example</code> 函数，执行第二帧，此时 <code class="gatsby-code-text">count</code> 是 <code class="gatsby-code-text">1</code>。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> props_1 <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">handleClick_1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>props_1<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">Example</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props_1<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick_1<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">alert Count</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>由于 <code class="gatsby-code-text">props</code> 是 <code class="gatsby-code-text">Example</code> 函数作用域下的变量，可以说对于这个函数的每一次调用中，都产生了新的 <code class="gatsby-code-text">props</code> 变量，它在声明时被赋予了当前的属性，他们相互间互不影响。</p>
<p>换一种说法，对于其中任一个 <code class="gatsby-code-text">props</code> ，其值在声明时便已经决定，不会随着时间产生变化。<code class="gatsby-code-text">handleClick</code> 函数亦是如此。例如定时器的回调函数是在未来发生的，但 <code class="gatsby-code-text">props.count</code> 的值是在声明 <code class="gatsby-code-text">handleClick</code> 函数时就已经决定好的。</p>
<p>如果我们在函数开头使用解构赋值，<code class="gatsby-code-text">const { count } = props</code>，之后直接使用 <code class="gatsby-code-text">count</code>，和上面的情况没有区别。</p>
<h2 id="状态"><a href="#%E7%8A%B6%E6%80%81" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态</h2>
<p>可以简单的认为，在某个组件中，对于返回的 React Elements 树形结构，某个位置的 element ，其类型与 key 属性均不变，React 便会选择重用该组件实例；否则，比如从 <code class="gatsby-code-text">&lt;A/&gt;</code> 组件切换到了 <code class="gatsby-code-text">&lt;B/&gt;</code> 组件，会销毁 A，然后重建 B，B 此时会执行第一帧。</p>
<p>在实例中，可以通过 <code class="gatsby-code-text">useState</code> 等方式拥有局部状态。在重用的过程中，这些状态会得到保留。而如果无法重用，状态会被销毁。</p>
<p>例如 <code class="gatsby-code-text">useState</code>，为当前的函数组件创建了一个状态，这个状态的值独立于函数存放。 <code class="gatsby-code-text">useState</code> 会返回一个数组，在该数组中，得到该状态的值和更新该状态的方法。通过解构，该状态的值会赋值到当前 render 函数作用域下的一个常量 <code class="gatsby-code-text">state</code> 中。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>当组件被创建而不是重用时，即在组件的第一帧中，该状态将被赋予初始值 <code class="gatsby-code-text">initialState</code>，而之后的重用过程中，不会被重复赋予初始值。</p>
<p>通过调用 <code class="gatsby-code-text">setState</code> ，可以更新状态的值。</p>
<h2 id="每一帧拥有独立的状态"><a href="#%E6%AF%8F%E4%B8%80%E5%B8%A7%E6%8B%A5%E6%9C%89%E7%8B%AC%E7%AB%8B%E7%9A%84%E7%8A%B6%E6%80%81" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>每一帧拥有独立的状态</h2>
<p>需要明确的是，<code class="gatsby-code-text">state</code> 作为函数中的一个常量，就是普通的数据，并不存在诸如数据绑定这样的操作来驱使 DOM 发生更新。在调用 <code class="gatsby-code-text">setState</code> 后，React 将重新执行 render 函数，仅此而已。</p>
<p>因此，状态也是函数作用域下的普通变量。我们可以说每次函数执行拥有独立的状态。</p>
<p>为了加深印象，我们来看 <em>例二</em>，它是 React 官网某个例子的复杂化：</p>
<p><a href="https://codesandbox.io/s/hardcore-fast-66u24?fontsize=14&#x26;hidenavigation=1&#x26;theme=dark" target="_blank" rel="nofollow noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit 每一帧拥有独立的状态"></a></p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Example2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                setCount
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                Delay setCount
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在第一帧中，<code class="gatsby-code-text">p</code> 标签中的文本为 0。点击 “Delay setCount”，文本依然为 0。随后在 3 秒内连续点击 “setCount” 两次，将会分别执行第二帧和第三帧。你将看到 <code class="gatsby-code-text">p</code> 标签中的文本由 0 变化为 1, 2。但在点击 “Delay setCount” 3 秒后，文本重新变为 1。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// 第一帧</span>
<span class="token keyword">const</span> count_1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">handleClick_1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">delayAction_1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setCount</span><span class="token punctuation">(</span>count_1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>delayAction_1<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//...</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick_1<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
//...

// 点击 "setCount" 后第二帧
const count_2 = 1;

const handleClick_2 = () => </span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">delayAction_2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setCount</span><span class="token punctuation">(</span>count_2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>delayAction_2<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;

//...
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick_2<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
//...

// 再次点击 "setCount" 后第三帧
const count_3 = 2;

const handleClick_3 = () => </span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">delayAction_3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setCount</span><span class="token punctuation">(</span>count_3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>delayAction_3<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;

//...
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick_3<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
//...</span></code></pre></div>
<p><code class="gatsby-code-text">count</code>，<code class="gatsby-code-text">handleClick</code> 都是 <code class="gatsby-code-text">Example2</code> 函数作用域中的常量。在点击 “Delay setCount” 时，定时器设置 3000ms 到期后的执行函数为 <code class="gatsby-code-text">delayAction_1</code>，函数中读取 <code class="gatsby-code-text">count_1</code> 常量的值是 0，这和第二帧的 <code class="gatsby-code-text">count_2</code> 无关。</p>
<h2 id="获取过去或未来帧中的值"><a href="#%E8%8E%B7%E5%8F%96%E8%BF%87%E5%8E%BB%E6%88%96%E6%9C%AA%E6%9D%A5%E5%B8%A7%E4%B8%AD%E7%9A%84%E5%80%BC" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取过去或未来帧中的值</h2>
<p>对于 state，如果想要在第一帧时点击 “Delay setCount” ，在一个异步回调函数的执行中，获取到 <code class="gatsby-code-text">count</code> 最新一帧中的值，不妨向 <code class="gatsby-code-text">setCount</code> <a href="https://reactjs.org/docs/hooks-reference.html#functional-updates" target="_blank" rel="nofollow noopener noreferrer">传入函数作为参数</a>。</p>
<p>其他情况下，例如需要读取到 state 及其衍生的某个常量，相对于变量声明时所在帧过去或未来的值，就需要使用 <code class="gatsby-code-text">useRef</code>，通过它来拥有一个在所有帧中共享的变量。</p>
<p>如果要与 class 组件进行比较，<code class="gatsby-code-text">useRef</code> 的作用相对于让你在 class 组件的 <code class="gatsby-code-text">this</code> 上追加属性。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> refContainer <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>在组件的第一帧中，<code class="gatsby-code-text">refContainer.current</code> 将被赋予初始值 <code class="gatsby-code-text">initialValue</code>，之后便不再发生变化。但你可以自己去设置它的值。设置它的值不会重新触发 render 函数。</p>
<p>例如，我们把第 n 帧的某个 props 或者 state 通过 <code class="gatsby-code-text">useRef</code> 进行保存，在第 n + 1 帧可以读取到过去的，第 n 帧中的值。我们也可以在第 n + 1 帧使用 ref 保存某个 props 或者 state，然后在第 n 帧中声明的异步回调函数中读取到它。</p>
<p>对 <em>例二</em> 进行修改，得到 <em>例三</em>，看看具体的效果：</p>
<p><a href="https://codesandbox.io/s/recursing-dan-b1syo?fontsize=14&#x26;hidenavigation=1&#x26;theme=dark" target="_blank" rel="nofollow noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit 获取过去或未来帧中的值
"></a></p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> currentCount <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    currentCount<span class="token punctuation">.</span>current <span class="token operator">=</span> count<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">setCount</span><span class="token punctuation">(</span>currentCount<span class="token punctuation">.</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                setCount
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                Delay setCount
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在 <code class="gatsby-code-text">setCount</code> 后便会执行下一帧，在函数的开头，
<code class="gatsby-code-text">currentCount</code> 始终与最新的 <code class="gatsby-code-text">count</code> state 保持同步。因此，在 <code class="gatsby-code-text">setTimeout</code> 中可以通过此方法获取到回调函数执行时当前的 count 值。</p>
<p>接下来再通过 <em>例四</em> 了解如何获取过去帧中的值：</p>
<p><a href="https://codesandbox.io/s/snowy-voice-e4lyn?fontsize=14&#x26;hidenavigation=1&#x26;theme=dark" target="_blank" rel="nofollow noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit 获取过去帧中的值"></a></p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Example4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> prevCountRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevCount <span class="token operator">=</span> prevCountRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
    prevCountRef<span class="token punctuation">.</span>current <span class="token operator">=</span> count<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setCount</span><span class="token punctuation">(</span>prevCount <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">SetCount</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这段代码实现的功能是，count 初始值为 1，点击按钮后累加到 2，随后点击按钮，总是用当前 count 的值和前一个 count 的值进行累加，得到新的 count 的值。</p>
<p><code class="gatsby-code-text">prevCountRef</code> 在 render 函数执行的过程中，与最新的 <code class="gatsby-code-text">count</code> state 进行了同步。由于在同步前，我们将该 ref 保存到函数作用域下的另一个变量 <code class="gatsby-code-text">prevCount</code> 中，因此我们总是能够获取到前一个 count 的值。</p>
<p>同样的方法，我们可以用于保存任何值：某个 prop，某个 state 变量，甚至一个函数等。在后面的 Effects 部分，我们会继续使用 refs 为我们带来好处。</p>
<h2 id="每一帧可以拥有独立的-effects"><a href="#%E6%AF%8F%E4%B8%80%E5%B8%A7%E5%8F%AF%E4%BB%A5%E6%8B%A5%E6%9C%89%E7%8B%AC%E7%AB%8B%E7%9A%84-effects" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>每一帧可以拥有独立的 Effects</h2>
<p>如果弄清了前面的『每一帧拥有独立的变量』的概念，你会发现，若某个 useEffect/useLayoutEffect 有且仅有一个函数作为参数，那么每次 render 函数执行时该 Effects 也是独立的。因为它是在 render 函数中选择适当时机的执行。</p>
<p>对于 <code class="gatsby-code-text">useEffect</code> 来说，执行的时机是完成所有的 DOM 变更并让浏览器渲染页面后，而 <code class="gatsby-code-text">useLayoutEffect</code> 和 class 组件中 <code class="gatsby-code-text">componentDidMount</code>, <code class="gatsby-code-text">componentDidUpdate</code>一致——在 React 完成 DOM 更新后马上同步调用，会阻塞页面渲染。</p>
<p>如果 useEffect 没有传入第二个参数，那么第一个参数传入的 effect 函数在每次 render 函数执行是都是独立的。每个 effect 函数中捕获的 props 或 state 都来自于那一次的 render 函数。</p>
<p>我们可以再观察一个例子：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">You clicked </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token plain-text"> times</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                Click me
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在这个例子中，每一次对 <code class="gatsby-code-text">count</code> 进行改变，重新执行 render 函数后，延迟 3 秒打印 <code class="gatsby-code-text">count</code> 的值。</p>
<p>如果我们不停地点击按钮，打印的结果是什么呢？</p>
<p>我们发现经过延时后，每个 count 的值被依次打印了，他们从 0 开始依次递增，且不重复。</p>
<p>如果换成 class 组件，尝试使用 <code class="gatsby-code-text">componentDidUpdate</code> 去实现，会得到不一样的结果：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="gatsby-code-text">this.state.count</code> 总是指向最新的 <code class="gatsby-code-text">count</code> 值，而不是属于某次调用 render 函数时的值。</p>
<p>因此，在使用 useEffect 时，应当抛开在 class 组件中关于生命周期的思维。他们并不相同。在 useEffect 中刻意寻找那几个生命周期函数的替代写法，将会陷入僵局，无法充分发挥 useEffect 的能力。</p>
<h2 id="在比对中执行-effects"><a href="#%E5%9C%A8%E6%AF%94%E5%AF%B9%E4%B8%AD%E6%89%A7%E8%A1%8C-effects" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在比对中执行 Effects</h2>
<p>React 针对 React Elements 前后值进行对比，只去更新 DOM 真正发生改变的部分。对于 Effects，能否有类似这样的理念呢？</p>
<p>某个 Effects 函数一旦执行，函数内的副作用已经发生，React 无法猜测到函数相比于上一次做了哪些变化。但我们可以给 useEffect 传入第二个参数，作为依赖数组 (deps)，避免 Effects 不必要的重复调用。</p>
<p>这个 deps 的含义是：当前 Effect 依赖了哪些变量。</p>
<p>但有时问题不一定能解决。比如官网就有 <a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often" target="_blank" rel="nofollow noopener noreferrer">这样的例子</a>：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>如果我们频繁修改 <code class="gatsby-code-text">count</code>，每次执行 Effect，上一次的计时器被清除，需要调用 <code class="gatsby-code-text">setInterval</code> 重新进入时间队列，实际的定期时间被延后，甚至有可能根本没有机会被执行。</p>
<p>但是下面这样的实践方式也不宜采用：</p>
<p>在 Effect 函数中寻找一些变量添加到 deps 中，需要满足条件：其变化时，需要重新触发 effect。</p>
<p>按照这种实践方式，<code class="gatsby-code-text">count</code> 变化时，我们并不希望重新 <code class="gatsby-code-text">setInterval</code>，故 deps 为空数组。这意味着该 hook 只在组件挂载时运行一次。Effect 中明明依赖了 <code class="gatsby-code-text">count</code>，但我们撒谎说它没有依赖，那么当 <code class="gatsby-code-text">setInterval</code> 回调函数执行时，获取到的 <code class="gatsby-code-text">count</code> 值永远为 0。</p>
<p>遇到这种问题，直接从 deps 移除是不可行的。静下来分析一下，此处为什么要用到 <code class="gatsby-code-text">count</code>？能否避免对其直接使用？</p>
<p>可以看到，在 <code class="gatsby-code-text">setCount</code> 中用到了 <code class="gatsby-code-text">count</code>，为的是把 <code class="gatsby-code-text">count</code> 转换为 <code class="gatsby-code-text">count + 1</code> ，然后返回给 React。React 其实已经知道当前的 <code class="gatsby-code-text">count</code>，我们需要告知 React 的仅仅是去递增状态，不管它现在具体是什么值。</p>
<p>所以有一个最佳实践：状态变更时，应该通过 setState 的函数形式来代替直接获取当前状态。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>另外一种场景是：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>在这里，同样的，当<code class="gatsby-code-text">count</code> 变化时，我们并不希望重新 <code class="gatsby-code-text">setInterval</code>。但我们可以把 <code class="gatsby-code-text">count</code> 通过 ref 保存起来。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> countRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
countRef<span class="token punctuation">.</span>current <span class="token operator">=</span> count<span class="token punctuation">;</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>countRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>这样，<code class="gatsby-code-text">count</code> 的确不再被使用，而是用 ref 存储了一个在所有帧中共享的变量。</p>
<p>另外的情况是，Effects 依赖了函数或者其他引用类型。与原始数据类型不同的是，在未优化的情况下，每次 render 函数调用时，因为对这些内容的重新创建，其值总是发生了变化，导致 Effects 在使用 deps 的情况下依然会频繁被调用。</p>
<p>对于这个问题，<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies" target="_blank" rel="nofollow noopener noreferrer">官网的 FAQ</a> 已经给出了答案：对于函数，使用 useCallback 避免重复创建；对于对象或者数组，则可以使用 useMemo。从而减少 deps 的变化。</p>
<h2 id="使用-eslint-插件"><a href="#%E4%BD%BF%E7%94%A8-eslint-%E6%8F%92%E4%BB%B6" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 ESLint 插件</h2>
<p>使用 ESLint 插件 <code class="gatsby-code-text">eslint-plugin-react-hooks@&gt;=2.4.0</code>，很有必要。</p>
<p>该插件除了帮你检查<a href="https://zh-hans.reactjs.org/docs/hooks-rules.html#only-call-hooks-at-the-top-level" target="_blank" rel="nofollow noopener noreferrer">使用 Hook 需要遵循的两条规则</a>外，还会向你提示在使用 useEffect 或者 useMemo 时，deps 应该填入的内容。</p>
<p>如果你正在使用 VSCode，并且安装了 ESLint 扩展。当你编写 useEffect 或者 useMemo ，且 deps 中的内容并不完整时，deps 所在的那一行便会给出警告或者错误的提示，并且会有一个快速修复的功能，该功能会为你自动填入缺失的 deps。</p>
<p>对于这些提示，不要暴力地通过 <code class="gatsby-code-text">eslint-disable</code> 禁用。未来，你可能再次修改该 useEffect 或者 useMemo，如果使用了新的依赖并且在 deps 中漏掉了它，便会引发新的问题。有一些场景，比如 useEffect 依赖一个函数，并且填入 deps 了。但是这个函数使用了 useCallback 且 deps 出现了遗漏，这种情况下一旦出现问题，排查的难度会很大，所以为什么要让 ESLint 沉默呢？</p>
<p>尝试用上一节的方法进行分析，对于一些变量不希望引起 effect 重新更新的，使用 ref 解决。对于获取状态用于计算新的状态的，尝试 setState 的函数入参，或者使用 useReducer 整合多个类型的状态。</p>
<h2 id="使用-usememousecallback"><a href="#%E4%BD%BF%E7%94%A8-usememousecallback" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 useMemo/useCallback</h2>
<p>useMemo 的含义是，通过一些变量计算得到新的值。通过把这些变量加入依赖 deps，当 deps 中的值均未发生变化时，跳过这次计算。useMemo 中传入的函数，将在 render 函数调用过程被同步调用。</p>
<p>可以使用 useMemo 缓存一些相对耗时的计算。</p>
<p>除此以外，useMemo 也非常适合用于存储引用类型的数据，可以传入对象字面量，匿名函数等，甚至是 React Elements。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    a<span class="token punctuation">,</span>
    b<span class="token punctuation">,</span>
    c<span class="token punctuation">,</span>
    d<span class="token operator">:</span> <span class="token string">'xxx'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 可以用 useCallback 代替</span>
<span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> memoComponentsA <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentsA</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">someProps</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>someProps<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>在这些例子中，useMemo 的目的其实是尽量使用缓存的值。</p>
<p>对于函数，其作为另外一个 useEffect 的 deps 时，减少函数的重新生成，就能减少该 Effect 的调用，甚至避免一些死循环的产生;</p>
<p>对于对象和数组，如果某个子组件使用了它作为 props，减少它的重新生成，就能避免子组件不必要的重复渲染，提升性能。</p>
<p>未优化的代码如下：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">;</span></code></pre></div>
<p>此时，每当父组件需要 render 时，子组件也会执行 render。如果使用 <code class="gatsby-code-text">useMemo</code> 对 data 进行优化：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">;</span></code></pre></div>
<p>当父组件 render 时，只要满足 id 不变，data 的值也不会发生变化，子组件也将避免 render。</p>
<p>对于组件返回的 React Elements，我们可以选择性地提取其中一部分 elements，通过 useMemo 进行缓存，也能避免这一部分的重复渲染。</p>
<p>在过去的 class 组件中，我们通过 <code class="gatsby-code-text">shouldComponentUpdate</code> 判断当前属性和状态是否和上一次的相同，来避免组件不必要的更新。其中的比较是对于本组件的所有属性和状态而言的，无法根据 <code class="gatsby-code-text">shouldComponentUpdate</code> 的返回值来使该组件一部分 elements 更新，另一部分不更新。</p>
<p>为了进一步优化性能，我们会对大组件进行拆分，拆分出的小组件只关心其中一部分属性，从而有更多的机会不去更新。</p>
<p>而函数组件中的 useMemo 其实就可以代替这一部分工作。为了方便理解，我们来看 <em>例五</em>：</p>
<p><a href="https://codesandbox.io/s/goofy-grothendieck-tkmow?fontsize=14&#x26;hidenavigation=1&#x26;module=%2Fsrc%2FExample.js&#x26;theme=dark" target="_blank" rel="nofollow noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit 使用 useMemo 缓存 React Elements
"></a></p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>foo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> main <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">setCount</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span>main<span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>假设 <code class="gatsby-code-text">&lt;Item&gt;</code> 组件，其自身的 render 消耗较多的时间。默认情况下，每次 setCount 改变 count 的值，便会重新对 <code class="gatsby-code-text">&lt;Example&gt;</code> 进行 render，其返回的 React Elements 中 5 个 <code class="gatsby-code-text">&lt;Item&gt;</code> 也重新 render，其耗时的操作阻塞了 UI 的渲染。导致按下 “setCount” 按钮后出现了明显的卡顿。</p>
<p>为了优化性能，我们可以将 <code class="gatsby-code-text">main</code> 变量这一部分单独作为一个组件 <code class="gatsby-code-text">&lt;Main&gt;</code>，拆分出去，并对  <code class="gatsby-code-text">&lt;Main&gt;</code> 使用诸如 <code class="gatsby-code-text">React.memo</code> , <code class="gatsby-code-text">shouldComponentUpdate</code> 的方式，使 <code class="gatsby-code-text">count</code> 属性变化时，<code class="gatsby-code-text">&lt;Main&gt;</code> 不重复 render。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> Main <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">memo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span><span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>而现在，我们可以使用 <code class="gatsby-code-text">useMemo</code>，避免了组件拆分，代码也更简洁易懂：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>foo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> main <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span></span> <span class="token attr-name">x</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span></span> <span class="token attr-name">foo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>foo<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>foo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">setCount</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span>main<span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="惰性初始值"><a href="#%E6%83%B0%E6%80%A7%E5%88%9D%E5%A7%8B%E5%80%BC" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>惰性初始值</h2>
<p>对于 state，其拥有 <a href="https://reactjs.org/docs/hooks-reference.html#lazy-initial-state" target="_blank" rel="nofollow noopener noreferrer">惰性初始化的方法</a>。可能有人不明白它的作用。</p>
<p><code class="gatsby-code-text">someExpensiveComputation</code> 是一个相对耗时的操作。如果我们直接采用</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token function">someExpensiveComputation</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>注意，虽然 <code class="gatsby-code-text">initialState</code> 只在初始化时有其存在的价值，但是 <code class="gatsby-code-text">someExpensiveComputation</code> 在每一帧都被调用了。只有当使用惰性初始化的方法：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token function">someExpensiveComputation</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> initialState<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>因 <code class="gatsby-code-text">someExpensiveComputation</code> 运行在一个匿名函数下，该函数当且仅当初始化时被调用，从而优化性能。</p>
<p>我们甚至可以跳出计算 state 这一规定，来完成任何昂贵的初始化操作。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">someExpensiveComputation</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2 id="避免滥用-refs"><a href="#%E9%81%BF%E5%85%8D%E6%BB%A5%E7%94%A8-refs" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>避免滥用 refs</h2>
<p>当 <code class="gatsby-code-text">useEffect</code> 的依赖频繁变化，你可能想到把频繁变化的值用 ref 保存起来。然而，useReducer 可能是更好的解决方式：使用 dispatch 消除对一些状态的依赖。<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often" target="_blank" rel="nofollow noopener noreferrer">官网的 FAQ</a> 有详细的解释。</p>
<p>最终可以总结出这样的实践：</p>
<p>useEffect 对于函数依赖，尝试将该函数放置在 effect 内，或者使用 useCallback 包裹；useEffect/useCallback/useMemo，对于 state 或者其他属性的依赖，根据 eslint 的提示填入 deps；如果不直接使用 state，只是想修改 state，用 setState 的函数入参方式（<code class="gatsby-code-text">setState(c =&gt; c + 1)</code>）代替；如果修改 state 的过程依赖了其他属性，尝试将 state 和属性聚合，改写成 useReducer 的形式。当这些方法都不奏效，使用 ref，但是依然要谨慎操作。</p>
<h2 id="避免滥用-usememo"><a href="#%E9%81%BF%E5%85%8D%E6%BB%A5%E7%94%A8-usememo" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>避免滥用 useMemo</h2>
<p>使用 useMemo 当 deps 不变时，直接返回上一次计算的结果，从而使子组件跳过渲染。</p>
<p>但是当返回的是原始数据类型（如字符串、数字、布尔值）。即使参与了计算，只要 deps 依赖的内容不变，返回结果也很可能是不变的。此时就需要权衡这个计算的时间成本和 useMemo 额外带来的空间成本（缓存上一次的结果）了。</p>
<p>此外，如果 useMemo 的 deps 依赖数组为空，这样做说明你只是希望存储一个值，这个值在重新 render 时永远不会变。</p>
<p>比如：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Comp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'xxx'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">;
}</span></code></pre></div>
<p>可以被替换为：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Comp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> current<span class="token operator">:</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'xxx'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">;
}</span></code></pre></div>
<p>甚至：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'xxx'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">Comp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">;
}</span></code></pre></div>
<p>此外，如果 deps 频繁变动，我们也要思考，使用 useMemo 是否有必要。因为 useMemo 占用了额外的空间，还需要在每次 render 时检查 deps 是否变动，反而比不使用 useMemo 开销更大。</p>
<h2 id="受控与非受控"><a href="#%E5%8F%97%E6%8E%A7%E4%B8%8E%E9%9D%9E%E5%8F%97%E6%8E%A7" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>受控与非受控</h2>
<p>在一个自定义 Hooks，我们可能有这样一段逻辑：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function-variable function">useSomething</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">inputCount</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> count<span class="token punctuation">,</span> setCount <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">setState</span><span class="token punctuation">(</span>inputCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>这里有一个问题，外部传入的 <code class="gatsby-code-text">inputCount</code> 属性发生了变化，使其与 <code class="gatsby-code-text">useSomething</code> Hook 内的 <code class="gatsby-code-text">count</code> state 不一致时，是否想要更新这个 <code class="gatsby-code-text">count</code> ？</p>
<p>默认不会更新，因为 useState 参数代表的是初始值，仅在 <code class="gatsby-code-text">useSomething</code> 初始时赋值给了 <code class="gatsby-code-text">count</code> state。后续 <code class="gatsby-code-text">count</code> 的状态将与 <code class="gatsby-code-text">inputCount</code> 无关。这种外部无法直接控制 state 的方式，我们称为非受控。</p>
<p>如果想被外部传入的 props 始终控制，比如在这个例子中，<code class="gatsby-code-text">useSomething</code> 内部，<code class="gatsby-code-text">count</code> 这一 state 的值需要从 <code class="gatsby-code-text">inputCount</code> 进行同步，需要这样写：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function-variable function">useSomething</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">inputCount</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> count<span class="token punctuation">,</span> setCount <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">setState</span><span class="token punctuation">(</span>inputCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>inputCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p><code class="gatsby-code-text">setCount</code>后，React 会立即退出当前的 render 并用更新后的 state 重新运行 render 函数。这一点，<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#how-do-i-implement-getderivedstatefromprops" target="_blank" rel="nofollow noopener noreferrer">官网文档</a> 是有说明的。</p>
<p>在这种的机制下，state 由外界同步的同时，内部又有可能通过 setState 来修改 state，可能引发新的问题。例如 <code class="gatsby-code-text">useSomething</code> 初始时，count 为 0，后续内部通过 <code class="gatsby-code-text">setCount</code> 修改了 <code class="gatsby-code-text">count</code> 为 1。当外部函数组件的 render 函数重新调用，也会再一次调用 <code class="gatsby-code-text">useSomething</code>，此时传入的 <code class="gatsby-code-text">inputCount</code> 依然是 0，就会把 <code class="gatsby-code-text">count</code> 变回 0。这很可能不符合预期。</p>
<p>遇到这样的问题，建议将 <code class="gatsby-code-text">inputCount</code> 的当前值与上一次的值进行比较，只有确定发生变化时执行 <code class="gatsby-code-text">setCount(inputCount)</code> 。</p>
<p>当然，在特殊的场景下，这样的设定也不一定符合需求。<a href="https://zh-hans.reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html" target="_blank" rel="nofollow noopener noreferrer">官网的这篇文章</a> 有提出类似的问题。</p>
<h2 id="实践：useslider"><a href="#%E5%AE%9E%E8%B7%B5%EF%BC%9Auseslider" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实践：useSlider</h2>
<p>通过一个滑动选择器自定义 hook <code class="gatsby-code-text">userSlider</code> 的实现，我们可以回答上面的这个问题，顺便对本文做一个总结。</p>
<p><img src="https://p1.music.126.net/ZtmN00eM49yWDirpRFRkyg==/109951164669603891.png" alt="image"></p>
<p><code class="gatsby-code-text">userSlider</code> 需要实现的逻辑是：按住滑动选择器的圆形手柄区域并拖动可以调节数值大小，数值范围为 0 到 1。</p>
<p><code class="gatsby-code-text">userSlider</code> 只负责逻辑的实现，UI 样式由组件自行完成。为了模拟真实业务，另外通过文本展示了当前的数值。并有几个按钮用于切换数值的初始值，这是为了切换分类后，当前的滑动选择器需要重置到某个数值。</p>
<p>按照常规的逻辑，我们实现了以下代码：</p>
<p><a href="https://codesandbox.io/s/useslider-wenti-imji7?fontsize=14&#x26;hidenavigation=1&#x26;module=%2Fsrc%2FuseSlider.js&#x26;theme=dark" target="_blank" rel="nofollow noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit useSlider 问题"></a></p>
<p>当前的问题是，<code class="gatsby-code-text">useEffect</code> 涉及到多个 state 的获取与计算。导致鼠标按下、移动、弹起的几个操作中因为对 state 的修改，<code class="gatsby-code-text">useEffect</code> 频繁刷新，且涉及到了鼠标按下、移动、弹起事件监听的取消与重新绑定，这带来了性能问题以及较难观察到的 BUG。</p>
<p>和前面的 <code class="gatsby-code-text">setInterval</code> 例子相似，我们不希望在状态变动时，刷新 <code class="gatsby-code-text">useEffect</code>。由于此处涉及到多个状态：是否滑动中、鼠标位置、上一次鼠标的问题、选择器的可滑动宽度，如果整合到一个 <code class="gatsby-code-text">state</code> 中，会面临代码不清晰，缺少内聚性的问题，我们尝试用 <code class="gatsby-code-text">useReducer</code> 做一次替换。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">"start"</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>state<span class="token punctuation">,</span>
                lastPos<span class="token operator">:</span> action<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
                slideRange<span class="token operator">:</span> action<span class="token punctuation">.</span>slideWidth<span class="token punctuation">,</span>
                sliding<span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">"move"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span>sliding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> pos <span class="token operator">=</span> action<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            <span class="token keyword">const</span> delta <span class="token operator">=</span> pos <span class="token operator">-</span> state<span class="token punctuation">.</span>lastPos<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>state<span class="token punctuation">,</span>
                lastPos<span class="token operator">:</span> pos<span class="token punctuation">,</span>
                ratio<span class="token operator">:</span> <span class="token function">fixRatio</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>ratio <span class="token operator">+</span> delta <span class="token operator">/</span> state<span class="token punctuation">.</span>slideRange<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token string">"end"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span>sliding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> pos <span class="token operator">=</span> action<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            <span class="token keyword">const</span> delta <span class="token operator">=</span> pos <span class="token operator">-</span> state<span class="token punctuation">.</span>lastPos<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>state<span class="token punctuation">,</span>
                lastPos<span class="token operator">:</span> pos<span class="token punctuation">,</span>
                ratio<span class="token operator">:</span> <span class="token function">fixRatio</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>ratio <span class="token operator">+</span> delta <span class="token operator">/</span> state<span class="token punctuation">.</span>slideRange<span class="token punctuation">)</span><span class="token punctuation">,</span>
                sliding<span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//...</span>

<span class="token keyword">const</span> handleThumbMouseDown <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token parameter">ev</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hotArea <span class="token operator">=</span> hotAreaRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">"start"</span><span class="token punctuation">,</span>
        x<span class="token operator">:</span> ev<span class="token punctuation">.</span>pageX
      slideWidth<span class="token operator">:</span> hotArea<span class="token punctuation">.</span>clientWidth
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">onSliding</span> <span class="token operator">=</span> <span class="token parameter">ev</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token operator">:</span> <span class="token string">"move"</span><span class="token punctuation">,</span>
            x<span class="token operator">:</span> ev<span class="token punctuation">.</span>pageX
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">onSlideEnd</span> <span class="token operator">=</span> <span class="token parameter">ev</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token operator">:</span> <span class="token string">"end"</span><span class="token punctuation">,</span>
            x<span class="token operator">:</span> ev<span class="token punctuation">.</span>pageX
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> onSliding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mouseup"</span><span class="token punctuation">,</span> onSlideEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> onSliding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mouseup"</span><span class="token punctuation">,</span> onSlideEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>这样处理后，effect 只要执行一次即可。</p>
<p>接下来还有一个问题没有处理，目前 <code class="gatsby-code-text">initRatio</code> 是作为初始值传入的，<code class="gatsby-code-text">useSlider</code> 内部的 ratio 是不受外部控制的。</p>
<p>以一个音乐均衡器的设置为例：当前滑动选择器代表的是低频端（31）的增益值，用户通过拖动滑块可以设置这个值的大小（-12 到 12 dB 范围，我们设置到了 3 dB）。同时我们提供了一些预设选项，一旦选择预设选项，如『流行』风格，当前滑块需要重置到特定值 -1 dB。为此， <code class="gatsby-code-text">useSlider</code> 需要提供控制状态的方法。</p>
<p><img src="https://p1.music.126.net/AHuWUMbk9w3RiNoKPuznLw==/109951164669651478.png" alt="image"></p>
<p>根据前一节的介绍，在 <code class="gatsby-code-text">useSlider</code> 的开头，我们可以将属性 <code class="gatsby-code-text">initRatio</code> 的当前值与上一次的值进行比较，若发生变化，则执行 <code class="gatsby-code-text">setRatio</code>。但仍然有场景无法满足：用户选择了『流行』这一预设，然后拖动滑块进行了调节，之后又重新选择『流行』这一预设，此时 <code class="gatsby-code-text">initRatio</code> 没有任何变化，但我们期望 ratio 重新变为 <code class="gatsby-code-text">initRatio</code>。</p>
<p>解决这个问题的办法是，在 <code class="gatsby-code-text">useSlider</code> 内部添加一个 <code class="gatsby-code-text">setRatio</code> 方法。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> setRatio <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token parameter">ratio</span> <span class="token operator">=></span>
        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token operator">:</span> <span class="token string">"setRatio"</span><span class="token punctuation">,</span>
            ratio
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>将该方法输出供外部用于对 ratio 控制。<code class="gatsby-code-text">initRatio</code> 不再控制 ratio 的状态，仅用于设置初始值。</p>
<p>可以看下最终的实现方案：</p>
<p><a href="https://codesandbox.io/s/useslider-zuizhongban-tun1t?fontsize=14&#x26;hidenavigation=1&#x26;module=%2Fsrc%2FuseSlider.js&#x26;theme=dark" target="_blank" rel="nofollow noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit useSlider 最终版"></a></p>
<p>该方案中，除了完成以上需求，还支持在选择器的其他区域点击直接跳转到对应的数值；支持设定选择器为垂直还是水平方向。供大家参考。</p>
<h2 id="结束语"><a href="#%E7%BB%93%E6%9D%9F%E8%AF%AD" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>结束语</h2>
<p>忘掉 class 组件的生命周期，重新审视函数式组件的意义，是用好 React Hooks 的关键一步。希望这篇文章能帮助大家进一步理解并获取到一些最佳实践。当然，不同的 React Hooks 使用姿势可能带来不同的最佳实践，欢迎大家交流。</p>
<h2 id="相关资料"><a href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>相关资料</h2>
<p><a href="https://overreacted.io/a-complete-guide-to-useeffect/" target="_blank" rel="nofollow noopener noreferrer">A Complete Guide to useEffect</a></p>]]></description><link>https://zh-hans.reactjs.org/blog/2020/05/22/react-hooks.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2020/05/22/react-hooks.html</guid><pubDate>Fri, 22 May 2020 00:00:00 GMT</pubDate></item><item><title><![CDATA[React v16.13.0]]></title><description><![CDATA[<p>Today we are releasing React 16.13.0. It contains bugfixes and new deprecation warnings to help prepare for a future major release.</p>
<h2 id="new-warnings"><a href="#new-warnings" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>New Warnings </h2>
<h3 id="warnings-for-some-updates-during-render"><a href="#warnings-for-some-updates-during-render" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Warnings for some updates during render </h3>
<p>A React component should not cause side effects in other components during rendering.</p>
<p>It is supported to call <code class="gatsby-code-text">setState</code> during render, but <a href="/docs/hooks-faq.html#how-do-i-implement-getderivedstatefromprops">only for <em>the same component</em></a>. If you call <code class="gatsby-code-text">setState</code> during a render on a different component, you will now see a warning:</p>
<div class="gatsby-highlight" data-language="text"><pre class="gatsby-code-text"><code class="gatsby-code-text">Warning: Cannot update a component from inside the function body of a different component.</code></pre></div>
<p><strong>This warning will help you find application bugs caused by unintentional state changes.</strong> In the rare case that you intentionally want to change the state of another component as a result of rendering, you can wrap the <code class="gatsby-code-text">setState</code> call into <code class="gatsby-code-text">useEffect</code>.</p>
<h3 id="warnings-for-conflicting-style-rules"><a href="#warnings-for-conflicting-style-rules" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Warnings for conflicting style rules </h3>
<p>When dynamically applying a <code class="gatsby-code-text">style</code> that contains longhand and shorthand versions of CSS properties, particular combinations of updates can cause inconsistent styling. For example: </p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>toggle <span class="token operator">?</span> 
  <span class="token punctuation">{</span> background<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span> <span class="token operator">:</span> 
  <span class="token punctuation">{</span> backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
  ...
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span> </code></pre></div>
<p>You might expect this <code class="gatsby-code-text">&lt;div&gt;</code> to always have a red background, no matter the value of <code class="gatsby-code-text">toggle</code>. However, on alternating the value of <code class="gatsby-code-text">toggle</code> between <code class="gatsby-code-text">true</code> and <code class="gatsby-code-text">false</code>, the background color start as <code class="gatsby-code-text">red</code>, then alternates between <code class="gatsby-code-text">transparent</code> and <code class="gatsby-code-text">blue</code>, <a href="https://codesandbox.io/s/suspicious-sunset-g3jub" target="_blank" rel="nofollow noopener noreferrer">as you can see in this demo</a>.</p>
<p><strong>React now detects conflicting style rules and logs a warning.</strong> To fix the issue, don’t mix shorthand and longhand versions of the same CSS property in the <code class="gatsby-code-text">style</code> prop.</p>
<h3 id="warnings-for-some-deprecated-string-refs"><a href="#warnings-for-some-deprecated-string-refs" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Warnings for some deprecated string refs </h3>
<p><a href="/docs/refs-and-the-dom.html#legacy-api-string-refs">String Refs is an old legacy API</a> which is discouraged and is going to be deprecated in the future:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myRef<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre></div>
<p>(Don’t confuse String Refs with refs in general, which <strong>remain fully supported</strong>.)</p>
<p>In the future, we will provide an automated script (a “codemod”) to migrate away from String Refs. However, some rare cases can’t be migrated automatically. This release adds a new warning <strong>only for those cases</strong> in advance of the deprecation.</p>
<p>For example, it will fire if you use String Refs together with the Render Prop pattern:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">ClassWithRenderProp</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>myRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ClassParent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ClassWithRenderProp</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myRef<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ClassWithRenderProp</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Code like this often indicates bugs. (You might expect the ref to be available on <code class="gatsby-code-text">ClassParent</code>, but instead it gets placed on <code class="gatsby-code-text">ClassWithRenderProp</code>).</p>
<p><strong>You most likely don’t have code like this</strong>. If you do and it is intentional, convert it to <a href="/docs/refs-and-the-dom.html#creating-refs"><code class="gatsby-code-text">React.createRef()</code></a> instead:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">ClassWithRenderProp</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  myRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>myRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>myRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ClassParent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ClassWithRenderProp</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token parameter">myRef</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>myRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ClassWithRenderProp</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>Note</p>
<p>To see this warning, you need to have the <a href="https://babeljs.io/docs/en/babel-plugin-transform-react-jsx-self" target="_blank" rel="nofollow noopener noreferrer">babel-plugin-transform-react-jsx-self</a> installed in your Babel plugins. It must <em>only</em> be enabled in development mode. </p>
<p>If you use Create React App or have the “react” preset with Babel 7+, you already have this plugin installed by default.</p>
</blockquote>
<h3 id="deprecating-reactcreatefactory"><a href="#deprecating-reactcreatefactory" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deprecating <code class="gatsby-code-text">React.createFactory</code> </h3>
<p><a href="/docs/react-api.html#createfactory"><code class="gatsby-code-text">React.createFactory</code></a> is a legacy helper for creating React elements. This release adds a deprecation warning to the method. It will be removed in a future major version.</p>
<p>Replace usages of <code class="gatsby-code-text">React.createFactory</code> with regular JSX. Alternately, you can copy and paste this one-line helper or publish it as a library:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">let</span> <span class="token function-variable function">createFactory</span> <span class="token operator">=</span> <span class="token parameter">type</span> <span class="token operator">=></span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>It does exactly the same thing.</p>
<h3 id="deprecating-reactdomunstable_createportal-in-favor-of-reactdomcreateportal"><a href="#deprecating-reactdomunstable_createportal-in-favor-of-reactdomcreateportal" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deprecating <code class="gatsby-code-text">ReactDOM.unstable_createPortal</code> in favor of <code class="gatsby-code-text">ReactDOM.createPortal</code> </h3>
<p>When React 16 was released, <code class="gatsby-code-text">createPortal</code> became an officially supported API.</p>
<p>However, we kept <code class="gatsby-code-text">unstable_createPortal</code> as a supported alias to keep the few libraries that adopted it working. We are now deprecating the unstable alias. Use <code class="gatsby-code-text">createPortal</code> directly instead of <code class="gatsby-code-text">unstable_createPortal</code>. It has exactly the same signature.</p>
<h2 id="other-improvements"><a href="#other-improvements" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Other Improvements </h2>
<h3 id="component-stacks-in-hydration-warnings"><a href="#component-stacks-in-hydration-warnings" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Component stacks in hydration warnings </h3>
<p>React adds component stacks to its development warnings, enabling developers to isolate bugs and debug their programs. This release adds component stacks to a number of development warnings that didn’t previously have them. As an example, consider this hydration warning from the previous versions:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/20bd06e254e7ad32aa007a59a41d1e65/61583/hydration-warning-before.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 7.142857142857142%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAP0lEQVQI1zWLQQrAIAwE+/+PJhqRYkkOlriNDR6GZQb2msTwUuAcSwSvNV0k2/azrWVXC/RnmUF7xx2fdzz4ABFxTIdyNAG5AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="A screenshot of the console warning, simply stating the nature of the hydration mismatch: "Warning: Expected server HTML to contain a matching div in div.""
        title=""
        src="/static/20bd06e254e7ad32aa007a59a41d1e65/1e088/hydration-warning-before.png"
        srcset="/static/20bd06e254e7ad32aa007a59a41d1e65/65ed1/hydration-warning-before.png 210w,
/static/20bd06e254e7ad32aa007a59a41d1e65/d10fb/hydration-warning-before.png 420w,
/static/20bd06e254e7ad32aa007a59a41d1e65/1e088/hydration-warning-before.png 840w,
/static/20bd06e254e7ad32aa007a59a41d1e65/78612/hydration-warning-before.png 1260w,
/static/20bd06e254e7ad32aa007a59a41d1e65/61583/hydration-warning-before.png 1616w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>While it’s pointing out an error with the code, it’s not clear where the error exists, and what to do next. This release adds a component stack to this warning, which makes it look like this:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/abf3b580867e79d5f377330842bb6522/d3d45/hydration-warning-after.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 16.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAk0lEQVQI11WOwQ6CMBBE+f/P4k7wLBEOEJEKFSItRmifg17w8LKzm8nOJOu1JdQ1oaoIRcGrrFikt7Yldh3hJqS/09wJ+22eCc8fcXb4fmCU5z1NJFEL+QnSFLIML1yeEy4lKAw9wfRwP2AfB0Y2/Vjli4MlCW6BvU1xJjYNDAqwFtQkGqMGauE90R1xf6Ab8iD9Ab5h5IiPbXX7AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="A screenshot of the console warning, stating the nature of the hydration mismatch, but also including a component stack : "Warning: Expected server HTML to contain a matching div in div, in div (at pages/index.js:4)...""
        title=""
        src="/static/abf3b580867e79d5f377330842bb6522/1e088/hydration-warning-after.png"
        srcset="/static/abf3b580867e79d5f377330842bb6522/65ed1/hydration-warning-after.png 210w,
/static/abf3b580867e79d5f377330842bb6522/d10fb/hydration-warning-after.png 420w,
/static/abf3b580867e79d5f377330842bb6522/1e088/hydration-warning-after.png 840w,
/static/abf3b580867e79d5f377330842bb6522/78612/hydration-warning-after.png 1260w,
/static/abf3b580867e79d5f377330842bb6522/d3d45/hydration-warning-after.png 1614w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>This makes it clear where the problem is, and lets you locate and fix the bug faster. </p>
<h3 id="notable-bugfixes"><a href="#notable-bugfixes" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Notable bugfixes </h3>
<p>This release contains a few other notable improvements:</p>
<ul>
<li>In Strict Development Mode, React calls lifecycle methods twice to flush out any possible unwanted side effects. This release adds that behaviour to <code class="gatsby-code-text">shouldComponentUpdate</code>. This shouldn’t affect most code, unless you have side effects in <code class="gatsby-code-text">shouldComponentUpdate</code>. To fix this, move the code with side effects into <code class="gatsby-code-text">componentDidUpdate</code>.</li>
<li>In Strict Development Mode, the warnings for usage of the legacy context API didn’t include the stack for the component that triggered the warning. This release adds the missing stack to the warning.</li>
<li><code class="gatsby-code-text">onMouseEnter</code> now doesn’t trigger on disabled <code class="gatsby-code-text">&lt;button&gt;</code> elements.</li>
<li>ReactDOM was missing a <code class="gatsby-code-text">version</code> export since we published v16. This release adds it back. We don’t recommend using it in your application logic, but it’s useful when debugging issues with mismatching / multiple versions of ReactDOM on the same page.</li>
</ul>
<p>We’re thankful to all the contributors who helped surface and fix these and other issues. You can find the full changelog <a href="#changelog">below</a>.</p>
<h2 id="installation"><a href="#installation" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installation </h2>
<h3 id="react"><a href="#react" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React </h3>
<p>React v16.13.0 is available on the npm registry.</p>
<p>To install React 16 with Yarn, run:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token function">yarn</span> <span class="token function">add</span> react@^16.13.0 react-dom@^16.13.0</code></pre></div>
<p>To install React 16 with npm, run:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token function">npm</span> <span class="token function">install</span> --save react@^16.13.0 react-dom@^16.13.0</code></pre></div>
<p>We also provide UMD builds of React via a CDN:</p>
<div class="gatsby-highlight" data-language="html"><pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react@16/umd/react.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@16/umd/react-dom.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>Refer to the documentation for <a href="/docs/installation.html">detailed installation instructions</a>.</p>
<h2 id="changelog"><a href="#changelog" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Changelog </h2>
<h3 id="react"><a href="#react" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React </h3>
<ul>
<li>Warn when a string ref is used in a manner that’s not amenable to a future codemod (<a href="https://github.com/lunaruan" target="_blank" rel="nofollow noopener noreferrer">@lunaruan</a> in <a href="https://github.com/facebook/react/pull/17864" target="_blank" rel="nofollow noopener noreferrer">#17864</a>)</li>
<li>Deprecate <code class="gatsby-code-text">React.createFactory()</code> (<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> in <a href="https://github.com/facebook/react/pull/17878" target="_blank" rel="nofollow noopener noreferrer">#17878</a>)</li>
</ul>
<h3 id="react-dom"><a href="#react-dom" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React DOM </h3>
<ul>
<li>Warn when changes in <code class="gatsby-code-text">style</code> may cause an unexpected collision (<a href="https://github.com/sophiebits" target="_blank" rel="nofollow noopener noreferrer">@sophiebits</a> in <a href="https://github.com/facebook/react/pull/14181" target="_blank" rel="nofollow noopener noreferrer">#14181</a>, <a href="https://github.com/facebook/react/pull/18002" target="_blank" rel="nofollow noopener noreferrer">#18002</a>)</li>
<li>Warn when a function component is updated during another component’s render phase (<a href="(https://github.com/acdlite)">@acdlite</a> in <a href="https://github.com/facebook/react/pull/17099" target="_blank" rel="nofollow noopener noreferrer">#17099</a>)</li>
<li>Deprecate <code class="gatsby-code-text">unstable_createPortal</code> (<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> in <a href="https://github.com/facebook/react/pull/17880" target="_blank" rel="nofollow noopener noreferrer">#17880</a>)</li>
<li>Fix <code class="gatsby-code-text">onMouseEnter</code> being fired on disabled buttons (<a href="https://github.com/AlfredoGJ" target="_blank" rel="nofollow noopener noreferrer">@AlfredoGJ</a> in <a href="https://github.com/facebook/react/pull/17675" target="_blank" rel="nofollow noopener noreferrer">#17675</a>)</li>
<li>Call <code class="gatsby-code-text">shouldComponentUpdate</code> twice when developing in <code class="gatsby-code-text">StrictMode</code> (<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> in <a href="https://github.com/facebook/react/pull/17942" target="_blank" rel="nofollow noopener noreferrer">#17942</a>)</li>
<li>Add <code class="gatsby-code-text">version</code> property to ReactDOM (<a href="https://github.com/ealush" target="_blank" rel="nofollow noopener noreferrer">@ealush</a> in <a href="https://github.com/facebook/react/pull/15780" target="_blank" rel="nofollow noopener noreferrer">#15780</a>)</li>
<li>Don’t call <code class="gatsby-code-text">toString()</code> of <code class="gatsby-code-text">dangerouslySetInnerHTML</code> (<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> in <a href="https://github.com/facebook/react/pull/17773" target="_blank" rel="nofollow noopener noreferrer">#17773</a>)</li>
<li>Show component stacks in more warnings (<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> in <a href="https://github.com/facebook/react/pull/17922" target="_blank" rel="nofollow noopener noreferrer">#17922</a>, <a href="https://github.com/facebook/react/pull/17586" target="_blank" rel="nofollow noopener noreferrer">#17586</a>)</li>
</ul>
<h3 id="concurrent-mode-experimental"><a href="#concurrent-mode-experimental" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Concurrent Mode (Experimental) </h3>
<ul>
<li>Warn for problematic usages of <code class="gatsby-code-text">ReactDOM.createRoot()</code> (<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> in <a href="https://github.com/facebook/react/pull/17937" target="_blank" rel="nofollow noopener noreferrer">#17937</a>)</li>
<li>Remove <code class="gatsby-code-text">ReactDOM.createRoot()</code> callback params and added warnings on usage (<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> in <a href="https://github.com/facebook/react/pull/17916" target="_blank" rel="nofollow noopener noreferrer">#17916</a>)</li>
<li>Don’t group Idle/Offscreen work with other work (<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> in <a href="https://github.com/facebook/react/pull/17456" target="_blank" rel="nofollow noopener noreferrer">#17456</a>)</li>
<li>Adjust <code class="gatsby-code-text">SuspenseList</code> CPU bound heuristic (<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> in <a href="https://github.com/facebook/react/pull/17455" target="_blank" rel="nofollow noopener noreferrer">#17455</a>)</li>
<li>Add missing event plugin priorities (<a href="https://github.com/trueadm" target="_blank" rel="nofollow noopener noreferrer">@trueadm</a> in <a href="https://github.com/facebook/react/pull/17914" target="_blank" rel="nofollow noopener noreferrer">#17914</a>)</li>
<li>Fix <code class="gatsby-code-text">isPending</code> only being true when transitioning from inside an input event (<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> in <a href="https://github.com/facebook/react/pull/17382" target="_blank" rel="nofollow noopener noreferrer">#17382</a>)</li>
<li>Fix <code class="gatsby-code-text">React.memo</code> components dropping updates when interrupted by a higher priority update (<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> in <a href="https://github.com/facebook/react/pull/18091" target="_blank" rel="nofollow noopener noreferrer">#18091</a>)</li>
<li>Don’t warn when suspending at the wrong priority (<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> in <a href="https://github.com/facebook/react/pull/17971" target="_blank" rel="nofollow noopener noreferrer">#17971</a>)</li>
<li>Fix a bug with rebasing updates (<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> and <a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> in <a href="https://github.com/facebook/react/pull/17560" target="_blank" rel="nofollow noopener noreferrer">#17560</a>, <a href="https://github.com/facebook/react/pull/17510" target="_blank" rel="nofollow noopener noreferrer">#17510</a>, <a href="https://github.com/facebook/react/pull/17483" target="_blank" rel="nofollow noopener noreferrer">#17483</a>, <a href="https://github.com/facebook/react/pull/17480" target="_blank" rel="nofollow noopener noreferrer">#17480</a>)</li>
</ul>]]></description><link>https://zh-hans.reactjs.org/blog/2020/02/26/react-v16.13.0.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2020/02/26/react-v16.13.0.html</guid><pubDate>Wed, 26 Feb 2020 00:00:00 GMT</pubDate></item><item><title><![CDATA[Building Great User Experiences with Concurrent Mode and Suspense]]></title><description><![CDATA[<p>At React Conf 2019 we announced an <a href="/docs/concurrent-mode-adoption.html#installation">experimental release</a> of React that supports Concurrent Mode and Suspense. In this post we’ll introduce best practices for using them that we’ve identified through the process of building <a href="https://twitter.com/facebook/status/1123322299418124289" target="_blank" rel="nofollow noopener noreferrer">the new facebook.com</a>.</p>
<blockquote>
<p>This post will be most relevant to people working on <em>data fetching libraries</em> for React. </p>
<p>It shows how to best integrate them with Concurrent Mode and Suspense. The patterns introduced here are based on <a href="https://relay.dev/docs/en/experimental/step-by-step" target="_blank" rel="nofollow noopener noreferrer">Relay</a> — our library for building data-driven UIs with GraphQL. However, the ideas in this post <strong>apply to other GraphQL clients as well as libraries using REST</strong> or other approaches.</p>
</blockquote>
<p>This post is <strong>aimed at library authors</strong>. If you’re primarily an application developer, you might still find some interesting ideas here, but don’t feel like you have to read it in its entirety.</p>
<h2 id="talk-videos"><a href="#talk-videos" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Talk Videos </h2>
<p>If you prefer to watch videos, some of the ideas from this blog post have been referenced in several React Conf 2019 presentations:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=Tl0S7QkxFE4&#x26;list=PLPxbbTqCLbGHPxZpw4xj_Wwg8-fdNxJRh&#x26;index=15&#x26;t=0s" target="_blank" rel="nofollow noopener noreferrer">Data Fetching with Suspense in Relay</a> by <a href="https://twitter.com/en_JS" target="_blank" rel="nofollow noopener noreferrer">Joe Savona</a></li>
<li><a href="https://www.youtube.com/watch?v=KT3XKDBZW7M&#x26;list=PLPxbbTqCLbGHPxZpw4xj_Wwg8-fdNxJRh&#x26;index=4" target="_blank" rel="nofollow noopener noreferrer">Building the New Facebook with React and Relay</a> by <a href="https://twitter.com/catchingash" target="_blank" rel="nofollow noopener noreferrer">Ashley Watkins</a></li>
<li><a href="https://www.youtube.com/watch?v=uXEEL9mrkAQ&#x26;list=PLPxbbTqCLbGHPxZpw4xj_Wwg8-fdNxJRh&#x26;index=2" target="_blank" rel="nofollow noopener noreferrer">React Conf Keynote</a> by <a href="https://twitter.com/yuzhiz" target="_blank" rel="nofollow noopener noreferrer">Yuzhi Zheng</a></li>
</ul>
<p>This post presents a deeper dive on implementing a data fetching library with Suspense.</p>
<h2 id="putting-user-experience-first"><a href="#putting-user-experience-first" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Putting User Experience First </h2>
<p>The React team and community has long placed a deserved emphasis on developer experience: ensuring that React has good error messages, focusing on components as a way to reason locally about app behavior, crafting APIs that are predictable and encourage correct usage by design, etc. But we haven’t provided enough guidance on the best ways to achieve a great <em>user</em> experience in large apps.</p>
<p>For example, the React team has focused on <em>framework</em> performance and providing tools for developers to debug and tune application performance (e.g. <code class="gatsby-code-text">React.memo</code>). But we haven’t been as opinionated about the <em>high-level patterns</em> that make the difference between fast, fluid apps and slow, janky ones. We always want to ensure that React remains approachable to new users and supports a variety of use-cases — not every app has to be “blazing” fast. But as a community we can and should aim high. <strong>We should make it as easy as possible to build apps that start fast and stay fast,</strong> even as they grow in complexity, for users on varying devices and networks around the world. </p>
<p><a href="/docs/concurrent-mode-intro.html">Concurrent Mode</a> and <a href="/docs/concurrent-mode-suspense.html">Suspense</a> are experimental features that can help developers achieve this goal. We first introduced them at <a href="/blog/2018/03/01/sneak-peek-beyond-react-16.html">JSConf Iceland in 2018</a>, intentionally sharing details very early to give the community time to digest the new concepts and to set the stage for subsequent changes. Since then we’ve completed related work, such as the new Context API and the introduction of Hooks, which are designed in part to help developers naturally write code that is more compatible with Concurrent Mode. But we didn’t want to implement these features and release them without validating that they work. So over the past year, the React, Relay, web infrastructure, and product teams at Facebook have all collaborated closely to build a new version of facebook.com that deeply integrates Concurrent Mode and Suspense to create an experience with a more fluid and app-like feel. </p>
<p>Thanks to this project, we’re more confident than ever that Concurrent Mode and Suspense can make it easier to deliver great, <em>fast</em> user experiences. But doing so requires rethinking how we approach loading code and data for our apps. Effectively all of the data-fetching on the new facebook.com is powered by <a href="https://relay.dev/docs/en/experimental/step-by-step" target="_blank" rel="nofollow noopener noreferrer">Relay Hooks</a> — new Hooks-based Relay APIs that integrate with Concurrent Mode and Suspense out of the box.</p>
<p>Relay Hooks — and GraphQL — won’t be for everyone, and that’s ok! Through our work on these APIs we’ve identified a set of more general patterns for using Suspense. <strong>Even if Relay isn’t the right fit for you, we think the key patterns we’ve introduced with Relay Hooks can be adapted to other frameworks.</strong></p>
<h2 id="best-practices-for-suspense"><a href="#best-practices-for-suspense" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Best Practices for Suspense </h2>
<p>It’s tempting to focus only on the total startup time for an app — but it turns out that users’ perception of performance is determined by more than the absolute loading time. For example, when comparing two apps with the same absolute startup time, our research shows that users will generally perceive the one with fewer intermediate loading states and fewer layout changes as having loaded faster. Suspense is a powerful tool for carefully orchestrating an elegant loading sequence with a few, well-defined states that progressively reveal content. But improving perceived performance only goes so far — our apps still shouldn’t take forever to fetch all of their code, data, images, and other assets.</p>
<p>The traditional approach to loading data in React apps involves what we refer to as <a href="/docs/concurrent-mode-suspense.html#approach-1-fetch-on-render-not-using-suspense">“fetch-on-render”</a>. First we render a component with a spinner, then fetch data on mount (<code class="gatsby-code-text">componentDidMount</code> or <code class="gatsby-code-text">useEffect</code>), and finally update to render the resulting data. It’s certainly <em>possible</em> to use this pattern with Suspense: instead of initially rendering a placeholder itself, a component can “suspend” — indicate to React that it isn’t ready yet. This will tell React to find the nearest ancestor <code class="gatsby-code-text">&lt;Suspense fallback={&lt;Placeholder/&gt;}&gt;</code>, and render its fallback instead. If you watched earlier Suspense demos this example may feel familiar — it’s how we originally imagined using Suspense for data-fetching. </p>
<p>It turns out that this approach has some limitations. Consider a page that shows a social media post by a user, along with comments on that post. That might be structured as a <code class="gatsby-code-text">&lt;Post&gt;</code> component that renders both the post body and a <code class="gatsby-code-text">&lt;CommentList&gt;</code> to show the comments. Using the fetch-on-render approach described above to implement this could cause sequential round trips (sometimes referred to as a “waterfall”). First the data for the <code class="gatsby-code-text">&lt;Post&gt;</code> component would be fetched and then the data for <code class="gatsby-code-text">&lt;CommentList&gt;</code> would be fetched, increasing the time it takes to show the full page.</p>
<p>There’s also another often-overlooked downside to this approach. If <code class="gatsby-code-text">&lt;Post&gt;</code> eagerly requires (or imports) the <code class="gatsby-code-text">&lt;CommentList&gt;</code> component, our app will have to wait to show the post <em>body</em> while the code for the <em>comments</em> is downloading. We could lazily load <code class="gatsby-code-text">&lt;CommentList&gt;</code>, but then that would delay fetching comments data and increase the time to show the full page. How do we resolve this problem without compromising on the user experience?</p>
<h2 id="render-as-you-fetch"><a href="#render-as-you-fetch" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Render As You Fetch </h2>
<p>The fetch-on-render approach is widely used by React apps today and can certainly be used to create great apps. But can we do even better? Let’s step back and consider our goal.</p>
<p>In the above <code class="gatsby-code-text">&lt;Post&gt;</code> example, we’d ideally show the more important content — the post body — as early as possible, <em>without</em> negatively impacting the time to show the full page (including comments). Let’s consider the key constraints on any solution and look at how we can achieve them:</p>
<ul>
<li>Showing the more important content (the post body) as early as possible means that we need to load the code and data for the view incrementally. We <em>don’t want to block showing the post body</em> on the code for <code class="gatsby-code-text">&lt;CommentList&gt;</code> being downloaded, for example.</li>
<li>At the same time we don’t want to increase the time to show the full page including comments. So we need to <em>start loading the code and data for the comments</em> as soon as possible, ideally <em>in parallel</em> with loading the post body.</li>
</ul>
<p>This might sound difficult to achieve — but these constraints are actually incredibly helpful. They rule out a large number of approaches and spell out a solution for us. This brings us to the key patterns we’ve implemented in Relay Hooks, and that can be adapted to other data-fetching libraries. We’ll look at each one in turn and then see how they add up to achieve our goal of fast, delightful loading experiences:</p>
<ol>
<li>Parallel data and view trees</li>
<li>Fetch in event handlers</li>
<li>Load data incrementally</li>
<li>Treat code like data</li>
</ol>
<h3 id="parallel-data-and-view-trees"><a href="#parallel-data-and-view-trees" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parallel Data and View Trees </h3>
<p>One of the most appealing things about the fetch-on-render pattern is that it colocates <em>what</em> data a component needs with <em>how</em> to render that data. This colocation is great — an example of how it makes sense to group code by concerns and not by technologies. All the issues we saw above were due to <em>when</em> we fetch data in this approach: upon rendering. We need to be able to fetch data <em>before</em> we’ve rendered the component. The only way to achieve that is by extracting the data dependencies into parallel data and view trees. </p>
<p>Here’s how that works in Relay Hooks. Continuing our example of a social media post with body and comments, here’s how we might define it with Relay Hooks:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// Post.js</span>
<span class="token keyword">function</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Given a reference to some post - `props.post` - *what* data</span>
  <span class="token comment">// do we need about that post?</span>
  <span class="token keyword">const</span> postData <span class="token operator">=</span> <span class="token function">useFragment</span><span class="token punctuation">(</span>graphql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    fragment PostData on Post @refetchable(queryName: "PostQuery") {
      author
      title
      # ...  more fields ...
    }
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Now that we have the data, how do we render it?</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>postData<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">by </span><span class="token punctuation">{</span>postData<span class="token punctuation">.</span>author<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* more fields  */</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Although the GraphQL is written within the component, Relay has a build step (Relay Compiler) that extracts these data-dependencies into separate files and aggregates the GraphQL for each view into a single query. So we get the benefit of colocating concerns, while at runtime having parallel data and view trees. Other frameworks could achieve a similar effect by allowing developers to define data-fetching logic in a sibling file (maybe <code class="gatsby-code-text">Post.data.js</code>), or perhaps integrate with a bundler to allow defining data dependencies with UI code and automatically extracting it, similar to Relay Compiler.</p>
<p>The key is that regardless of the technology we’re using to load our data — GraphQL, REST, etc — we can separate <em>what</em> data to load from how and when to actually load it. But once we do that, how and when <em>do</em> we fetch our data?</p>
<h3 id="fetch-in-event-handlers"><a href="#fetch-in-event-handlers" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fetch in Event Handlers </h3>
<p>Imagine that we’re about to navigate from a list of a user’s posts to the page for a specific post. We’ll need to download the code for that page — <code class="gatsby-code-text">Post.js</code> — and also fetch its data.</p>
<p>Waiting until we render the component has problems as we saw above. The key is to start fetching code and data for a new view <em>in the same event handler that triggers showing that view</em>. We can either fetch the data within our router — if our router supports preloading data for routes — or in the click event on the link that triggered the navigation. It turns out that the React Router folks are already hard at work on building APIs to support preloading data for routes. But other routing frameworks can implement this idea too. </p>
<p>Conceptually, we want every route definition to include two things: what component to render and what data to preload, as a function of the route/url params. Here’s what such a route definition <em>might</em> look like. This example is loosely inspired by React Router’s route definitions and is <em>primarily intended to demonstrate the concept, not a specific API</em>:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// PostRoute.js (GraphQL version)</span>

<span class="token comment">// Relay generated query for loading Post data</span>
<span class="token keyword">import</span> PostQuery <span class="token keyword">from</span> <span class="token string">'./__generated__/PostQuery.graphql'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> PostRoute <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// a matching expression for which paths to handle</span>
  path<span class="token operator">:</span> <span class="token string">'/post/:id'</span><span class="token punctuation">,</span>

  <span class="token comment">// what component to render for this route</span>
  component<span class="token operator">:</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./Post'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">// data to load for this route, as function of the route</span>
  <span class="token comment">// parameters</span>
  <span class="token function-variable function">prepare</span><span class="token operator">:</span> <span class="token parameter">routeParams</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// Relay extracts queries from components, allowing us to reference</span>
    <span class="token comment">// the data dependencies -- data tree -- from outside.</span>
    <span class="token keyword">const</span> postData <span class="token operator">=</span> <span class="token function">preloadQuery</span><span class="token punctuation">(</span>PostQuery<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      postId<span class="token operator">:</span> routeParams<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span> postData <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> PostRoute<span class="token punctuation">;</span></code></pre></div>
<p>Given such a definition, a router can:</p>
<ul>
<li>Match a URL to a route definition.</li>
<li>Call the <code class="gatsby-code-text">prepare()</code> function to start loading that route’s data. Note that <code class="gatsby-code-text">prepare()</code> is synchronous — <em>we don’t wait for the data to be ready</em>, since we want to start rendering more important parts of the view (like the post body) as quickly as possible.</li>
<li>Pass the preloaded data to the component. If the component is ready — the <code class="gatsby-code-text">React.lazy</code> dynamic import has completed — the component will render and try to access its data. If not, <code class="gatsby-code-text">React.lazy</code> will suspend until the code is ready.</li>
</ul>
<p>This approach can be generalized to other data-fetching solutions. An app that uses REST might define a route like this:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// PostRoute.js (REST version)</span>

<span class="token comment">// Manually written logic for loading the data for the component</span>
<span class="token keyword">import</span> PostData <span class="token keyword">from</span> <span class="token string">'./Post.data'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> PostRoute <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// a matching expression for which paths to handle</span>
  path<span class="token operator">:</span> <span class="token string">'/post/:id'</span><span class="token punctuation">,</span>

  <span class="token comment">// what component to render for this route</span>
  component<span class="token operator">:</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./Post'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">// data to load for this route, as function of the route</span>
  <span class="token comment">// parameters</span>
  <span class="token function-variable function">prepare</span><span class="token operator">:</span> <span class="token parameter">routeParams</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> postData <span class="token operator">=</span> <span class="token function">preloadRestEndpoint</span><span class="token punctuation">(</span>
      PostData<span class="token punctuation">.</span>endpointUrl<span class="token punctuation">,</span> 
      <span class="token punctuation">{</span>
        postId<span class="token operator">:</span> routeParams<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> postData <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> PostRoute<span class="token punctuation">;</span></code></pre></div>
<p>This same approach can be employed not just for routing, but in other places where we show content lazily or based on user interaction. For example, a tab component could eagerly load the first tab’s code and data, and then use the same pattern as above to load the code and data for other tabs in the tab-change event handler. A component that displays a modal could preload the code and data for the modal in the click handler that triggers opening the modal, and so on. </p>
<p>Once we’ve implemented the ability to start loading code and data for a view independently, we have the option to go one step further. Consider a <code class="gatsby-code-text">&lt;Link to={path} /&gt;</code> component that links to a route. If the user hovers over that link, there’s a reasonable chance they’ll click it. And if they press the mouse down, there’s an even better chance that they’ll complete the click. If we can load code and data for a view <em>after</em> the user clicks, we can also start that work <em>before</em> they click, getting a head start on preparing the view.</p>
<p>Best of all, we can centralize that logic in a few key places — a router or core UI components — and get any performance benefits automatically throughout our app. Of course preloading isn’t always beneficial. It’s something an application would tune based on the user’s device or network speed to avoid eating up user’s data plans. But the pattern here makes it easier to centralize the implementation of preloading and the decision of whether to enable it or not.</p>
<h3 id="load-data-incrementally"><a href="#load-data-incrementally" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Load Data Incrementally </h3>
<p>The above patterns — parallel data/view trees and fetching in event handlers — let us start loading all the data for a view earlier. But we still want to be able to show more important parts of the view without waiting for <em>all</em> of our data. At Facebook we’ve implemented support for this in GraphQL and Relay in the form of some new GraphQL directives (annotations that affect how/when data is delivered, but not what data). These new directives, called <code class="gatsby-code-text">@defer</code> and <code class="gatsby-code-text">@stream</code>, allow us to retrieve data incrementally. For example, consider our <code class="gatsby-code-text">&lt;Post&gt;</code> component from above. We want to show the body without waiting for the comments to be ready. We can achieve this with <code class="gatsby-code-text">@defer</code> and <code class="gatsby-code-text">&lt;Suspense&gt;</code>:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// Post.js</span>
<span class="token keyword">function</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> postData <span class="token operator">=</span> <span class="token function">useFragment</span><span class="token punctuation">(</span>graphql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    fragment PostData on Post {
      author
      title

      # fetch data for the comments, but don't block on it being ready
      ...CommentList @defer
    }
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>postData<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">by </span><span class="token punctuation">{</span>postData<span class="token punctuation">.</span>author<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* @defer pairs naturally with &lt;Suspense> to make the UI non-blocking too */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Suspense</span></span> <span class="token attr-name">fallback</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Spinner</span></span><span class="token punctuation">/></span></span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">CommentList</span></span> <span class="token attr-name">post</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>postData<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Suspense</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Here, our GraphQL server will stream back the results, first returning the <code class="gatsby-code-text">author</code> and <code class="gatsby-code-text">title</code> fields and then returning the comment data when it’s ready. We wrap <code class="gatsby-code-text">&lt;CommentList&gt;</code> in a <code class="gatsby-code-text">&lt;Suspense&gt;</code> boundary so that we can render the post body before <code class="gatsby-code-text">&lt;CommentList&gt;</code> and its data are ready. This same pattern can be applied to other frameworks as well. For example, apps that call a REST API might make parallel requests to fetch the body and comments data for a post to avoid blocking on all the data being ready.</p>
<h3 id="treat-code-like-data"><a href="#treat-code-like-data" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Treat Code Like Data </h3>
<p>But there’s one thing that’s still missing. We’ve shown how to preload <em>data</em> for a route — but what about code? The example above cheated a bit and used <code class="gatsby-code-text">React.lazy</code>. However, <code class="gatsby-code-text">React.lazy</code> is, as the name implies, <em>lazy</em>. It won’t start downloading code until the lazy component is actually rendered — it’s “fetch-on-render” for code!</p>
<p>To solve this, the React team is considering APIs that would allow bundle splitting and eager preloading for code as well. That would allow a user to pass some form of lazy component to a router, and for the router to trigger loading the code alongside its data as early as possible.</p>
<h2 id="putting-it-all-together"><a href="#putting-it-all-together" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Putting It All Together </h2>
<p>To recap, achieving a great loading experience means that we need to <strong>start loading code and data as early as possible, but without waiting for all of it to be ready</strong>. Parallel data and view trees allow us to load the data for a view in parallel with loading the view (code) itself. Fetching in an event handler means we can start loading data as early as possible, and even optimistically preload a view when we have enough confidence that a user will navigate to it. Loading data incrementally allows us to load important data earlier without delaying the fetching of less important data. And treating code as data — and preloading it with similar APIs — allows us to load it earlier too.</p>
<h2 id="using-these-patterns"><a href="#using-these-patterns" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using These Patterns </h2>
<p>These patterns aren’t just ideas — we’ve implemented them in Relay Hooks and are using them in production throughout the new facebook.com (which is currently in beta testing). If you’re interested in using or learning more about these patterns, here are some resources:</p>
<ul>
<li>The <a href="/docs/concurrent-mode-intro.html">React Concurrent docs</a> explore how to use Concurrent Mode and Suspense and go into more detail about many of these patterns. It’s a great resource to learn more about the APIs and use-cases they support.</li>
<li>The <a href="https://relay.dev/docs/en/experimental/step-by-step" target="_blank" rel="nofollow noopener noreferrer">experimental release of Relay Hooks</a> implements the patterns described here. </li>
<li>
<p>We’ve implemented two similar example apps that demonstrate these concepts:</p>
<ul>
<li>The <a href="https://github.com/relayjs/relay-examples/tree/master/issue-tracker" target="_blank" rel="nofollow noopener noreferrer">Relay Hooks example app</a> uses GitHub’s public GraphQL API to implement a simple issue tracker app. It includes nested route support with code and data preloading. The code is fully commented — we encourage cloning the repo, running the app locally, and exploring how it works.</li>
<li>We also have a <a href="https://github.com/gaearon/suspense-experimental-github-demo" target="_blank" rel="nofollow noopener noreferrer">non-GraphQL version of the app</a> that demonstrates how these concepts can be applied to other data-fetching libraries.</li>
</ul>
</li>
</ul>
<p>While the APIs around Concurrent Mode and Suspense are <a href="/docs/concurrent-mode-adoption.html#who-is-this-experimental-release-for">still experimental</a>, we’re confident that the ideas in this post are proven by practice. However, we understand that Relay and GraphQL aren’t the right fit for everyone. That’s ok! <strong>We’re actively exploring how to generalize these patterns to approaches such as REST,</strong> and are exploring ideas for a more generic (ie non-GraphQL) API for composing a tree of data dependencies. In the meantime, we’re excited to see what new libraries will emerge that implement the patterns described in this post to make it easier to build great, <em>fast</em> user experiences.</p>]]></description><link>https://zh-hans.reactjs.org/blog/2019/11/06/building-great-user-experiences-with-concurrent-mode-and-suspense.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2019/11/06/building-great-user-experiences-with-concurrent-mode-and-suspense.html</guid><pubDate>Wed, 06 Nov 2019 00:00:00 GMT</pubDate></item><item><title><![CDATA[使用 React 预发布版为新功能打基础]]></title><description><![CDATA[<p>为了与 React 生态系统的合作伙伴共享即将发生的变化，我们正式建立了预发布的渠道。我们希望通过这一过程有助于我们胸有成竹地对 React 进行更改，并为开发人员提供尝试试验阶段功能的机会。</p>
<blockquote>
<p>此文章与从事框架，库或开发工具的开发人员息息相关。而主要使用 React 来构建应用程序的开发者无需担心此预发布渠道。</p>
</blockquote>
<p>React 依靠强大的开源社区收集错误报告，pull request 以及 <a href="https://github.com/reactjs/rfcs" target="_blank" rel="nofollow noopener noreferrer">RFC</a>。为了鼓励大家反馈，我们打算共享一些特殊的 React 版本，其中可能包括未发布的功能。</p>
<p>由于 React 的实际来源是<a href="https://github.com/facebook/react" target="_blank" rel="nofollow noopener noreferrer">Github 公有库</a>，因此你始终可以通过此仓库构建一个包含最新修改的 React 副本。但是，对于开发者来说，使用 npm 安装 React 会更加容易，因此我们会时常发布预发布版本到 npm registry 中。最新的示例是 16.7 Alpha 版，其中包括 Hook API 的早期版本。</p>
<p>我们期望开发者更容易地测试 React 的预发布版本，因此我们将通过三个单独的发布渠道来规范我们的流程。</p>
<h2 id="release-channels"><a href="#release-channels" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>发布渠道 </h2>
<blockquote>
<p>本文中的相关信息可以查阅<a href="/docs/release-channels.html">发布渠道</a>章节。每次我们的发布流程发生变化，我们都会更新该流程。</p>
</blockquote>
<p>React 的每个发布渠道都是针对不同的用例进行设计地：</p>
<ul>
<li><a href="#latest-channel"><strong>最新</strong></a>版本用于稳定的 semver React 版本。此版本可通过 npm 安装获取。此渠道为目前大家已经在用的方式。<strong>其主要用于所有面向用户的 React 应用程序。</strong></li>
<li><a href="#next-channel"><strong>Next</strong></a> 版本主要用于追踪 React 源码仓库的 master 分支。我们会将其视为下一个次要版本发布的候选版本。使用它可以进行 React 与第三方项目间的集成测试。</li>
<li><a href="#experimental-channel"><strong>实验阶段</strong></a>版本包含稳定版本中不提供的实验阶段的 API 与功能。同时它也追踪了 master 分支，但启用了附加新功能的标志。使用此渠道可以尝试即将发布的功能。</li>
</ul>
<p>所有版本都将发布到 npm，但只要最新版本遵循<a href="/docs/faq-versioning.html">语义版本控制</a>。预发布版本（应用于 Next 版本和实验渠道的版本）会根据其内容的哈希值生成版本，例如，Next 的版本为 <code class="gatsby-code-text">0.0.0-1022ee0ec</code>，实验版为 <code class="gatsby-code-text">0.0.0-experimental-1022ee0ec</code>。</p>
<p><strong>最新版是面向用户应用程序的唯一官方支持发布渠道</strong>。提供 Next 和实验版本的目的是用于测试，我们并不保证功能在这两个版本中不发生变化。因为它们并不遵循用于最新版发布的 semver 协议。</p>
<p>通过将预发布版发布到与稳定版同一注册表中，我们可以利用许多支持 npm 工作流的工具，诸如 <a href="https://unpkg.com" target="_blank" rel="nofollow noopener noreferrer">unpkg</a> 和 <a href="https://codesandbox.io" target="_blank" rel="nofollow noopener noreferrer">CodeSandbox</a>。 </p>
<h3 id="latest-channel"><a href="#latest-channel" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>最新版渠道 </h3>
<p>最新版是用于稳定 React 版本的渠道。它对应是 npm 中 <code class="gatsby-code-text">latest</code> 标签。此版本是所有交付给真实用户的 React 应用程序的推荐版本。</p>
<p><strong>如果你不确定使用哪个版本，则选择最新版本。</strong>如果你是 React 开发者，那这就是你正确的选择。</p>
<p>你可以希望最新版的更新足够稳定。版本遵循语义版本控制方案。你可以在<a href="/docs/faq-versioning.html">版本政策</a>中详细了解我们对稳定性和增量迁移的承诺。</p>
<h3 id="next-channel"><a href="#next-channel" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Next 版渠道 </h3>
<p>Next 属于预发布渠道，用于追踪 React 仓库的 master 分支。我们在 Next 渠道中使用预发布版本作为最新版发布渠道的候选版本。你可以将 Next 视为最新版的超集，它的更新频率更高。</p>
<p>最新的 Next 发布版与最新的最新发布版之间的更改程度，大致与两个 semver 次版本之间的更改程度相同。但是，<strong>Next 发布渠道不遵循语义版本控制</strong>。你可能希望在 Next 渠道中的后续发布版本之间偶尔有重大更改。</p>
<p><strong>不要在面向用户的应用程序中使用预发布版本。</strong></p>
<p>Next 渠道中的发行版本在 npm 中携带 <code class="gatsby-code-text">next</code> 标签发布。版本会根据构建内容的哈希值生成，例如 <code class="gatsby-code-text">0.0.0-1022ee0ec</code>。</p>
<h4 id="using-the-next-channel-for-integration-testing"><a href="#using-the-next-channel-for-integration-testing" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Next 渠道版本进行集成测试 </h4>
<p>Next 渠道旨在支持 React 与其他项目直接的集成测试。</p>
<p>React 中的所有更改在发布之前都需进行大量的内部测试。但是，在整个 React 生态系统中使用了无数的环境与配置，因此我们不可能针对每一项进行测试。</p>
<p>如果你是 React 第三方框架，库，开发者工具或类似基础设施项目的作者，则可以通过定期针对最新版本运行的测试用例，帮助我们一起维持 React 稳定，为你的用户和整个 React 社区保驾护航。如果你对此有兴趣，请按照下列步骤进行操作：</p>
<ul>
<li>在你喜欢的持续集成平台上设置 cron job。<a href="https://circleci.com/docs/2.0/triggers/#scheduled-builds" target="_blank" rel="nofollow noopener noreferrer">CircleCI</a> 和 <a href="https://docs.travis-ci.com/user/cron-jobs/" target="_blank" rel="nofollow noopener noreferrer">Travis CI</a> 均支持 cron job。</li>
<li>
<p>在 cron job 中，使用 npm 的 <code class="gatsby-code-text">next</code> 标签将 React 版本更新至 Next 渠道中的最新版本。使用 npm cli：</p>
<div class="gatsby-highlight" data-language="text"><pre class="gatsby-code-text"><code class="gatsby-code-text">npm update react@next react-dom@next</code></pre></div>
<p>或者使用 yarn：</p>
<div class="gatsby-highlight" data-language="text"><pre class="gatsby-code-text"><code class="gatsby-code-text">yarn upgrade react@next react-dom@next</code></pre></div>
</li>
<li>针对更新的 packages 执行测试用例。</li>
<li>如果均通过，那么恭喜你！你的项目可以与下个小版本的 React 一起使用。</li>
<li>如果发生意外中断，请通过<a href="https://github.com/facebook/react/issues" target="_blank" rel="nofollow noopener noreferrer">提交 issus</a> 告知我们。</li>
</ul>
<p>Next.js 使用了此工作流。你可以将它们 <a href="https://github.com/zeit/next.js/blob/c0a1c0f93966fe33edd93fb53e5fafb0dcd80a9e/.circleci/config.yml" target="_blank" rel="nofollow noopener noreferrer">CircleCI 配置</a> 作为示例进行参考。</p>
<h3 id="experimental-channel"><a href="#experimental-channel" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实验阶段渠道 </h3>
<p>与 Next 相似，实验阶段通道是一个预发布通道，用于追踪 React 仓库 master 分支。但不同于 Next 的是，实验阶段的发布版本包含尚未准备好广泛推广的功能及 API。</p>
<p>通常，对 Next 更新时也会对实验版本进行更新。它们基于相同的源，但是构建时会使用不同的功能标记。</p>
<p>实验阶段发布的版本可能与 Next 和最新版本的发布均不相同。<strong>不要在面向用户的应用程序中使用实验阶段版本。</strong> 你应该能够想象到实验渠道中发布的版本会频繁进行破坏性更新。</p>
<p>实验版本会在 npm 上会以 <code class="gatsby-code-text">experimental</code> 标签的形式发布。版本会根据构建内容的哈希值生成，例如，<code class="gatsby-code-text">0.0.0-experimental-1022ee0ec</code>。</p>
<h4 id="what-goes-into-an-experimental-release"><a href="#what-goes-into-an-experimental-release" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实验阶段发布包含哪些内容？ </h4>
<p>实验阶段功能并未打算公开发布，在最终确定之前可能会发生巨大变化。有些实验功能可能永远不会完成 —— 我们进行实验的目的是为了测试变更提案的可行性。</p>
<p>例如，如果我们在宣布发布 Hook 时，其已经存在在实验渠道中，我们会在最新版本发布 Hook 之前几周，将其发布到实验渠道中。</p>
<p>你可能会发现针对实验阶段进行集成测试很有必要。但是，请注意，实验阶段版本的稳定性是不如 Next 版本的。<strong>我们并不保证实验版本之间的稳定性。</strong></p>
<h4 id="how-can-i-learn-more-about-experimental-features"><a href="#how-can-i-learn-more-about-experimental-features" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何了解有关实验功能的更多信息？</h4>
<p>实验性的功能可能会有文档，也可能不会有文档。通常，在实验渠道的内容发布到 Next 或 Stable 中之前，才会编写文档。</p>
<p>如果找不到文档，则可能会附有 <a href="https://github.com/reactjs/rfcs" target="_blank" rel="nofollow noopener noreferrer">RFC</a> 说明。</p>
<p>当我们准备发布新的实验内容时，我们会发布到 React 博客中，但这并不意味着我们将公开发布每个实验内容。</p>
<p>欲查看完整的变更列表，你可以参考 Github 公有库中的<a href="https://github.com/facebook/react/commits/master" target="_blank" rel="nofollow noopener noreferrer">历史记录</a>。</p>]]></description><link>https://zh-hans.reactjs.org/blog/2019/10/22/react-release-channels.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2019/10/22/react-release-channels.html</guid><pubDate>Tue, 22 Oct 2019 00:00:00 GMT</pubDate></item><item><title><![CDATA[全新的 React DevTools 简介]]></title><description><![CDATA[<p>我们激动地宣布 React 开发者工具发布了新版本，目前可以在 Chrome，Firefox 以及 （Chromium）Edge 中使用！</p>
<h2 id="whats-changed"><a href="#whats-changed" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>有哪些变化？ </h2>
<p>React DevTools v4 中发生了很多变化！
站在高角度来看，此版本应该可以提供显著的性能提升以及得以改进的导航体验。
它还对 React Hook 进行了全面地支持，包括检查嵌套对象。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/9552e88d7605ef4e547af89096a9225d/cd138/devtools-v4-screenshot.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 46.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABlElEQVQoz22SSU/DMBCF+0vYpGa3szhpFpqmSRegQFlEe0ZAEeIKBw5Q4Jc/xm5aQsXhaTz2+NObsVvc7cCyAzhOAMZDMCZg09p1I5iWB91wYZgeDIpyX4gMupdC5x1oVgDbSxCmJUTSh+OnaGmLJbSnb+w+fGKPdPD4pbT7sMTO3Qfp/TfK89s3iN4xbDeGZgsYLFJQi3IF1IczsPkT+PwZ/Owe48UrJosX7JfX0EYzaHTebqq8ghcXCqg7oZIEt8ktJ/cts1PCLk7B+udg3QnyyQ2KY4L5XRii949yBHGfgKmCSIdrqGy7ZfkZ+GAKd3QJXp7BFF06DKDVRU2tL7LgEFEyQNobwYtW9RK+apmKGM1EAllxAqOejbpct7RprY7SlR/1CDikvAOdxQq6AdoJtZ1WsKhIp2LN9BuOwj+zWkeLZ/CCHF6YwsmmWw67R+DVFM7hmDRSUt+iAWhGg4UQcYm8OoEb0h7lbUvU30ZaTSo1R17RwxQTuMMLGDRb+c/07bYJKh9ExBXCLKe9aPPKjIA/TNYlV65TlpIAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="DevTools version 4 screenshot"
        title=""
        src="/static/9552e88d7605ef4e547af89096a9225d/1e088/devtools-v4-screenshot.png"
        srcset="/static/9552e88d7605ef4e547af89096a9225d/65ed1/devtools-v4-screenshot.png 210w,
/static/9552e88d7605ef4e547af89096a9225d/d10fb/devtools-v4-screenshot.png 420w,
/static/9552e88d7605ef4e547af89096a9225d/1e088/devtools-v4-screenshot.png 840w,
/static/9552e88d7605ef4e547af89096a9225d/cd138/devtools-v4-screenshot.png 1220w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p><a href="https://react-devtools-tutorial.now.sh/" target="_blank" rel="nofollow noopener noreferrer">访问互动教程</a>试用新版本或 <a href="https://github.com/facebook/react/blob/master/packages/react-devtools/CHANGELOG.md#400-august-15-2019" target="_blank" rel="nofollow noopener noreferrer">参阅 changelog</a>，以了解相关演示视频及更多信息。</p>
<h2 id="which-versions-of-react-are-supported"><a href="#which-versions-of-react-are-supported" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>支持哪些版本的 React？</h2>
<p><strong><code class="gatsby-code-text">react-dom</code></strong></p>
<ul>
<li><code class="gatsby-code-text">0</code>-<code class="gatsby-code-text">14.x</code>：不支持</li>
<li><code class="gatsby-code-text">15.x</code>：支持（新的组件过滤特性除外）</li>
<li><code class="gatsby-code-text">16.x</code>：支持</li>
</ul>
<p><strong><code class="gatsby-code-text">react-native</code></strong></p>
<ul>
<li><code class="gatsby-code-text">0</code>-<code class="gatsby-code-text">0.61.x</code>：不支持</li>
<li><code class="gatsby-code-text">0.62</code>：将得到支持 （当 0.62 版本发布时）</li>
</ul>
<h2 id="how-do-i-get-the-new-devtools"><a href="#how-do-i-get-the-new-devtools" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取最新的 DevTools </h2>
<p>React DevTools 可作为 <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi?hl=en" target="_blank" rel="nofollow noopener noreferrer">Chrome</a> 和 <a href="https://addons.mozilla.org/en-US/firefox/addon/react-devtools/" target="_blank" rel="nofollow noopener noreferrer">Firefox</a> 的扩展程序。如果你已安装了此扩展程序，则会在接下来的几小时内自动更新。</p>
<p>如果你使用了独立的 shell （例如：在 ReactNative 或 Safari 中），则可以通过 <a href="https://www.npmjs.com/package/react-devtools" target="_blank" rel="nofollow noopener noreferrer">NPM</a> 安装新版本：</p>
<div class="gatsby-highlight" data-language="shell"><pre class="gatsby-code-shell"><code class="gatsby-code-shell"><span class="token function">npm</span> <span class="token function">install</span> -g react-devtools@^4</code></pre></div>
<h2 id="where-did-all-of-the-dom-elements-go"><a href="#where-did-all-of-the-dom-elements-go" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>所有 DOM 元素去了哪里？ </h2>
<p>新的 DevTools 提供了一种在树中过滤组件的方法，以便更轻松地展示嵌套的层次结构。
宿主节点（例如：HTML <code class="gatsby-code-text">&lt;div&gt;</code>，React Native <code class="gatsby-code-text">&lt;View&gt;</code>）默认<strong>隐藏</strong>，但可以禁用此过滤器：</p>
<p><img src="/758ea5ee734afdda4cd0f6b43c74fbb4/devtools-component-filters.gif" alt="DevTools component filters"></p>
<h2 id="how-do-i-get-the-old-version-back"><a href="#how-do-i-get-the-old-version-back" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何恢复旧版本？ </h2>
<p>如果你使用的是 React Native v0.60（或更早版本），则可以通过 NPM 安装旧版本的 DevTools：</p>
<div class="gatsby-highlight" data-language="shell"><pre class="gatsby-code-shell"><code class="gatsby-code-shell"><span class="token function">npm</span> <span class="token function">install</span> --dev react-devtools@^3</code></pre></div>
<p>对于旧版本的 React DOM（v0.14 或更早版本），你需要通过源代码的方式构建此扩展程序：</p>
<div class="gatsby-highlight" data-language="shell"><pre class="gatsby-code-shell"><code class="gatsby-code-shell"><span class="token comment"># Checkout the extension source</span>
<span class="token function">git</span> clone https://github.com/facebook/react-devtools

<span class="token builtin class-name">cd</span> react-devtools

<span class="token comment"># Checkout the previous release branch</span>
<span class="token function">git</span> checkout v3

<span class="token comment"># Install dependencies and build the unpacked extension</span>
<span class="token function">yarn</span> <span class="token function">install</span>
<span class="token function">yarn</span> build:extension

<span class="token comment"># Follow the on-screen instructions to complete installation</span></code></pre></div>
<h2 id="thank-you"><a href="#thank-you" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>致谢！</h2>
<p>我们要感谢所有测试 DevTools v4 早期版本的小伙伴。
你的反馈将有助于显著改善此早期版本</p>
<p>我们仍然计划了许多令人兴奋的特性，欢迎提出建议！
如有疑问，请开启 <a href="https://github.com/facebook/react/issues/new?labels=Component:%20Developer%20Tools" target="_blank" rel="nofollow noopener noreferrer">GitHub issue</a> 或者直接在 <a href="https://twitter.com/reactjs" target="_blank" rel="nofollow noopener noreferrer">Twitter 上 @reactjs </a>。</p>]]></description><link>https://zh-hans.reactjs.org/blog/2019/08/15/new-react-devtools.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2019/08/15/new-react-devtools.html</guid><pubDate>Thu, 15 Aug 2019 00:00:00 GMT</pubDate></item><item><title><![CDATA[React v16.9.0 发布及 Roadmap 最新进展]]></title><description><![CDATA[<p>今天我们发布了 React 16.9。它包含几个新功能，bug 修复以及新的弃用警告，以助于筹备接下来的主要版本。</p>
<h2 id="new-deprecations"><a href="#new-deprecations" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新的弃用 </h2>
<h3 id="renaming-unsafe-lifecycle-methods"><a href="#renaming-unsafe-lifecycle-methods" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重命名 Unsafe 的生命周期方法 </h3>
<p><a href="/blog/2018/03/27/update-on-async-rendering.html">一年前</a>，我们宣布新的 unsafe 的生命周期方法正在进行重命名：</p>
<ul>
<li><code class="gatsby-code-text">componentWillMount</code> → <code class="gatsby-code-text">UNSAFE_componentWillMount</code></li>
<li><code class="gatsby-code-text">componentWillReceiveProps</code> → <code class="gatsby-code-text">UNSAFE_componentWillReceiveProps</code></li>
<li><code class="gatsby-code-text">componentWillUpdate</code> → <code class="gatsby-code-text">UNSAFE_componentWillUpdate</code></li>
</ul>
<p><strong>React 16.9 未包含破坏性更改，并且旧的生命周期方法名在此版本继续沿用。</strong> 但当你使用旧的生命周期方法名时，你将看到如下警告：</p>
<p><img src="https://i.imgur.com/sngxSML.png" alt="Warning: componentWillMount has been renamed, and is not recommended for use."></p>
<p>正如警告所示，对于每种 unsafe 的方法来说，通常都有<a href="/blog/2018/03/27/update-on-async-rendering.html#migrating-from-legacy-lifecycles">更好的解决方案</a>。但你可能没有时间迁移或测试这些组件。在这种情况下，我们建议你运行一个自动重命名的 <a href="https://medium.com/@cpojer/effective-javascript-codemods-5a6686bb46fb" target="_blank" rel="nofollow noopener noreferrer">“codemod”</a> 脚本：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token builtin class-name">cd</span> your_project
npx react-codemod rename-unsafe-lifecycles</code></pre></div>
<p><em>（请注意，这里使用了 <code class="gatsby-code-text">npx</code>，而非 <code class="gatsby-code-text">npm</code>。<code class="gatsby-code-text">npx</code> 是 Node 6+ 默认提供的实用工具）</em></p>
<p>运行 codemod 会将旧的生命周期方法名替换，例如 <code class="gatsby-code-text">componentWillMount</code> 会被替换为 <code class="gatsby-code-text">UNSAFE_componentWillMount</code>：</p>
<p><img src="https://i.imgur.com/Heyvcyi.gif" alt="Codemod in action"></p>
<p>新的方法名（如 <code class="gatsby-code-text">UNSAFE_componentWillMount</code>）<strong>在 React 16.9 和 React 17.x 中，仍可以继续使用</strong>。但是，新的 <code class="gatsby-code-text">UNSAFE_</code> 前缀将有助于在代码 review 和 debug 期间，使这些有问题的字样更突出。（你也可以按照自己的意愿，在你的应用中选择性的引入 <a href="/docs/strict-mode.html">严格模式（Strict Mode）</a> 来进一步阻止大家使用它们）。</p>
<blockquote>
<p>注意</p>
<p>了解更多关于 <a href="/docs/faq-versioning.html#commitment-to-stability">版本策略及对稳定性的承诺</a>。</p>
</blockquote>
<h3 id="deprecating-javascript-urls"><a href="#deprecating-javascript-urls" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>废弃 <code class="gatsby-code-text">javascript:</code> 形式的 URL </h3>
<p>以 <code class="gatsby-code-text">javascript:</code> 开头的 URL 非常容易遭受攻击，因为它很容易在诸如 <code class="gatsby-code-text">&lt;a href&gt;</code> 之类的标签中引入未经过处理的输出并会造成安全漏洞：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">const</span> userProfile <span class="token operator">=</span> <span class="token punctuation">{</span>
  website<span class="token operator">:</span> <span class="token string">"javascript: alert('you got hacked')"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 此处现在会有警告</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>userProfile<span class="token punctuation">.</span>website<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Profile</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre></div>
<p><strong>在 React 16.9 中，</strong> 这种模式将继续有效，但它将输出一个警告。如果你需使用 <code class="gatsby-code-text">javascript:</code> 形式的 URL 作为逻辑，请尝试使用 React 的事件处理程序替代。（万不得已时，你可以使用 <a href="/docs/dom-elements.html#dangerouslysetinnerhtml"><code class="gatsby-code-text">dangerouslySetInnerHTML</code></a> 来规避保护，但是这样并不被推荐且经常导致安全漏洞。）</p>
<p><strong>未来的主要版本中，</strong> 如果遇到 <code class="gatsby-code-text">javascript:</code> 形式的 URL，React 将抛出错误。</p>
<h3 id="deprecating-factory-components"><a href="#deprecating-factory-components" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>废弃 “Factory” 组件 </h3>
<p>在使用 Babel 编译 JavaScript Class 成为主流前，React 支持 “factory” 组件，该组件使用 <code class="gatsby-code-text">render</code> 方法返回一个对象：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">FactoryComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这种方式令人困惑，因为它看起来像函数组件 —— 但它并不是。（函数组件只返回示例中的 <code class="gatsby-code-text">&lt;div /&gt;</code>。）</p>
<p>这种方式几乎从未被广泛使用过，并且支持它会导致 React 变大且变慢。因此，我们在 16.9 中逐步弃用此模式，并在遇到时输出警告。如果项目中依赖了此组件，可以通过添加 <code class="gatsby-code-text">FactoryComponent.prototype = React.Component.prototype</code> 作为解决方案。或者你可以直接将其转换为 class 组件或函数组件。</p>
<p>我们不希望大多数代码库受到此影响。</p>
<h2 id="new-features"><a href="#new-features" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新特性 </h2>
<h3 id="async-act-for-testing"><a href="#async-act-for-testing" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用于测试的异步函数 <a href="/docs/test-utils.html#act"><code class="gatsby-code-text">act()</code></a> </h3>
<p><a href="/blog/2019/02/06/react-v16.8.0.html">React 16.8</a> 引入了名为 <a href="/docs/test-utils.html#act"><code class="gatsby-code-text">act()</code></a> 的新测试实用工具来帮助你编写更符合浏览器行为的测试代码。例如，单个 <code class="gatsby-code-text">act()</code> 中的多个状态更新会进行批处理。这与 React 在处理真实浏览器事件时的工作方式相匹配，并有助于为将来 React 更频繁地批量更新组件做准备。</p>
<p>然而，在 16.8 中的 <code class="gatsby-code-text">act()</code> 仅支持同步函数。有时，你可能会在测试时看到类似的警告，但<a href="https://github.com/facebook/react/issues/14769" target="_blank" rel="nofollow noopener noreferrer">无法轻易修复</a>：</p>
<div class="gatsby-highlight" data-language="text"><pre class="gatsby-code-text"><code class="gatsby-code-text">An update to SomeComponent inside a test was not wrapped in act(...).</code></pre></div>
<p><strong>在 React 16.9 中，<code class="gatsby-code-text">act()</code> 也支持异步函数，</strong> 并且你可以在调用它时使用 <code class="gatsby-code-text">await</code>：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">await</span> <span class="token function">act</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>这就解决了之前无法使用 <code class="gatsby-code-text">act()</code> 的情况，如当 state 更新发生在异步函数内时。因此 <strong>现在你应该能在测试中修复所有有关 <code class="gatsby-code-text">act()</code> 的警告了。</strong></p>
<p>我们了解到没有足够的信息来说明如何使用 <code class="gatsby-code-text">act()</code> 来编写测试。新的<a href="/docs/testing-recipes.html">测试技巧</a>一文描述了场景的场景，以及 <code class="gatsby-code-text">act()</code> 如何帮助你编写优秀的测试。这些示例采用了原生 DOM API，但你可以使用 <a href="https://testing-library.com/docs/react-testing-library/intro" target="_blank" rel="nofollow noopener noreferrer">React Testing Library</a> 来减少样板代码（boilerplate code）。它的许多方法已经在实现上运用了 <code class="gatsby-code-text">act()</code>。</p>
<p>如果你遇到 <code class="gatsby-code-text">act()</code> 的相关问题，请提出 <a href="https://github.com/facebook/react/issues" target="_blank" rel="nofollow noopener noreferrer">issue</a> 告知我们，我们会尽力提供帮助。</p>
<h3 id="performance-measurements-with-reactprofiler"><a href="#performance-measurements-with-reactprofiler" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 <a href="/docs/profiler.html"><code class="gatsby-code-text">&lt;React.Profiler&gt;</code></a> 进行性能评估 </h3>
<p>在 React 16.5 中，我们推出了新的 <a href="/blog/2018/09/10/introducing-the-react-profiler.html">React Profiler for DevTools</a>，它可以帮你找出应用程序中的性能瓶颈。<strong>在 React 16.9 中，我们还提供了一种通过<em>编程</em>的方式来收集测量你的代码</strong>，这种方式被称为 <code class="gatsby-code-text">&lt;React.Profiler&gt;</code>。我们预计大多数较小的应用都不会使用它，但在较大的应用中追踪性能回归可能会很方便。</p>
<p><code class="gatsby-code-text">&lt;Profiler&gt;</code> 能测量 React 应用程序渲染的频率以及渲染的 “成本”。其目的是帮助标识应用程序中渲染缓慢的部分，并可能会更易于进行 <a href="/docs/hooks-faq.html#how-to-memoize-calculations">memoization</a> 等优化。</p>
<p><code class="gatsby-code-text">&lt;Profiler&gt;</code> 可以在 React 树中的任意位置添加，以评估渲染树中对应位置的成本。
它依赖两个 props：<code class="gatsby-code-text">id</code> (string) 和 <a href="/docs/profiler.html#onrender-callback"><code class="gatsby-code-text">onRender</code> 回调</a> (function)，当树中的组件 “提交（commit）” 更新时， React 就会调用它。</p>
<div class="gatsby-highlight has-highlighted-lines" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token function">render</span><span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Profiler</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application<span class="token punctuation">"</span></span> <span class="token attr-name">onRender</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onRenderCallback<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span></span><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Navigation</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text"></span>
<span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Main</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text"></span>
<span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">App</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="gatsby-highlight-code-line"><span class="token plain-text">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Profiler</span></span><span class="token punctuation">></span></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p> 欲了解有关 <code class="gatsby-code-text">Profiler</code> 和传递给 <code class="gatsby-code-text">onRender</code> 回调参数的更多信息，请参阅 <a href="/docs/profiler.html"><code class="gatsby-code-text">Profiler</code> 文档</a>。</p>
<blockquote>
<p>注意:</p>
<p>性能分析会增加额外的开销，因此它<strong>在<a href="https://reactjs.org/docs/optimizing-performance.html#use-the-production-build" target="_blank" rel="nofollow noopener noreferrer">生产构建</a>中会被禁用</strong>。</p>
<p>如果想要在生产环境进行性能分析，React 提供了一个特殊的生成构建，并启用了分析模式。
在 <a href="https://fb.me/react-profiling" target="_blank" rel="nofollow noopener noreferrer">fb.me/react-profiling</a> 中阅读有关如何使用此构建的更多信息。</p>
</blockquote>
<h2 id="notable-bugfixes"><a href="#notable-bugfixes" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>值得注意的 bug 修复 </h2>
<p>此版本包含一些其他显著的改进：</p>
<ul>
<li>在 <code class="gatsby-code-text">&lt;Suspense&gt;</code> 树中调用 <code class="gatsby-code-text">findDOMNode()</code> 时出现崩溃的情况。<a href="https://github.com/facebook/react/pull/15312" target="_blank" rel="nofollow noopener noreferrer">已修复</a>。</li>
<li>保留已删除的子树导致的内存泄露。<a href="https://github.com/facebook/react/pull/16115" target="_blank" rel="nofollow noopener noreferrer">已修复</a>。</li>
<li>由 <code class="gatsby-code-text">useEffect</code> 中 <code class="gatsby-code-text">setState</code> 引起的无限循环，现在会<a href="https://github.com/facebook/react/pull/15180" target="_blank" rel="nofollow noopener noreferrer">输出错误</a>。（这与在 class 组件中的 <code class="gatsby-code-text">componentDidUpdate</code> 调用 <code class="gatsby-code-text">setState</code> 时看到的错误一致。）</li>
</ul>
<p>感谢所有帮助解决这些问题的贡献者。你可以在<a href="#changelog">此处</a>找到完整的更新日志。</p>
<h2 id="an-update-to-the-roadmap"><a href="#an-update-to-the-roadmap" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Roadmap 的进展 </h2>
<p><a href="/blog/2018/11/27/react-16-roadmap.html">2018 年 11 月</a>我们发布了 16.x 版本的 roadmap：</p>
<ul>
<li>实现 React Hooks 的 16.x 小版本（预估：Q1 2019）</li>
<li>实现 Concurrent Mode 的 16.x 小版本 (预估：Q2 2019)</li>
<li>实现 Suspense for Data Fetching (预估：2019 年中)</li>
</ul>
<p>这些预估过于理想化，我们需要进行调整。</p>
<p><strong>tldr：</strong> 我们按时发布了 Hook，但我们正在将 Concurrent Mode 和 Suspense for Data Fetching 重组为今年晚些时候的单个版本。</p>
<p>2 月份时，我们在<a href="/blog/2019/02/06/react-v16.8.0.html">发布的稳定 16.8 版本</a>中引入了 React Hook，React Native 在<a href="https://reactnative.dev/blog/2019/03/12/releasing-react-native-059" target="_blank" rel="nofollow noopener noreferrer">一个月后</a>也进行了支持。但是，我们低估了此版本的后续工作，其中包括 lint 规则，developer tools，示例以及更多文档。这使得时间线发生了改变。</p>
<p>现在 React Hook 已经推出，Concurrent Mode 和 Suspense for Data Fetching 的工作正在全面展开。<a href="https://twitter.com/facebook/status/1123322299418124289" target="_blank" rel="nofollow noopener noreferrer">目前正在进行 Facebook 新网站的研发工作</a> 是建立在这些特性基础之上的。使用真实代码环境对它们进行测试有助于在影响开源用户之前发现并解决许多未知问题。其中一些修复涉及到这些特性的内部重新设计，这也导致时间的推迟。</p>
<p>望大家理解，这就是我们接下来的计划。</p>
<h3 id="one-release-instead-of-two"><a href="#one-release-instead-of-two" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个版本而不是两个版本 </h3>
<p>Concurrent Mode 和 Suspense <a href="https://developers.facebook.com/videos/2019/building-the-new-facebookcom-with-react-graphql-and-relay/" target="_blank" rel="nofollow noopener noreferrer">驱动了 Facebook 新网站的研发</a>，这个项目目前在积极的开发中，因此我们可以很自信的说，从技术上讲，Concurrent Mode 和 Suspense 已近乎稳定了。同时，我们也更加清楚，在它们被开源使用之前我们应该具体做哪些步骤。</p>
<p>最开始，我们觉得为了实现 Data Fetching（数据请求），我们需要把 Concurrent Mode 和 Suspense 拆分为两个版本。后来我们发现，这个顺序很难说的通，因为这些特性之间的关系比我们当初想象的更为密切。因此，我们计划为 Data Fetching 发布一个同时支持 Concurrent Mode 和 Suspense 的单个版本。</p>
<p>我们不想再次过度承诺发布日期。考虑到我们在生产环境的代码中同时依赖了这两者，我们期望今年的 16.x 的某个版本中，支持可以选择性的使用它们。</p>
<h3 id="an-update-on-data-fetching"><a href="#an-update-on-data-fetching" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Data Fetching 的进展 </h3>
<p>虽然 React 没有规定你如何请求数据，但是第一版用来请求数据的 Suspense 很有可能专注于集成<em>固定的数据请求库</em>。比如，在 Facebook，我们正在使用即将发布的集成了 Suspense 的 Relay APIs。我们也将会给出对其他库（比如 Apollo）做类似的整合的文档。</p>
<p>在第一个版本中，我们<em>并没有</em>打算专注于我们在早期演示中（也称为“React Cache”）使用的临时 “触发HTTP请求” 解决方案。但是，我们希望我们和 React 社区将在首次发布后的几个月内仍会在这个领域继续探索。</p>
<h3 id="an-update-on-server-rendering"><a href="#an-update-on-server-rendering" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务端渲染的进展 </h3>
<p>我们已经开始研究<a href="/blog/2018/11/27/react-16-roadmap.html#suspense-for-server-rendering">新的支持 Suspense 的服务器端渲染引擎</a>，但是我们<em>不认为</em>它在并发模式的最初版本将会就绪。然而，这个版本将会提供一个临时的解决方案，这个方案可以让现有的服务端渲染引擎在 Suspense 的回调函数中立即生成 HTML，然后在客户端渲染出真正的内容。这就是我们在流式渲染引擎就绪之前，当前在 Facebook 内部使用的方案。</p>
<h3 id="why-is-it-taking-so-long"><a href="#why-is-it-taking-so-long" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么要花费这么久时间？</h3>
<p>随着每个单独的部件趋于稳定，我们将它们迁移到了并发模式中，其中包括了 <a href="/blog/2018/03/29/react-v-16-3.html">新的 context API</a>、<a href="/blog/2018/10/23/react-v-16-6.html">含有 Suspense 的懒加载</a> 以及 <a href="/blog/2019/02/06/react-v16.8.0.html">Hook</a>。我们也十分期望发布其他缺失的部分，但是<a href="/docs/design-principles.html#dogfooding">大规模尝试它们</a>是这个过程中一个很重要的部分。坦诚地说，我们比最开始预想投入了更多的工作。我们会一如既往，感谢你在 <a href="https://twitter.com/reactjs" target="_blank" rel="nofollow noopener noreferrer">Twitter</a> 和 <a href="https://github.com/facebook/react/issues" target="_blank" rel="nofollow noopener noreferrer">问题跟踪</a> 中提出的问题和反馈。</p>
<h2 id="installation"><a href="#installation" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 </h2>
<h3 id="react"><a href="#react" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React </h3>
<p>npm registry 中提供了 React v16.9.0。</p>
<p>使用 yarn 安装 React 16，执行如下命令：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token function">yarn</span> <span class="token function">add</span> react@^16.9.0 react-dom@^16.9.0</code></pre></div>
<p>使用 npm 安装 React 16，执行如下命令：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token function">npm</span> <span class="token function">install</span> --save react@^16.9.0 react-dom@^16.9.0</code></pre></div>
<p>我们还通过 CDN 提供了 React 的 UMD 版本：</p>
<div class="gatsby-highlight" data-language="html"><pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react@16/umd/react.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@16/umd/react-dom.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>请参阅<a href="/docs/installation.html">详细安装说明文档</a>。</p>
<h2 id="changelog"><a href="#changelog" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Changelog </h2>
<h3 id="react"><a href="#react" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React </h3>
<ul>
<li>提供 <code class="gatsby-code-text">&lt;React.Profiler&gt;</code> API 实现以编程的方式进行性能评估。(<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> in <a href="https://github.com/facebook/react/pull/15172" target="_blank" rel="nofollow noopener noreferrer">#15172</a>)</li>
<li>删除 <code class="gatsby-code-text">unstable_ConcurrentMode</code> 以支持 <code class="gatsby-code-text">unstable_createRoot</code>。(<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> in <a href="https://github.com/facebook/react/pull/15532" target="_blank" rel="nofollow noopener noreferrer">#15532</a>)</li>
</ul>
<h3 id="react-dom"><a href="#react-dom" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React DOM </h3>
<ul>
<li>弃用以 <code class="gatsby-code-text">UNSAFE_*</code> 开头的旧生命周期方法。(<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> in <a href="https://github.com/facebook/react/pull/15186" target="_blank" rel="nofollow noopener noreferrer">#15186</a> and <a href="https://github.com/threepointone" target="_blank" rel="nofollow noopener noreferrer">@threepointone</a> in <a href="https://github.com/facebook/react/pull/16103" target="_blank" rel="nofollow noopener noreferrer">#16103</a>)</li>
<li>弃用 <code class="gatsby-code-text">javascript:</code> 形式的 URL。 (<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> in <a href="https://github.com/facebook/react/pull/15047" target="_blank" rel="nofollow noopener noreferrer">#15047</a>)</li>
<li>弃用不常用的 “module pattern” (factory) 组件。 (<a href="https://github.com/sebmarkbage" target="_blank" rel="nofollow noopener noreferrer">@sebmarkbage</a> in <a href="https://github.com/facebook/react/pull/15145" target="_blank" rel="nofollow noopener noreferrer">#15145</a>)</li>
<li>在 <code class="gatsby-code-text">&lt;video&gt;</code> 组件上添加对 <code class="gatsby-code-text">disablePictureInPicture</code> 属性的支持。(<a href="https://github.com/eek" target="_blank" rel="nofollow noopener noreferrer">@eek</a> in <a href="https://github.com/facebook/react/pull/15334" target="_blank" rel="nofollow noopener noreferrer">#15334</a>)</li>
<li>为 <code class="gatsby-code-text">&lt;embed&gt;</code> 添加对 <code class="gatsby-code-text">onLoad</code> 事件的支持。(<a href="https://github.com/cherniavskii" target="_blank" rel="nofollow noopener noreferrer">@cherniavskii</a> in <a href="https://github.com/facebook/react/pull/15614" target="_blank" rel="nofollow noopener noreferrer">#15614</a>)</li>
<li>为在 DevTools 中编辑 <code class="gatsby-code-text">useState</code> 的 state 提供支持。(<a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">@bvaughn</a> in <a href="https://github.com/facebook/react/pull/14906" target="_blank" rel="nofollow noopener noreferrer">#14906</a>)</li>
<li>为在 DevTools 中切换 Suspense 提供支持。(<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> in <a href="https://github.com/facebook/react/pull/15232" target="_blank" rel="nofollow noopener noreferrer">#15232</a>)</li>
<li>当 <code class="gatsby-code-text">setState</code> 在 <code class="gatsby-code-text">useEffect</code> 中循环调用时，发出警告。(<a href="https://github.com/gaearon" target="_blank" rel="nofollow noopener noreferrer">@gaearon</a> in <a href="https://github.com/facebook/react/pull/15180" target="_blank" rel="nofollow noopener noreferrer">#15180</a>)</li>
<li>修复内存泄露。(<a href="https://github.com/paulshen" target="_blank" rel="nofollow noopener noreferrer">@paulshen</a> in <a href="https://github.com/facebook/react/pull/16115" target="_blank" rel="nofollow noopener noreferrer">#16115</a>)</li>
<li>修复 <code class="gatsby-code-text">&lt;Suspense&gt;</code> 包裹的组件中使用 <code class="gatsby-code-text">findDOMNode</code> 发生崩溃的问题。(<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> in <a href="https://github.com/facebook/react/pull/15312" target="_blank" rel="nofollow noopener noreferrer">#15312</a>)</li>
<li>修复因为刷新太晚而导致 pending effect 的情况。(<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> in <a href="https://github.com/facebook/react/pull/15650" target="_blank" rel="nofollow noopener noreferrer">#15650</a>)</li>
<li>修复警告信息中不正确的参数顺序。(<a href="https://github.com/brickspert" target="_blank" rel="nofollow noopener noreferrer">@brickspert</a> in <a href="https://github.com/facebook/react/pull/15345" target="_blank" rel="nofollow noopener noreferrer">#15345</a>)</li>
<li>修复当存在 <code class="gatsby-code-text">!important</code> 样式时，隐藏 Suspense 降级节点的问题。(<a href="https://github.com/acdlite" target="_blank" rel="nofollow noopener noreferrer">@acdlite</a> in <a href="https://github.com/facebook/react/pull/15861" target="_blank" rel="nofollow noopener noreferrer">#15861</a> and <a href="https://github.com/facebook/react/pull/15882" target="_blank" rel="nofollow noopener noreferrer">#15882</a>)</li>
<li>提高 hydration 的性能。(<a href="https://github.com/bmeurer" target="_blank" rel="nofollow noopener noreferrer">@bmeurer</a> in <a href="https://github.com/facebook/react/pull/15998" target="_blank" rel="nofollow noopener noreferrer">#15998</a>)</li>
</ul>
<h3 id="react-dom-server"><a href="#react-dom-server" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React DOM Server </h3>
<ul>
<li>修复 camelCase 自定义 CSS 属性名称的错误输出。(<a href="https://github.com/bedakb" target="_blank" rel="nofollow noopener noreferrer">@bedakb</a> in <a href="https://github.com/facebook/react/pull/16167" target="_blank" rel="nofollow noopener noreferrer">#16167</a>)</li>
</ul>
<h3 id="react-test-utilities-and-test-renderer"><a href="#react-test-utilities-and-test-renderer" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React Test Utilities and Test Renderer </h3>
<ul>
<li>添加 <code class="gatsby-code-text">act(async () =&gt; ...)</code> 来测试异步状态更新。(<a href="https://github.com/threepointone" target="_blank" rel="nofollow noopener noreferrer">@threepointone</a> in <a href="https://github.com/facebook/react/pull/14853" target="_blank" rel="nofollow noopener noreferrer">#14853</a>)</li>
<li>添加对不同渲染器嵌套 <code class="gatsby-code-text">act</code> 的支持。 (<a href="https://github.com/threepointone" target="_blank" rel="nofollow noopener noreferrer">@threepointone</a> in <a href="https://github.com/facebook/react/pull/16039" target="_blank" rel="nofollow noopener noreferrer">#16039</a> and <a href="https://github.com/facebook/react/pull/16042" target="_blank" rel="nofollow noopener noreferrer">#16042</a>)</li>
<li>在严格模式下，如果副作用函数在 <code class="gatsby-code-text">act</code> 之外被调用，就会发出警告。(<a href="https://github.com/threepointone" target="_blank" rel="nofollow noopener noreferrer">@threepointone</a> in <a href="https://github.com/facebook/react/pull/15763" target="_blank" rel="nofollow noopener noreferrer">#15763</a> and <a href="https://github.com/facebook/react/pull/16041" target="_blank" rel="nofollow noopener noreferrer">#16041</a>)</li>
<li>当在错误的渲染器中使用 <code class="gatsby-code-text">act</code> 时发出警告。(<a href="https://github.com/threepointone" target="_blank" rel="nofollow noopener noreferrer">@threepointone</a> in <a href="https://github.com/facebook/react/pull/15756" target="_blank" rel="nofollow noopener noreferrer">#15756</a>)</li>
</ul>]]></description><link>https://zh-hans.reactjs.org/blog/2019/08/08/react-v16.9.0.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2019/08/08/react-v16.9.0.html</guid><pubDate>Thu, 08 Aug 2019 00:00:00 GMT</pubDate></item><item><title><![CDATA[Is React Translated Yet? ¡Sí! Sim! はい！]]></title><description><![CDATA[<p>We’re excited to announce an ongoing effort to maintain official translations of the React documentation website into different languages. Thanks to the dedicated efforts of React community members from around the world, React is now being translated into <em>over 30</em> languages! You can find them on the new <a href="/languages">Languages</a> page.</p>
<p>In addition, the following three languages have completed translating most of the React Docs! 🎉</p>
<ul>
<li><strong>Spanish: <a href="https://es.reactjs.org" target="_blank" rel="nofollow noopener noreferrer">es.reactjs.org</a></strong></li>
<li><strong>Japanese: <a href="https://ja.reactjs.org" target="_blank" rel="nofollow noopener noreferrer">ja.reactjs.org</a></strong></li>
<li><strong>Brazilian Portuguese: <a href="https://pt-br.reactjs.org" target="_blank" rel="nofollow noopener noreferrer">pt-br.reactjs.org</a></strong></li>
</ul>
<p>Special congratulations to <a href="https://github.com/alejandronanez" target="_blank" rel="nofollow noopener noreferrer">Alejandro Ñáñez Ortiz</a>, <a href="https://github.com/carburo" target="_blank" rel="nofollow noopener noreferrer">Rainer Martínez Fraga</a>, <a href="https://github.com/dmorales" target="_blank" rel="nofollow noopener noreferrer">David Morales</a>, <a href="https://github.com/Darking360" target="_blank" rel="nofollow noopener noreferrer">Miguel Alejandro Bolivar Portilla</a>, and all the contributors to the Spanish translation for being the first to <em>completely</em> translate the core pages of the docs!</p>
<h2 id="why-localization-matters"><a href="#why-localization-matters" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why Localization Matters </h2>
<p>React already has many meetups and conferences around the world, but many programmers don’t use English as their primary language. We’d love to support local communities who use React by making our documentation available in most popular languages.</p>
<p>In the past, React community members have created unofficial translations for <a href="https://github.com/discountry/react" target="_blank" rel="nofollow noopener noreferrer">Chinese</a>, <a href="https://wiki.hsoub.com/React" target="_blank" rel="nofollow noopener noreferrer">Arabic</a>, and <a href="https://github.com/reactjs/ko.reactjs.org/issues/4" target="_blank" rel="nofollow noopener noreferrer">Korean</a>; by making an official channel for these translated docs we’re hoping to make them easier to find and help make sure that non-English-speaking users of React aren’t left behind.</p>
<h2 id="contributing"><a href="#contributing" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Contributing </h2>
<p>If you would like to help out on a current translation, check out the <a href="/languages">Languages</a> page and click on the “Contribute” link for your language.</p>
<p>Can’t find your language? If you’d like to maintain your language’s translation fork, follow the instructions in the <a href="https://github.com/reactjs/reactjs.org-translation#starting-a-new-translation" target="_blank" rel="nofollow noopener noreferrer">translation repo</a>!</p>
<h2 id="backstory"><a href="#backstory" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Backstory </h2>
<p>Hi everyone! I’m <a href="https://twitter.com/tesseralis" target="_blank" rel="nofollow noopener noreferrer">Nat</a>! You may know me as the <a href="https://www.youtube.com/watch?v=Ew-UzGC8RqQ" target="_blank" rel="nofollow noopener noreferrer">polyhedra lady</a>. For the past few weeks, I’ve been helping the React team coordinate their translation effort. Here’s how I did it.</p>
<p>Our original approach for translations was to use a SaaS platform that allows users to submit translations. There was already a <a href="https://github.com/reactjs/reactjs.org/pull/873" target="_blank" rel="nofollow noopener noreferrer">pull request</a> to integrate it and my original responsibility was to finish that integration. However, we had concerns about the feasibility of that integration and the current quality of translations on the platform. Our primary concern was ensuring that translations kept up to date with the main repo and didn’t become “stale”.</p>
<p><a href="https://twitter.com/dan_abramov" target="_blank" rel="nofollow noopener noreferrer">Dan</a> encouraged me to look for alternate solutions, and we stumbled across how <a href="https://vuejs.org" target="_blank" rel="nofollow noopener noreferrer">Vue</a> maintained its translations — through different forks of the main repo on GitHub. In particular, the <a href="https://jp.vuejs.org" target="_blank" rel="nofollow noopener noreferrer">Japanese translation</a> used a bot to periodically check for changes in the English repo and submits pull requests whenever there is a change.</p>
<p>This approach appealed to us for several reasons:</p>
<ul>
<li>It was less code integration to get off the ground.</li>
<li>It encouraged active maintainers for each repo to ensure quality.</li>
<li>Contributors already understand GitHub as a platform and are motivated to contribute directly to the React organization.</li>
</ul>
<p>We started off with an initial trial period of three languages: Spanish, Japanese, and Simplified Chinese. This allowed us to work out any kinks in our process and make sure future translations are set up for success. I wanted to give the translation teams freedom to choose whatever tools they felt comfortable with. The only requirement is a <a href="https://github.com/reactjs/reactjs.org-translation/blob/master/PROGRESS.template.md" target="_blank" rel="nofollow noopener noreferrer">checklist</a> that outlines the order of importance for translating pages. </p>
<p>After the trial period, we were ready to accept more languages. I created <a href="https://github.com/reactjs/reactjs.org-translation/blob/master/scripts/create.js" target="_blank" rel="nofollow noopener noreferrer">a script</a> to automate the creation of the new language repo, and a site, <a href="https://isreacttranslatedyet.com" target="_blank" rel="nofollow noopener noreferrer">Is React Translated Yet?</a>, to track progress on the different translations. We started <em>10</em> new translations on our first day alone!</p>
<p>Because of the automation, the rest of the maintenance went mostly smoothly. We eventually created a <a href="https://rt-slack-invite.herokuapp.com" target="_blank" rel="nofollow noopener noreferrer">Slack channel</a> to make it easier for translators to share information, and I released a guide solidifying the <a href="https://github.com/reactjs/reactjs.org-translation/blob/master/maintainer-guide.md" target="_blank" rel="nofollow noopener noreferrer">responsibilities of maintainers</a>. Allowing translators to talk with each other was a great boon — for example, the Arabic, Persian, and Hebrew translations were able to talk to each other in order to get <a href="https://en.wikipedia.org/wiki/Right-to-left" target="_blank" rel="nofollow noopener noreferrer">right-to-left text</a> working!</p>
<h2 id="the-bot"><a href="#the-bot" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Bot </h2>
<p>The most challenging part was getting the bot to sync changes from the English version of the site. Initially we were using the <a href="https://github.com/vuejs-jp/che-tsumi" target="_blank" rel="nofollow noopener noreferrer">che-tsumi</a> bot created by the Japanese Vue translation team, but we soon decided to build our own bot to suit our needs. In particular, the che-tsumi bot works by <a href="https://git-scm.com/docs/git-cherry-pick" target="_blank" rel="nofollow noopener noreferrer">cherry picking</a> new commits. This ended up causing a cavalade of new issues that were interconnected, especially when <a href="/blog/2019/02/06/react-v16.8.0.html">Hooks were released</a>.</p>
<p>In the end, we decided that instead of cherry picking each commit, it made more sense to merge all new commits and create a pull request around once a day. Conflicts are merged as-is and listed in the <a href="https://github.com/reactjs/pt-BR.reactjs.org/pull/114" target="_blank" rel="nofollow noopener noreferrer">pull request</a>, leaving a checklist for maintainers to fix.</p>
<p>Creating the <a href="https://github.com/reactjs/reactjs.org-translation/blob/master/scripts/sync.js" target="_blank" rel="nofollow noopener noreferrer">sync script</a> was easy enough: it downloads the translated repo, adds the original as a remote, pulls from it, merges the conflicts, and creates a pull request.</p>
<p>The problem was finding a place for the bot to run. I’m a frontend developer for a reason — Heroku and its ilk are alien to me and <em>endlessly</em> frustrating. In fact, until this past Tuesday, I was running the script by hand on my local machine!</p>
<p>The biggest challenge was space. Each fork of the repo is around 100MB — which takes minutes to clone on my local machine. We have <em>32</em> forks, and the free tiers of most deployment platforms I checked limited you to 512MB of storage. </p>
<p>After lots of notepad calculations, I found a solution: delete each repo once we’ve finished the script and limit the concurrency of <code class="gatsby-code-text">sync</code> scripts that run at once to be within the storage requirements. Luckily, Heroku dynos have a much faster Internet connection and are able to clone even the React repo quickly.</p>
<p>There were other smaller issues that I ran into. I tried using the <a href="https://elements.heroku.com/addons/scheduler" target="_blank" rel="nofollow noopener noreferrer">Heroku Scheduler</a> add-on so I didn’t have to write any actual <code class="gatsby-code-text">watch</code> code, but it end up running too inconsistently, and I <a href="https://twitter.com/tesseralis/status/1097387938088796160" target="_blank" rel="nofollow noopener noreferrer">had an existential meltdown on Twitter</a> when I couldn’t figure out how to send commits from the Heroku dyno. But in the end, this frontend engineer was able to get the bot working!</p>
<p>There are, as always, improvements I want to make to the bot. Right now it doesn’t check whether there is an outstanding pull request before pushing another one. It’s still hard to tell the exact change that happened in the original source, and it’s possible to miss out on a needed translation change. But I trust the maintainers we’ve chosen to work through these issues, and the bot is <a href="https://github.com/reactjs/reactjs.org-translation" target="_blank" rel="nofollow noopener noreferrer">open source</a> if anyone wants to help me make these improvements!</p>
<h2 id="thanks"><a href="#thanks" aria-hidden class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Thanks </h2>
<p>Finally, I would like to extend my gratitude to the following people and groups:</p>
<ul>
<li>All the translation maintainers and contributors who are helping translate React to more than thirty languages.</li>
<li>The <a href="https://github.com/vuejs-jp" target="_blank" rel="nofollow noopener noreferrer">Vue.js Japan User Group</a> for initiating the idea of having bot-managed translations, and especially <a href="https://github.com/potato4d" target="_blank" rel="nofollow noopener noreferrer">Hanatani Takuma</a> for helping us understand their approach and helping maintain the Japanese translation.</li>
<li><a href="https://github.com/smikitky" target="_blank" rel="nofollow noopener noreferrer">Soichiro Miki</a> for many <a href="https://github.com/reactjs/reactjs.org/pull/1636" target="_blank" rel="nofollow noopener noreferrer">contributions</a> and thoughtful comments on the overall translation process, as well as for maintaining the Japanese translation.</li>
<li><a href="https://github.com/ericnakagawa" target="_blank" rel="nofollow noopener noreferrer">Eric Nakagawa</a> for managing our previous translation process.</li>
<li><a href="https://github.com/bvaughn" target="_blank" rel="nofollow noopener noreferrer">Brian Vaughn</a> for setting up the <a href="/languages">languages page</a> and managing all the subdomains.</li>
</ul>
<p> And finally, thank you to <a href="https://twitter.com/dan_abramov" target="_blank" rel="nofollow noopener noreferrer">Dan Abramov</a> for giving me this opportunity and being a great mentor along the way.</p>]]></description><link>https://zh-hans.reactjs.org/blog/2019/02/23/is-react-translated-yet.html</link><guid isPermaLink="false">https://zh-hans.reactjs.org/blog/2019/02/23/is-react-translated-yet.html</guid><pubDate>Sat, 23 Feb 2019 00:00:00 GMT</pubDate></item></channel></rss>